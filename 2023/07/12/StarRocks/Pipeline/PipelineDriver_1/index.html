<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="本篇来看看 PipelineDriver 的执行流程，以及如何与 PipelineDriverPoller 交互。 Pipeline DriverState一个 PipelineDriver 的状态有如下 10 种： 123456789101112enum DriverState : uint32_t &amp;#123;    NOT_READY &#x3D; 0,    READY &#x3D; 1,    RUNNIN">
<meta property="og:type" content="article">
<meta property="og:title" content="Pipeline: PipelineDriver 状态机(1)">
<meta property="og:url" content="https://szza.github.io/2023/07/12/StarRocks/Pipeline/PipelineDriver_1/index.html">
<meta property="og:site_name" content="szza">
<meta property="og:description" content="本篇来看看 PipelineDriver 的执行流程，以及如何与 PipelineDriverPoller 交互。 Pipeline DriverState一个 PipelineDriver 的状态有如下 10 种： 123456789101112enum DriverState : uint32_t &amp;#123;    NOT_READY &#x3D; 0,    READY &#x3D; 1,    RUNNIN">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://github.com/szza/szza.github.io.images/blob/master/StarRocks/PipelineDriver-1.svg?raw=true">
<meta property="og:image" content="https://github.com/szza/szza.github.io.images/blob/master/StarRocks/pipeline-1.svg?raw=true">
<meta property="og:image" content="https://github.com/szza/szza.github.io.images/blob/master/StarRocks/Pipeline-OlapScanOperator-1.svg?raw=true">
<meta property="article:published_time" content="2023-07-12T02:00:01.000Z">
<meta property="article:modified_time" content="2023-09-26T02:32:34.000Z">
<meta property="article:author" content="fibonaccii">
<meta property="article:tag" content="StarRocks">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://github.com/szza/szza.github.io.images/blob/master/StarRocks/PipelineDriver-1.svg?raw=true">
    
    
      
        
          <link rel="shortcut icon" href="/images/id.jpg">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/id.jpg" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/id.jpg">
        
      
    
    <!-- title -->
    <title>Pipeline: PipelineDriver 状态机(1)</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="szza" type="application/atom+xml">
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives">archives</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2023/07/15/StarRocks/Pipeline/PipelineDriver_2/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2023/07/10/StarRocks/Pipeline/ChunkBuffer/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://szza.github.io/2023/07/12/StarRocks/Pipeline/PipelineDriver_1/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://szza.github.io/2023/07/12/StarRocks/Pipeline/PipelineDriver_1/&text=Pipeline: PipelineDriver 状态机(1)"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://szza.github.io/2023/07/12/StarRocks/Pipeline/PipelineDriver_1/&title=Pipeline: PipelineDriver 状态机(1)"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://szza.github.io/2023/07/12/StarRocks/Pipeline/PipelineDriver_1/&is_video=false&description=Pipeline: PipelineDriver 状态机(1)"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Pipeline: PipelineDriver 状态机(1)&body=Check out this article: https://szza.github.io/2023/07/12/StarRocks/Pipeline/PipelineDriver_1/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://szza.github.io/2023/07/12/StarRocks/Pipeline/PipelineDriver_1/&title=Pipeline: PipelineDriver 状态机(1)"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://szza.github.io/2023/07/12/StarRocks/Pipeline/PipelineDriver_1/&title=Pipeline: PipelineDriver 状态机(1)"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://szza.github.io/2023/07/12/StarRocks/Pipeline/PipelineDriver_1/&title=Pipeline: PipelineDriver 状态机(1)"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://szza.github.io/2023/07/12/StarRocks/Pipeline/PipelineDriver_1/&title=Pipeline: PipelineDriver 状态机(1)"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://szza.github.io/2023/07/12/StarRocks/Pipeline/PipelineDriver_1/&name=Pipeline: PipelineDriver 状态机(1)&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://szza.github.io/2023/07/12/StarRocks/Pipeline/PipelineDriver_1/&t=Pipeline: PipelineDriver 状态机(1)"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Pipeline-DriverState"><span class="toc-number">1.</span> <span class="toc-text">Pipeline DriverState</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#GlobalDriverExecutor-submit"><span class="toc-number">1.1.</span> <span class="toc-text">GlobalDriverExecutor::submit</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PipelineDriverPoller"><span class="toc-number">2.</span> <span class="toc-text">PipelineDriverPoller</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#add-blocked-driver"><span class="toc-number">2.1.</span> <span class="toc-text">add_blocked_driver</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#run-internal"><span class="toc-number">2.2.</span> <span class="toc-text">run_internal</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Part1"><span class="toc-number">2.2.1.</span> <span class="toc-text">Part1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Part2"><span class="toc-number">2.2.2.</span> <span class="toc-text">Part2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Part3"><span class="toc-number">2.2.3.</span> <span class="toc-text">Part3</span></a></li></ol></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Pipeline: PipelineDriver 状态机(1)
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">fibonaccii</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-07-12T02:00:01.000Z" itemprop="datePublished">2023-07-12</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/Pipeline/">Pipeline</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/StarRocks/" rel="tag">StarRocks</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>本篇来看看 PipelineDriver 的执行流程，以及如何与 PipelineDriverPoller 交互。</p>
<h2 id="Pipeline-DriverState"><a href="#Pipeline-DriverState" class="headerlink" title="Pipeline DriverState"></a>Pipeline DriverState</h2><p>一个 PipelineDriver 的状态有如下 10 种：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">DriverState</span> : <span class="type">uint32_t</span> &#123;</span><br><span class="line">    NOT_READY = <span class="number">0</span>,</span><br><span class="line">    READY = <span class="number">1</span>,</span><br><span class="line">    RUNNING = <span class="number">2</span>,</span><br><span class="line">    INPUT_EMPTY = <span class="number">3</span>,</span><br><span class="line">    OUTPUT_FULL = <span class="number">4</span>,</span><br><span class="line">    PRECONDITION_BLOCK = <span class="number">5</span>,</span><br><span class="line">    FINISH = <span class="number">6</span>,</span><br><span class="line">    CANCELED = <span class="number">7</span>,</span><br><span class="line">    INTERNAL_ERROR = <span class="number">8</span>,</span><br><span class="line">    PENDING_FINISH = <span class="number">9</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>他们之间的状态变化如下:<br><img src="https://github.com/szza/szza.github.io.images/blob/master/StarRocks/PipelineDriver-1.svg?raw=true" alt="PipelineaDriver-1"></p>
<p>在此处不单独讲解每个状态，后面融到代码流程一起讲解。</p>
<h3 id="GlobalDriverExecutor-submit"><a href="#GlobalDriverExecutor-submit" class="headerlink" title="GlobalDriverExecutor::submit"></a>GlobalDriverExecutor::submit</h3><p>先回顾下 GlobalDrvierExecutor 整体设计:</p>
<p><img src="https://github.com/szza/szza.github.io.images/blob/master/StarRocks/pipeline-1.svg?raw=true" alt="pipeline-1"></p>
<p>PipelineDriver 创建完，并通过 submit 接口传递给 Driver<strong>Executor</strong>。Executor 会先根据该 drvier 当前状态来判断是进入 <strong>_driver_queue</strong> 还是 <strong>_blocked_driver_poller</strong> 中。</p>
<p>比如，在 <a href="https://szza.github.io/2023/07/05/Pipeline/MorselQueue_2/">Morsel 和 OlapScanOperator(2)</a> 中提到的 OlapScanPrepareOperator 和 OlapScanOperator：需要等待 PrepareOperator::pull_chunk 执行完（因为需要先获取待访问的 tablets 和 rowsets），ScanOperator 才能执行。然而 Prepare 和 Scan 分属于两个 PipelineDriver。他们的依赖关系如下：</p>
<p><img src="https://github.com/szza/szza.github.io.images/blob/master/StarRocks/Pipeline-OlapScanOperator-1.svg?raw=true" alt="Pipeline-OlapScanOperator-1"><br>因此，而 pipeline0 在被提交给 Executor 后会进入 _driver_queue，pipeline1 提交后则进入 _blocked_driver_poller。这里的初始判断条件：</p>
<ul>
<li>HashJoin：Join 需要先等待 Build 阶段完成，才能进入 Probe 阶段。Build 阶段即 Probe 阶段的 Precondition，Probe 则会进入 submit 函数第一个分支，并添加到 <em>_blocked_driver_poller</em> 中</li>
<li>其他，都是使用 <em>SourceOperator::is_finished</em> 函数和 <em>SourceOperator::has_output</em> 函数来判断进入哪个 driver_queue</li>
</ul>
<p>代码如下。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">GlobalDriverExecutor::submit</span><span class="params">(DriverRawPtr driver)</span> </span>&#123;</span><br><span class="line">    driver-&gt;<span class="built_in">start_schedule</span>(_schedule_count, _driver_execution_ns);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (driver-&gt;<span class="built_in">is_precondition_block</span>()) &#123;</span><br><span class="line">        driver-&gt;<span class="built_in">set_driver_state</span>(DriverState::PRECONDITION_BLOCK);</span><br><span class="line">        driver-&gt;<span class="built_in">mark_precondition_not_ready</span>();</span><br><span class="line">        <span class="keyword">this</span>-&gt;_blocked_driver_poller-&gt;<span class="built_in">add_blocked_driver</span>(driver);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        driver-&gt;<span class="built_in">submit_operators</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Try to add the driver to poller first.</span></span><br><span class="line">        <span class="keyword">if</span> (!driver-&gt;<span class="built_in">source_operator</span>()-&gt;<span class="built_in">is_finished</span>() </span><br><span class="line">            &amp;&amp; !driver-&gt;<span class="built_in">source_operator</span>()-&gt;<span class="built_in">has_output</span>()) &#123;</span><br><span class="line">            driver-&gt;<span class="built_in">set_driver_state</span>(DriverState::INPUT_EMPTY);</span><br><span class="line">            <span class="keyword">this</span>-&gt;_blocked_driver_poller-&gt;<span class="built_in">add_blocked_driver</span>(driver);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>-&gt;_driver_queue-&gt;<span class="built_in">put_back</span>(driver);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="PipelineDriverPoller"><a href="#PipelineDriverPoller" class="headerlink" title="PipelineDriverPoller"></a>PipelineDriverPoller</h2><p>PipelineDriverPoller 的主要字段解释如下:</p>
<ul>
<li><p><em>_driver_queue</em>: PipelineDriverPoller 和 GlobalDriverExecutor 共享 <em>_driver_queue</em>，存放着 READY 状态可执行的 PipelineDriver。</p>
</li>
<li><p><em>_blocked_drivers</em>: 存储当前 Backends 中所有暂时无法执行的 blocked PipelineDrivers，</p>
<p> _global_mutex 是用于保护 _blocked_drivers，在 poll_thread 和 PipelineDriverPoller::add_blocked_driver 函数之间形成互斥。</p>
<p> _cond 则是配合 _gloabl_mutex，上层调用 add_blocked_driver 函数添加 blocked driver 时，唤醒正在阻塞等待的 poller_thread。</p>
</li>
<li><p><em>_local_blocked_drivers</em>: 表征的是当前 poller_thread 中正在处理 blocked PipelineDrivers。</p>
<p>  但是我觉得没必要引入一个 _local_mutex，SpinLock 就能满足要求。详见 poller_thread 分析。</p>
</li>
</ul>
<p>类 PipelineDriverPoller 主要字段及其构造函数如下。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PipelineDriverPoller</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">PipelineDriverPoller</span><span class="params">(DriverQueue* driver_queue)</span></span></span><br><span class="line"><span class="function">        : _driver_queue(driver_queue),</span></span><br><span class="line"><span class="function">          _polling_thread(nullptr),</span></span><br><span class="line"><span class="function">          _is_polling_thread_initialized(false),</span></span><br><span class="line"><span class="function">          _is_shutdown(false) &#123;</span> &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">using</span> DriverList = std::list&lt;DriverRawPtr&gt;;</span><br><span class="line">    <span class="comment">//... other methods</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">mutable</span> std::mutex _global_mutex;</span><br><span class="line">    std::condition_variable _cond;</span><br><span class="line">    DriverList _blocked_drivers;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">mutable</span> std::shared_mutex _local_mutex;</span><br><span class="line">    DriverList _local_blocked_drivers;</span><br><span class="line"></span><br><span class="line">    DriverQueue* _driver_queue;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PipelineDriverPoller 在 Executor 构造</span></span><br><span class="line">GlobalDriverExecutor::<span class="built_in">GlobalDriverExecutor</span>(std::string name, </span><br><span class="line">                                           std::unique_ptr&lt;ThreadPool&gt; pool,</span><br><span class="line">                                           <span class="type">bool</span> enable_resource_group)</span><br><span class="line">        : <span class="built_in">Base</span>(std::<span class="built_in">move</span>(name)),</span><br><span class="line">          <span class="comment">// driver_queue 在 Executor 中构造</span></span><br><span class="line">          _driver_queue(enable_resource_group </span><br><span class="line">            ? std::<span class="built_in">unique_ptr</span>&lt;DriverQueue&gt;(<span class="keyword">new</span> <span class="built_in">WorkGroupDriverQueue</span>())</span><br><span class="line">            : std::<span class="built_in">make_unique</span>&lt;QuerySharedDriverQueue&gt;()),</span><br><span class="line">          _thread_pool(std::<span class="built_in">move</span>(pool)),</span><br><span class="line">          <span class="comment">// 传递 _driver_queue 指针给 poller</span></span><br><span class="line">          _blocked_driver_poller(<span class="keyword">new</span> <span class="built_in">PipelineDriverPoller</span>(_driver_queue.<span class="built_in">get</span>())),</span><br><span class="line">          _exec_state_reporter(<span class="keyword">new</span> <span class="built_in">ExecStateReporter</span>()) &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="add-blocked-driver"><a href="#add-blocked-driver" class="headerlink" title="add_blocked_driver"></a>add_blocked_driver</h3><p>add_blocked_driver 函数是 Executor 向 Poller 添加 blocked drivers 的函数接口，这里需要使用 _global_mutex 来与 poller_thread 形成互斥。</p>
<p>_pending_timer_sw 用于统计每次 driver 处于阻塞状态的时间，即加入 poller 时重置，从 poller 中删除后计算本次 blocked 耗时。多次阻塞总耗时更新到 PipelineDriver::_pending_timer 中，查询结束可以在 query profile 中搜索 ‘PendingTime’ 字段查看。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">PipelineDriverPoller::add_blocked_driver</span><span class="params">(<span class="type">const</span> DriverRawPtr driver)</span> </span>&#123;</span><br><span class="line">    <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(_global_mutex)</span></span>;</span><br><span class="line">    _blocked_drivers.<span class="built_in">push_back</span>(driver);</span><br><span class="line">    driver-&gt;_pending_timer_sw-&gt;<span class="built_in">reset</span>();</span><br><span class="line">    _cond.<span class="built_in">notify_one</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="run-internal"><a href="#run-internal" class="headerlink" title="run_internal"></a>run_internal</h3><p>下面是 Poller 的重点：poller_thread。可以将 poller_thread 分为三个部分：</p>
<h4 id="Part1"><a href="#Part1" class="headerlink" title="Part1"></a>Part1</h4><p>等待 Executor 将 blocked drivers 加入到 Poller 中。</p>
<p>在一个正常部署的 StarRocks 集群中，任意一个时刻都应该有查询存在，且生成的 PipelineDriver 会很多。因此，add_blocked_driver 函数与 poller_thread 之间的 race condition 应该比较激烈。poller_thread  在局部作用域里使用 std::mutex + std::condition_variable ，来缩小 _gloab_mutex 的范围。</p>
<p>如果有新 blocked drivers 加入，则将其从 _blocked_drivers 中移到 tmp_blocked_drivers，局部作用域结束就释放了 _gloabl_mutex。poller_thread 后续就直接对 poller_thread 进行操作，也就不会阻塞 add_blocked_driver 函数。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">PipelineDriverPoller::run_internal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    _is_polling_thread_initialized.<span class="built_in">store</span>(<span class="literal">true</span>, std::memory_order_release);</span><br><span class="line"></span><br><span class="line">    DriverList tmp_blocked_drivers;</span><br><span class="line">    <span class="keyword">while</span> (!_is_shutdown.<span class="built_in">load</span>(std::memory_order_acquire)) &#123;</span><br><span class="line">      <span class="comment">// part1 start...</span></span><br><span class="line">      <span class="comment">// 1. 局部作用域</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(_global_mutex)</span></span>;</span><br><span class="line">        <span class="comment">// 将 _blocked_drivers 中的元素移到 tmp_blocked_drivers</span></span><br><span class="line">        tmp_blocked_drivers.<span class="built_in">splice</span>(</span><br><span class="line">            tmp_blocked_drivers.<span class="built_in">end</span>(), _blocked_drivers);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (_local_blocked_drivers.<span class="built_in">empty</span>() &amp;&amp; tmp_blocked_drivers.<span class="built_in">empty</span>() </span><br><span class="line">            &amp;&amp; _blocked_drivers.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">            <span class="comment">// 超时等待</span></span><br><span class="line">            std::cv_status cv_status = std::cv_status::no_timeout;</span><br><span class="line">            <span class="keyword">while</span> (!_is_shutdown.<span class="built_in">load</span>(std::memory_order_acquire) </span><br><span class="line">                   &amp;&amp; _blocked_drivers.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">                   cv_status = _cond.<span class="built_in">wait_for</span>(lock, <span class="number">10</span>ms);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (cv_status == std::cv_status::timeout) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (_is_shutdown.<span class="built_in">load</span>(std::memory_order_acquire)) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 获得本轮的 blocked drivers</span></span><br><span class="line">            tmp_blocked_drivers.<span class="built_in">splice</span>(</span><br><span class="line">                tmp_blocked_drivers.<span class="built_in">end</span>(), _blocked_drivers);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Part2"><a href="#Part2" class="headerlink" title="Part2"></a>Part2</h4><p>得到本轮 tmp_blocked_drivers 后，将其加入到 _local_blocked_drivers 中。后续对 _local_blocked_drivers 中的 drivers 当前状态进行判断。因为有个 iterate_immutable_driver 函数需要读取 _local_blocked_drivers，故而也用 _local_mutex 对其进行互斥保护。</p>
<blockquote>
<p>但是，iterate_immutable_driver 是来源于 HTTP 请求，通常情况下请求几乎不会被执行，可能开发人员会在调试时使用下，因次这里几乎没有必要使用 std::mutex，更好的选择显然是使用 SpinLock。</p>
</blockquote>
<p>需要对 _local_blocked_drivers 中的每个 driver 进行遍历，检测是否 READY 或者处于终止状态</p>
<ul>
<li><p><strong>case1: QueryContext::is_query_expired</strong></p>
<p>  每个 query 都有个 query_timeout（默认值 300s），超过这个时间就会 cancel 该 query。这时会主动调用 FragmentContext::cancel 函数，标记这个 query。由于 FragmentInstance 的所有 PipelineDrievrs 共享一个 FragmentContext 对象，因此其他 PipelineDriver 就会可以通过检测 FragmentContext::is_canceled 来查看当前 query 是否仍处于取消状态</p>
<blockquote>
<p>实际上这个状态会上报，再下发取消其他节点的 FragementInstances?</p>
</blockquote>
</li>
<li><p><strong>case2: FragmentContext::is_canceled</strong></p>
<p>  触发 FragmentContext::cancel 操作的场景很多，除了上述的查询超时，还有在查询过程中 Operators::pull_chunk、Operators::push_chunk 执行遇到某些问题，此时在 GloablDriverExecutor 会调用 QueryContex::cancel 将该 query 的所有 FragementInstance 都进行 cancel。如此，该 query 下所有的 FragmentInstances 的所有 PipelineDriver 都不会再被执行。</p>
</li>
<li><p><strong>case3: DriverState::PENDING_FINISH</strong></p>
<p>  从代码中，不难发现只有当 PipelineDriver::pending_finish 为 false 时，这个 blocked_driver 才会调用 remove_blocked_driver 函数将其从 _local_blocked_drivers 中删除。</p>
  <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">PipelineDriverPoller::remove_blocked_driver</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    DriverList&amp; local_blocked_drivers, DriverList::iterator&amp; driver_it)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span>&amp; driver = *driver_it;</span><br><span class="line">    driver-&gt;_pending_timer-&gt;<span class="built_in">update</span>(</span><br><span class="line">        driver-&gt;_pending_timer_sw-&gt;<span class="built_in">elapsed_time</span>());</span><br><span class="line">    local_blocked_drivers.<span class="built_in">erase</span>(driver_it++);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 转为 DriverState::PENDING_FINISH 状态的前提是 is_still_pending_finish 函数返回 true:</p>
   <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="type">bool</span> <span class="title">PipelineDriver::is_still_pending_finish</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">source_operator</span>()-&gt;<span class="built_in">pending_finish</span>() </span><br><span class="line">           || <span class="built_in">sink_operator</span>()-&gt;<span class="built_in">pending_finish</span>(); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  实际上 SourceOperator 中，只有 ScanOperator 实现了这个函数，且返回值为 false</p>
  <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">ScanOperator::pending_finish</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  也就是说， is_still_pending_finish 函数的返回值取决于 SinkOperator::pending_finish 了。</p>
<blockquote>
<p>这也是这个阶段存在的原因</p>
</blockquote>
<p>  实际上就是为了等待 SinkOperator 中的数据处理完，比如 ExchangeSinkOperator 中的 buffer 消耗完才能进入 DriverState::FINISH 阶段。因此 is_still_pending_finish 返回 true 时，blocked drvier 并没有加入 ready drivers 中，而是被忽略了，等待下一次 poll。</p>
</li>
<li><p><strong>case4: PipelineDriver::is_finished</strong><br>  query 终态有三种:</p>
  <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">is_finished</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> _state == DriverState::FINISH </span><br><span class="line">           || _state == DriverState::CANCELED</span><br><span class="line">           || _state == DriverState::INTERNAL_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  已经处于终态的可以直接从 _local_blocked_drivers 中删除，并加入 ready_drivers 中。 </p>
</li>
<li><p><strong>case5: PipelineDriver::is_not_blocked</strong><br>  这个分支才是用于检测 PipelineDriver 是否解除阻塞，可以继续执行了。比如 OlapScanPrepareOperator::pull_chunk 执行完毕，OlapScanOperator 的 PipelineDrvier::is_not_block 函数才会返回 true，从 _local_blocked_drivers 中转入 ready_drivers。</p>
</li>
<li><p><strong>case6</strong></p>
<p>PipelineDriver 仍无法 Ready</p>
</li>
</ul>
<p>Part2 代码如下.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">PipelineDriverPoller::run_internal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::vector&lt;DriverRawPtr&gt; ready_drivers;</span><br><span class="line">    <span class="keyword">while</span> (!_is_shutdown.<span class="built_in">load</span>(std::memory_order_acquire)) &#123;</span><br><span class="line">      <span class="comment">// above part1 code ...</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// part2 start ...</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="function">std::unique_lock <span class="title">write_lock</span><span class="params">(_local_mutex)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!tmp_blocked_drivers.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">            _local_blocked_drivers.<span class="built_in">splice</span>(</span><br><span class="line">                _local_blocked_drivers.<span class="built_in">end</span>(), tmp_blocked_drivers);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">auto</span> driver_it = _local_blocked_drivers.<span class="built_in">begin</span>();</span><br><span class="line">        <span class="keyword">while</span> (driver_it != _local_blocked_drivers.<span class="built_in">end</span>()) &#123;</span><br><span class="line">            <span class="keyword">auto</span>* driver = *driver_it;</span><br><span class="line">            <span class="keyword">auto</span>* fragment_ctx = driver-&gt;<span class="built_in">fragment_ctx</span>();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (driver-&gt;<span class="built_in">query_ctx</span>()-&gt;<span class="built_in">is_query_expired</span>()) &#123;</span><br><span class="line">               <span class="comment">// case1: 查询超时</span></span><br><span class="line">                fragment_ctx-&gt;<span class="built_in">cancel</span>(Status::<span class="built_in">TimedOut</span>(fmt::format(</span><br><span class="line">                    <span class="string">&quot;Query exceeded time limit of &#123;&#125; seconds&quot;</span>,</span><br><span class="line">                    driver-&gt;<span class="built_in">query_ctx</span>()-&gt;<span class="built_in">get_query_expire_seconds</span>())));</span><br><span class="line"></span><br><span class="line">                driver-&gt;<span class="built_in">cancel_operators</span>(fragment_ctx-&gt;<span class="built_in">runtime_state</span>());</span><br><span class="line">                <span class="keyword">if</span> (driver-&gt;<span class="built_in">is_still_pending_finish</span>()) &#123;</span><br><span class="line">                    driver-&gt;<span class="built_in">set_driver_state</span>(DriverState::PENDING_FINISH);</span><br><span class="line">                    ++driver_it;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    driver-&gt;<span class="built_in">set_driver_state</span>(DriverState::FINISH);</span><br><span class="line">                    <span class="built_in">remove_blocked_driver</span>(_local_blocked_drivers, driver_it);</span><br><span class="line">                    ready_drivers.<span class="built_in">emplace_back</span>(driver);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (fragment_ctx-&gt;<span class="built_in">is_canceled</span>()) &#123;</span><br><span class="line">                <span class="comment">//case2: query 已经被 cancel</span></span><br><span class="line">                driver-&gt;<span class="built_in">cancel_operators</span>(fragment_ctx-&gt;<span class="built_in">runtime_state</span>());</span><br><span class="line">                <span class="keyword">if</span> (driver-&gt;<span class="built_in">is_still_pending_finish</span>()) &#123;</span><br><span class="line">                    driver-&gt;<span class="built_in">set_driver_state</span>(DriverState::PENDING_FINISH);</span><br><span class="line">                    ++driver_it;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    driver-&gt;<span class="built_in">set_driver_state</span>(DriverState::CANCELED);</span><br><span class="line">                    <span class="built_in">remove_blocked_driver</span>(_local_blocked_drivers, driver_it);</span><br><span class="line">                    ready_drivers.<span class="built_in">emplace_back</span>(driver);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (driver-&gt;<span class="built_in">pending_finish</span>()) &#123;</span><br><span class="line">                <span class="comment">// case3: 处于即将完成的状态</span></span><br><span class="line">                <span class="keyword">if</span> (driver-&gt;<span class="built_in">is_still_pending_finish</span>()) &#123;</span><br><span class="line">                    ++driver_it;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    driver-&gt;<span class="built_in">set_driver_state</span>(</span><br><span class="line">                        fragment_ctx-&gt;<span class="built_in">is_canceled</span>()</span><br><span class="line">                        ? DriverState::CANCELED</span><br><span class="line">                        : DriverState::FINISH);</span><br><span class="line">                    <span class="built_in">remove_blocked_driver</span>(_local_blocked_drivers, driver_it);</span><br><span class="line">                    ready_drivers.<span class="built_in">emplace_back</span>(driver);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (driver-&gt;<span class="built_in">is_finished</span>()) &#123;</span><br><span class="line">                <span class="comment">// case4: 已经完成</span></span><br><span class="line">                <span class="built_in">remove_blocked_driver</span>(_local_blocked_drivers, driver_it);</span><br><span class="line">                ready_drivers.<span class="built_in">emplace_back</span>(driver);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (driver-&gt;<span class="built_in">is_not_blocked</span>()) &#123;</span><br><span class="line">                <span class="comment">// case5: 解除阻塞</span></span><br><span class="line">                driver-&gt;<span class="built_in">set_driver_state</span>(DriverState::READY);</span><br><span class="line">                <span class="built_in">remove_blocked_driver</span>(_local_blocked_drivers, driver_it);</span><br><span class="line">                ready_drivers.<span class="built_in">emplace_back</span>(driver);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// case6: NOT_READY</span></span><br><span class="line">                ++driver_it;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125; <span class="comment">// while-loop</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Part3"><a href="#Part3" class="headerlink" title="Part3"></a>Part3</h4><p>第三部分比较简单，就是将 ready 加入 DriverQueue，让 Executor 就会从该 driver_queue 取出可执行的 PipelineDrivers。这部分使用了 spin-loop 的优化，这个优化详情分析可见 RocksDB 系列的 <a href="https://szza.github.io/2022/02/02/rocksdb/WritePath/write_thread_3/">WriteThread 如何自适应优化线程同步</a>。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">PipelineDriverPoller::run_internal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">int</span> spin_count = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> (!_is_shutdown.<span class="built_in">load</span>(std::memory_order_acquire)) &#123;</span><br><span class="line">        <span class="comment">//...above code</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// part3 start...</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ready_drivers.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">            spin_count += <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            spin_count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            _driver_queue-&gt;<span class="built_in">put_back</span>(ready_drivers);</span><br><span class="line">            ready_drivers.<span class="built_in">clear</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (spin_count != <span class="number">0</span> &amp;&amp; spin_count % <span class="number">64</span> == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __x86_64__</span></span><br><span class="line">            _mm_pause();</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> Maybe there&#x27;s a better intrinsic like _mm_pause on non-x86_64 architecture.</span></span><br><span class="line">            <span class="built_in">sched_yield</span>();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (spin_count == <span class="number">640</span>) &#123;</span><br><span class="line">            spin_count = <span class="number">0</span>;</span><br><span class="line">            <span class="built_in">sched_yield</span>();</span><br><span class="line">        &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>PipelineDriverPoller::run_internal 完整的代码可见 <a target="_blank" rel="noopener" href="https://github.com/StarRocks/starrocks/blob/52fc2ed8e2e4cba6594bb534b4291c5053ddb97d/be/src/exec/pipeline/pipeline_driver_poller.cpp#L40C3-L40C3">PipelineDriverPoller::run_internal</a>。</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives">archives</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Pipeline-DriverState"><span class="toc-number">1.</span> <span class="toc-text">Pipeline DriverState</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#GlobalDriverExecutor-submit"><span class="toc-number">1.1.</span> <span class="toc-text">GlobalDriverExecutor::submit</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PipelineDriverPoller"><span class="toc-number">2.</span> <span class="toc-text">PipelineDriverPoller</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#add-blocked-driver"><span class="toc-number">2.1.</span> <span class="toc-text">add_blocked_driver</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#run-internal"><span class="toc-number">2.2.</span> <span class="toc-text">run_internal</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Part1"><span class="toc-number">2.2.1.</span> <span class="toc-text">Part1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Part2"><span class="toc-number">2.2.2.</span> <span class="toc-text">Part2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Part3"><span class="toc-number">2.2.3.</span> <span class="toc-text">Part3</span></a></li></ol></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://szza.github.io/2023/07/12/StarRocks/Pipeline/PipelineDriver_1/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://szza.github.io/2023/07/12/StarRocks/Pipeline/PipelineDriver_1/&text=Pipeline: PipelineDriver 状态机(1)"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://szza.github.io/2023/07/12/StarRocks/Pipeline/PipelineDriver_1/&title=Pipeline: PipelineDriver 状态机(1)"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://szza.github.io/2023/07/12/StarRocks/Pipeline/PipelineDriver_1/&is_video=false&description=Pipeline: PipelineDriver 状态机(1)"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Pipeline: PipelineDriver 状态机(1)&body=Check out this article: https://szza.github.io/2023/07/12/StarRocks/Pipeline/PipelineDriver_1/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://szza.github.io/2023/07/12/StarRocks/Pipeline/PipelineDriver_1/&title=Pipeline: PipelineDriver 状态机(1)"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://szza.github.io/2023/07/12/StarRocks/Pipeline/PipelineDriver_1/&title=Pipeline: PipelineDriver 状态机(1)"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://szza.github.io/2023/07/12/StarRocks/Pipeline/PipelineDriver_1/&title=Pipeline: PipelineDriver 状态机(1)"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://szza.github.io/2023/07/12/StarRocks/Pipeline/PipelineDriver_1/&title=Pipeline: PipelineDriver 状态机(1)"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://szza.github.io/2023/07/12/StarRocks/Pipeline/PipelineDriver_1/&name=Pipeline: PipelineDriver 状态机(1)&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://szza.github.io/2023/07/12/StarRocks/Pipeline/PipelineDriver_1/&t=Pipeline: PipelineDriver 状态机(1)"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2021-2026
    fibonaccii
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives">archives</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

    <script async src="https://www.googletagmanager.com/gtag/js?id=szza"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'szza');
    </script>

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->


</body>
</html>
