<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="Rocksdb,为了加速查询，基于bloom filter 设计了Filter。 FilterBlockBuilderFilterBlockBuilder 是个基类，用于为特定的table构建filter，调用::Finish函数后会以字符串形式返回生成filter。它也有三个子类：  BlockBasedFilterBlockBuilder FullFilterBlockBuilder Part">
<meta property="og:type" content="article">
<meta property="og:title" content="FilterBlock 源码分析">
<meta property="og:url" content="https://szza.github.io/2021/11/27/rocksdb/Table/builder/3_FilterBlock/index.html">
<meta property="og:site_name" content="szza">
<meta property="og:description" content="Rocksdb,为了加速查询，基于bloom filter 设计了Filter。 FilterBlockBuilderFilterBlockBuilder 是个基类，用于为特定的table构建filter，调用::Finish函数后会以字符串形式返回生成filter。它也有三个子类：  BlockBasedFilterBlockBuilder FullFilterBlockBuilder Part">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2021-11-27T06:15:35.000Z">
<meta property="article:modified_time" content="2023-08-26T17:48:00.000Z">
<meta property="article:author" content="fibonaccii">
<meta property="article:tag" content="RocksDb">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/id.jpg">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/id.jpg" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/id.jpg">
        
      
    
    <!-- title -->
    <title>FilterBlock 源码分析</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="szza" type="application/atom+xml">
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives">archives</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2021/11/28/rocksdb/Table/builder/4_BlockBaseTableBuilder/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2021/11/26/rocksdb/Table/builder/2_IndexBlock/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://szza.github.io/2021/11/27/rocksdb/Table/builder/3_FilterBlock/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://szza.github.io/2021/11/27/rocksdb/Table/builder/3_FilterBlock/&text=FilterBlock 源码分析"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://szza.github.io/2021/11/27/rocksdb/Table/builder/3_FilterBlock/&title=FilterBlock 源码分析"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://szza.github.io/2021/11/27/rocksdb/Table/builder/3_FilterBlock/&is_video=false&description=FilterBlock 源码分析"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=FilterBlock 源码分析&body=Check out this article: https://szza.github.io/2021/11/27/rocksdb/Table/builder/3_FilterBlock/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://szza.github.io/2021/11/27/rocksdb/Table/builder/3_FilterBlock/&title=FilterBlock 源码分析"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://szza.github.io/2021/11/27/rocksdb/Table/builder/3_FilterBlock/&title=FilterBlock 源码分析"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://szza.github.io/2021/11/27/rocksdb/Table/builder/3_FilterBlock/&title=FilterBlock 源码分析"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://szza.github.io/2021/11/27/rocksdb/Table/builder/3_FilterBlock/&title=FilterBlock 源码分析"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://szza.github.io/2021/11/27/rocksdb/Table/builder/3_FilterBlock/&name=FilterBlock 源码分析&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://szza.github.io/2021/11/27/rocksdb/Table/builder/3_FilterBlock/&t=FilterBlock 源码分析"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#FilterBlockBuilder"><span class="toc-number">1.</span> <span class="toc-text">FilterBlockBuilder</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BlockBasedFilterBlockBuilder"><span class="toc-number">2.</span> <span class="toc-text">BlockBasedFilterBlockBuilder</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Add"><span class="toc-number">2.1.</span> <span class="toc-text">Add</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#AddKey"><span class="toc-number">2.1.1.</span> <span class="toc-text">AddKey</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AddPrefix"><span class="toc-number">2.1.2.</span> <span class="toc-text">AddPrefix</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#StartBlock"><span class="toc-number">2.2.</span> <span class="toc-text">StartBlock</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GenerateFilter"><span class="toc-number">2.3.</span> <span class="toc-text">GenerateFilter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Finish"><span class="toc-number">2.4.</span> <span class="toc-text">Finish</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FullFilterBlockBuilder"><span class="toc-number">3.</span> <span class="toc-text">FullFilterBlockBuilder</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Add-1"><span class="toc-number">3.1.</span> <span class="toc-text">Add</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#AddKey-1"><span class="toc-number">3.1.1.</span> <span class="toc-text">AddKey</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AddPrefix-1"><span class="toc-number">3.1.2.</span> <span class="toc-text">AddPrefix</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Finish-1"><span class="toc-number">3.1.3.</span> <span class="toc-text">Finish</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PartitionedFilterBlockBuilder"><span class="toc-number">4.</span> <span class="toc-text">PartitionedFilterBlockBuilder</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MaybeCutAFilterBlock"><span class="toc-number">4.1.</span> <span class="toc-text">MaybeCutAFilterBlock</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#AddKey-2"><span class="toc-number">4.1.1.</span> <span class="toc-text">AddKey</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Add-2"><span class="toc-number">4.2.</span> <span class="toc-text">Add</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Finish-2"><span class="toc-number">4.3.</span> <span class="toc-text">Finish</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        FilterBlock 源码分析
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">fibonaccii</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2021-11-27T06:15:35.000Z" itemprop="datePublished">2021-11-27</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/RocksDb/" rel="tag">RocksDb</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>Rocksdb,为了加速查询，基于bloom filter 设计了Filter。</p>
<h2 id="FilterBlockBuilder"><a href="#FilterBlockBuilder" class="headerlink" title="FilterBlockBuilder"></a>FilterBlockBuilder</h2><p><code>FilterBlockBuilder</code> 是个基类，用于为特定的<code>table</code>构建filter，调用<code>::Finish</code>函数后会以字符串形式返回生成filter。它也有三个子类：</p>
<ul>
<li><code>BlockBasedFilterBlockBuilder</code></li>
<li><code>FullFilterBlockBuilder</code></li>
<li><code>PartitionedFilterBlockBuilder</code></li>
</ul>
<p><code>FilterBlockBuilder</code> 的成员函数的调用顺序，要符合正则表达式： <code>(StartBlock Add*)* Finish</code>。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">FilterBlockBuilder</span> &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">FilterBlockBuilder</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">  <span class="keyword">virtual</span> ~<span class="built_in">FilterBlockBuilder</span>() &#123;&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">FilterBlockBuilder</span>(<span class="type">const</span> FilterBlockBuilder&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">  <span class="type">void</span> <span class="keyword">operator</span>=(<span class="type">const</span> FilterBlockBuilder&amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">IsBlockBased</span><span class="params">()</span> </span>= <span class="number">0</span>;                     <span class="comment">// If is blockbased filter</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">StartBlock</span><span class="params">(<span class="type">uint64_t</span> block_offset)</span> </span>= <span class="number">0</span>;  <span class="comment">// Start new block filter</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Add</span><span class="params">(<span class="type">const</span> Slice&amp; key_without_ts)</span> </span>= <span class="number">0</span>;   <span class="comment">// Add a key to current filter</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">IsEmpty</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;                    <span class="comment">// Empty == none added</span></span><br><span class="line">  <span class="comment">/// For reporting stats on how many entries the builder considered unique</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">size_t</span> <span class="title">EstimateEntriesAdded</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">  <span class="comment">/// Generate Filter</span></span><br><span class="line">  <span class="function">Slice <span class="title">Finish</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">const</span> BlockHandle empty_handle;</span><br><span class="line">    Status dont_care_status;</span><br><span class="line">    <span class="keyword">auto</span> ret = <span class="built_in">Finish</span>(empty_handle, &amp;dont_care_status);</span><br><span class="line">    <span class="built_in">assert</span>(dont_care_status.<span class="built_in">ok</span>());</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> Slice <span class="title">Finish</span><span class="params">(<span class="type">const</span> BlockHandle&amp; tmp, Status* status)</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="BlockBasedFilterBlockBuilder"><a href="#BlockBasedFilterBlockBuilder" class="headerlink" title="BlockBasedFilterBlockBuilder"></a>BlockBasedFilterBlockBuilder</h2><p><code>BlockBasedFilterBlockBuilder</code> 调用<code>::Finish</code>函数最后生成的字符串数据格式，如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">filter_1</span><br><span class="line">filter_2</span><br><span class="line">...</span><br><span class="line">filter_N</span><br><span class="line">...</span><br><span class="line">filter_1_offset</span><br><span class="line">filter_2_offset</span><br><span class="line">...</span><br><span class="line">filter_N_offset</span><br></pre></td></tr></table></figure>

<p>下面先大致看下结构。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BlockBasedFilterBlockBuilder</span> : <span class="keyword">public</span> FilterBlockBuilder &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">BlockBasedFilterBlockBuilder</span>(<span class="type">const</span> SliceTransform* prefix_extractor,</span><br><span class="line">                               <span class="type">const</span> BlockBasedTableOptions&amp; table_opt);</span><br><span class="line">  <span class="comment">// No copying allowed</span></span><br><span class="line">  <span class="built_in">BlockBasedFilterBlockBuilder</span>(<span class="type">const</span> BlockBasedFilterBlockBuilder&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">  <span class="type">void</span> <span class="keyword">operator</span>=(<span class="type">const</span> BlockBasedFilterBlockBuilder&amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">IsBlockBased</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> <span class="literal">true</span>; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">StartBlock</span><span class="params">(<span class="type">uint64_t</span> block_offset)</span> <span class="keyword">override</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Add</span><span class="params">(<span class="type">const</span> Slice&amp; key_without_ts)</span> <span class="keyword">override</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">IsEmpty</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> start_.<span class="built_in">empty</span>() &amp;&amp; filter_offsets_.<span class="built_in">empty</span>();</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">size_t</span> <span class="title">EstimateEntriesAdded</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123; </span><br><span class="line">    <span class="keyword">return</span> filter_bits_builder_-&gt;<span class="built_in">EstimateEntriesAdded</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> Slice <span class="title">Finish</span><span class="params">(<span class="type">const</span> BlockHandle&amp; tmp, Status* status)</span> <span class="keyword">override</span></span>;</span><br><span class="line">  <span class="keyword">using</span> FilterBlockBuilder::Finish;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">AddKey</span><span class="params">(<span class="type">const</span> Slice&amp; key)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">AddPrefix</span><span class="params">(<span class="type">const</span> Slice&amp; key)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">GenerateFilter</span><span class="params">()</span></span>;</span><br><span class="line">	</span><br><span class="line">  <span class="type">const</span> FilterPolicy* policy_;</span><br><span class="line">  <span class="type">const</span> SliceTransform* prefix_extractor_;</span><br><span class="line">  <span class="type">bool</span> whole_key_filtering_;</span><br><span class="line"></span><br><span class="line">  <span class="type">size_t</span> prev_prefix_start_;      <span class="comment">// 上次添加到 entries_ 中的 key_prefix 的起始地址</span></span><br><span class="line">  <span class="type">size_t</span> prev_prefix_size_;       <span class="comment">// 该 key_prefix 的大小</span></span><br><span class="line"></span><br><span class="line">  std::string entries_;        <span class="comment">// 将所有的key打平后存储在 entries 中</span></span><br><span class="line">  std::vector&lt;<span class="type">size_t</span>&gt; start_;  <span class="comment">// 每个entry的的索引存储在 start_</span></span><br><span class="line"></span><br><span class="line">  std::string result_;              <span class="comment">// Filter data computed so far</span></span><br><span class="line">  std::vector&lt;Slice&gt; tmp_entries_;  <span class="comment">// policy_-&gt;CreateFilter() argument</span></span><br><span class="line">  std::vector&lt;<span class="type">uint32_t</span>&gt; filter_offsets_;</span><br><span class="line">  <span class="type">uint64_t</span> total_added_in_built_;  <span class="comment">// Total keys added to filters built so far</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="Add"><a href="#Add" class="headerlink" title="Add"></a>Add</h3><p><code>BlockBasedFilterBlockBuilder</code> 在添加<code>key</code>时：</p>
<ul>
<li>如果能提取出待添加<code>key</code>的前缀，则会添加前缀</li>
<li>如果 <code>whole_key_filtering_  == true</code> ，则也会添加整个<code>key</code></li>
</ul>
<p>源码简单如斯。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">BlockBasedFilterBlockBuilder::Add</span><span class="params">(<span class="type">const</span> Slice&amp; key_without_ts)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 是能提取出 key_without_ts 的前缀，则添加前缀</span></span><br><span class="line">  <span class="keyword">if</span> (prefix_extractor_ &amp;&amp; prefix_extractor_-&gt;<span class="built_in">InDomain</span>(key_without_ts)) &#123;</span><br><span class="line">    <span class="built_in">AddPrefix</span>(key_without_ts);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 是否添加添加整个 key</span></span><br><span class="line">  <span class="keyword">if</span> (whole_key_filtering_) &#123;</span><br><span class="line">    <span class="built_in">AddKey</span>(key_without_ts);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="AddKey"><a href="#AddKey" class="headerlink" title="AddKey"></a>AddKey</h4><p>在 <code>BlockBasedFilterBlockBuilder</code> 中，<code>entries_</code> 用于存储每次添加的<code>key</code>，<code>start_</code> 存储这个<code>key</code>在<code>entries_</code>中偏移量。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">BlockBasedFilterBlockBuilder::AddKey</span><span class="params">(<span class="type">const</span> Slice&amp; key)</span> </span>&#123;</span><br><span class="line">  start_.<span class="built_in">push_back</span>(entries_.<span class="built_in">size</span>()); <span class="comment">// entries_.size() 即下一个 key 在 entries_ 中的起始偏移量</span></span><br><span class="line">  entries_.<span class="built_in">append</span>(key.<span class="built_in">data</span>(), key.<span class="built_in">size</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="AddPrefix"><a href="#AddPrefix" class="headerlink" title="AddPrefix"></a>AddPrefix</h4><p>非首次添加前缀时，都会先获得上一次添加key的前缀如果本次与上次不同，才添加本次key的前缀。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">BlockBasedFilterBlockBuilder::AddPrefix</span><span class="params">(<span class="type">const</span> Slice&amp; key)</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">  Slice prev;</span><br><span class="line">  <span class="keyword">if</span> (prev_prefix_size_ &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// 上一个添加的 key 的前缀</span></span><br><span class="line">    prev = <span class="built_in">Slice</span>(entries_.<span class="built_in">data</span>() + prev_prefix_start_, prev_prefix_size_);</span><br><span class="line">  &#125;</span><br><span class="line">	</span><br><span class="line">  <span class="comment">// 本次添加的key的前缀</span></span><br><span class="line">  Slice prefix = prefix_extractor_-&gt;<span class="built_in">Transform</span>(key);</span><br><span class="line">  <span class="comment">// 如果当前前缀 prefix 和之前的 prev 不同，则插入</span></span><br><span class="line">  <span class="keyword">if</span> (prev.<span class="built_in">size</span>() == <span class="number">0</span> || prefix != prev) &#123;</span><br><span class="line">    prev_prefix_start_ = entries_.<span class="built_in">size</span>();	<span class="comment">// 待插入的 key 在entries_中的起始地址</span></span><br><span class="line">    prev_prefix_size_ = prefix.<span class="built_in">size</span>();    <span class="comment">// 待插入的key的前缀</span></span><br><span class="line">    <span class="built_in">AddKey</span>(prefix);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="StartBlock"><a href="#StartBlock" class="headerlink" title="StartBlock"></a>StartBlock</h3><p><code>StartBlock</code> 函数用于构建<code>filter block</code>。</p>
<p><code>BlockBasedFilterBlockBuilder</code> 是每 2kb的数据创建一个<code>filter block</code>，传入的参数<code>block_offset</code>是表示最终生成的<code>filter block</code> 在<code>result_</code>中的偏移量。</p>
<p>而 <code>filter_offsets_</code>中记录的是已有<code>filter block</code> 在<code>result_</code> 中的偏移量。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">size_t</span> kFilterBaseLg = <span class="number">11</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">size_t</span> kFilterBase = <span class="number">1</span> &lt;&lt; kFilterBaseLg; <span class="comment">// 2kb</span></span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">BlockBasedFilterBlockBuilder::StartBlock</span><span class="params">(<span class="type">uint64_t</span> block_offset)</span> </span>&#123;</span><br><span class="line">  <span class="type">uint64_t</span> filter_index = (block_offset / kFilterBase);</span><br><span class="line">  <span class="built_in">assert</span>(filter_index &gt;= filter_offsets_.<span class="built_in">size</span>());</span><br><span class="line">  <span class="keyword">while</span> (filter_index &gt; filter_offsets_.<span class="built_in">size</span>()) &#123;</span><br><span class="line">    <span class="built_in">GenerateFilter</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="GenerateFilter"><a href="#GenerateFilter" class="headerlink" title="GenerateFilter"></a>GenerateFilter</h3><p>每个<code>filter block</code>的数据都记录在<code>entries_</code> 和 <code>start_</code>，当调用 <code>GenerateFilter</code> 函数时就会将<code>entries_</code> 、 <code>start_</code>中的数据添加到<code>result_</code>中，而这个<code>filter block</code> 的起始地址记录在<code>filter_offsets_</code>中。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">BlockBasedFilterBlockBuilder::GenerateFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">size_t</span> num_entries = start_.<span class="built_in">size</span>();</span><br><span class="line">  <span class="keyword">if</span> (num_entries == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// 如果这个 filter block 没有key，直接存储上次生成的滤波器的起始地址</span></span><br><span class="line">    filter_offsets_.<span class="built_in">push_back</span>(<span class="built_in">static_cast</span>&lt;<span class="type">uint32_t</span>&gt;(result_.<span class="built_in">size</span>()));</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  total_added_in_built_ += num_entries;</span><br><span class="line">	</span><br><span class="line">  <span class="comment">// 为便于下面使用 start_[i + 1] - start_[i] 计算每个entry的长度</span></span><br><span class="line">  start_.<span class="built_in">push_back</span>(entries_.<span class="built_in">size</span>());     </span><br><span class="line">  tmp_entries_.<span class="built_in">resize</span>(num_entries);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; num_entries; i++) &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* base = entries_.<span class="built_in">data</span>() + start_[i]; <span class="comment">// 每个entry的起始地址</span></span><br><span class="line">    <span class="type">size_t</span> length = start_[i + <span class="number">1</span>] - start_[i];      <span class="comment">// 这个entry的长度</span></span><br><span class="line">    tmp_entries_[i] = <span class="built_in">Slice</span>(base, length);          <span class="comment">// slice</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// filter_offsets_  中保存着每个 filter block 的起始地址，即 result.size()</span></span><br><span class="line">  filter_offsets_.<span class="built_in">push_back</span>(<span class="built_in">static_cast</span>&lt;<span class="type">uint32_t</span>&gt;(result_.<span class="built_in">size</span>()));</span><br><span class="line">  <span class="comment">// 基于 tmp_entries 的内容创建 filter，结果存储至 result_</span></span><br><span class="line">  policy_-&gt;<span class="built_in">CreateFilter</span>(&amp;tmp_entries_[<span class="number">0</span>], </span><br><span class="line">                        <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(num_entries),</span><br><span class="line">                        &amp;result_);</span><br><span class="line">	</span><br><span class="line">  <span class="comment">// 清零，为下个 filter block 准备</span></span><br><span class="line">  tmp_entries_.<span class="built_in">clear</span>();</span><br><span class="line">  entries_.<span class="built_in">clear</span>();</span><br><span class="line">  start_.<span class="built_in">clear</span>();</span><br><span class="line">  prev_prefix_start_ = <span class="number">0</span>;</span><br><span class="line">  prev_prefix_size_ = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Finish"><a href="#Finish" class="headerlink" title="Finish"></a>Finish</h3><p>在调用<code>::Finish</code>函数时，需要<code>result_</code>向<code>result_</code>中写入三部分：</p>
<ul>
<li>每个<code>key</code>的偏移量<code>KEY_OFFSET</code></li>
<li><code>key</code>的数量<code>FILTER_BLOCK_NUM</code></li>
<li>结束标志 <code>kFilterBaseLg</code></li>
</ul>
<p>代码简单如此。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Slice <span class="title">BlockBasedFilterBlockBuilder::Finish</span><span class="params">(<span class="type">const</span> BlockHandle&amp; <span class="comment">/*tmp*/</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">                                           Status* status)</span> </span>&#123;</span><br><span class="line">  *status = Status::<span class="built_in">OK</span>();</span><br><span class="line">  <span class="keyword">if</span> (!start_.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">    <span class="built_in">GenerateFilter</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="type">const</span> <span class="type">uint32_t</span> array_offset = <span class="built_in">static_cast</span>&lt;<span class="type">uint32_t</span>&gt;(result_.<span class="built_in">size</span>());</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; filter_offsets_.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">    <span class="comment">// 把每个 filter block 的偏移量添加到result</span></span><br><span class="line">    <span class="built_in">PutFixed32</span>(&amp;result_, filter_offsets_[i]);</span><br><span class="line">  &#125;</span><br><span class="line">	</span><br><span class="line">  <span class="comment">// 添加 filter block 的数量</span></span><br><span class="line">  <span class="built_in">PutFixed32</span>(&amp;result_, array_offset);</span><br><span class="line">  <span class="comment">// 结束标志位</span></span><br><span class="line">  result_.<span class="built_in">push_back</span>(kFilterBaseLg);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Slice</span>(result_);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="FullFilterBlockBuilder"><a href="#FullFilterBlockBuilder" class="headerlink" title="FullFilterBlockBuilder"></a>FullFilterBlockBuilder</h2><p>他就是将全部的的key都放在了一起、。</p>
<blockquote>
<p>TODO：设计点</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">FullFilterBlockBuilder</span> : <span class="keyword">public</span> FilterBlockBuilder &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">FullFilterBlockBuilder</span><span class="params">(<span class="type">const</span> SliceTransform* prefix_extractor,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  <span class="type">bool</span> whole_key_filtering,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  FilterBitsBuilder* filter_bits_builder)</span></span>;</span><br><span class="line">  <span class="built_in">FullFilterBlockBuilder</span>(<span class="type">const</span> FullFilterBlockBuilder&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">  <span class="type">void</span> <span class="keyword">operator</span>=(<span class="type">const</span> FullFilterBlockBuilder&amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">  ~<span class="built_in">FullFilterBlockBuilder</span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">IsBlockBased</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;	 <span class="comment">// 区分 BlockBasedFilterBlockBuilder</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">StartBlock</span><span class="params">(<span class="type">uint64_t</span>)</span> <span class="keyword">override</span> </span>&#123;&#125;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">IsEmpty</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> !any_added_; &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">size_t</span> <span class="title">EstimateEntriesAdded</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Add</span><span class="params">(<span class="type">const</span> Slice&amp; key_without_ts)</span> <span class="keyword">override</span></span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">using</span> FilterBlockBuilder::Finish;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> Slice <span class="title">Finish</span><span class="params">(<span class="type">const</span> BlockHandle&amp; tmp, Status* status)</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">protected</span>:</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">AddKey</span><span class="params">(<span class="type">const</span> Slice&amp; key)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Reset</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">AddPrefix</span><span class="params">(<span class="type">const</span> Slice&amp; key)</span></span>;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="type">const</span> SliceTransform* <span class="title">prefix_extractor</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> prefix_extractor_; &#125;</span><br><span class="line">  <span class="function"><span class="type">const</span> std::string&amp; <span class="title">last_prefix_str</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> last_prefix_str_; &#125;</span><br><span class="line"></span><br><span class="line">  std::unique_ptr&lt;FilterBitsBuilder&gt; filter_bits_builder_;</span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="type">const</span> SliceTransform* prefix_extractor_;	<span class="comment">// 前缀提取器</span></span><br><span class="line">  <span class="type">bool</span> whole_key_filtering_;</span><br><span class="line">  <span class="type">bool</span> last_whole_key_recorded_;</span><br><span class="line">  std::string last_whole_key_str_;</span><br><span class="line">  <span class="type">bool</span> last_prefix_recorded_;</span><br><span class="line">  std::string last_prefix_str_;</span><br><span class="line">  <span class="type">bool</span> last_key_in_domain_;</span><br><span class="line">  <span class="type">bool</span> any_added_;</span><br><span class="line">  std::unique_ptr&lt;<span class="type">const</span> <span class="type">char</span>[]&gt; filter_data_;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Add-1"><a href="#Add-1" class="headerlink" title="Add"></a>Add</h3><ol>
<li>根据<code>whole_key_filtering_</code> 来确定是否添加整个<code>key_without_ts</code> </li>
<li>根据<code>add_prefix</code>，来看是否添加<code>key_without_ts</code>的前缀</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">FullFilterBlockBuilder::Add</span><span class="params">(<span class="type">const</span> Slice&amp; key_without_ts)</span> </span>&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">bool</span> add_prefix =</span><br><span class="line">      prefix_extractor_ &amp;&amp; prefix_extractor_-&gt;<span class="built_in">InDomain</span>(key_without_ts);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!last_prefix_recorded_ &amp;&amp; last_key_in_domain_) &#123;</span><br><span class="line">    <span class="built_in">AddKey</span>(last_prefix_str_);</span><br><span class="line">    last_prefix_recorded_ = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (whole_key_filtering_) &#123;</span><br><span class="line">    <span class="comment">// 如果没前缀，则直接添加key</span></span><br><span class="line">    <span class="keyword">if</span> (!add_prefix) &#123;</span><br><span class="line">      <span class="built_in">AddKey</span>(key_without_ts);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 第一个 key or 遇到新的 key</span></span><br><span class="line">      Slice last_whole_key = <span class="built_in">Slice</span>(last_whole_key_str_);</span><br><span class="line">      <span class="keyword">if</span> (!last_whole_key_recorded_ ||</span><br><span class="line">          last_whole_key.<span class="built_in">compare</span>(key_without_ts) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">AddKey</span>(key_without_ts);</span><br><span class="line">        last_whole_key_recorded_ = <span class="literal">true</span>;</span><br><span class="line">        last_whole_key_str_.<span class="built_in">assign</span>(key_without_ts.<span class="built_in">data</span>(),</span><br><span class="line">                                   key_without_ts.<span class="built_in">size</span>());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (add_prefix) &#123;</span><br><span class="line">    last_key_in_domain_ = <span class="literal">true</span>;</span><br><span class="line">    <span class="built_in">AddPrefix</span>(key_without_ts);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    last_key_in_domain_ = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="AddKey-1"><a href="#AddKey-1" class="headerlink" title="AddKey"></a>AddKey</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">FullFilterBlockBuilder::AddKey</span><span class="params">(<span class="type">const</span> Slice&amp; key)</span> </span>&#123;</span><br><span class="line">  filter_bits_builder_-&gt;<span class="built_in">AddKey</span>(key);</span><br><span class="line">  any_added_ = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="AddPrefix-1"><a href="#AddPrefix-1" class="headerlink" title="AddPrefix"></a>AddPrefix</h4><ul>
<li><p><code>last_prefix_str_</code>：记录上一次添加的前缀</p>
</li>
<li><p>如果<code>whole_key_filtering_ == true</code>，那么，从<code>FullFilterBlockBuilder::Add</code>函数运行至<code>FullFilterBlockBuilder::AddPrefix</code> 函数结束，添加的数据是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">key_without_ts</span><br><span class="line">prefix</span><br></pre></td></tr></table></figure>

<p>但是如果<code>prefix</code>和上一个添加的前缀相同，则忽略本次的前缀，最终添加的内容只有</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">key_without_ts</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果<code>whole_key_filtering_ == false</code>，添加的数据只有<code>prefix</code></p>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">FullFilterBlockBuilder::AddPrefix</span><span class="params">(<span class="type">const</span> Slice&amp; key)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">assert</span>(prefix_extractor_ &amp;&amp; prefix_extractor_-&gt;<span class="built_in">InDomain</span>(key));</span><br><span class="line">  Slice prefix = prefix_extractor_-&gt;<span class="built_in">Transform</span>(key);</span><br><span class="line">  <span class="keyword">if</span> (whole_key_filtering_) &#123;</span><br><span class="line"> 		<span class="comment">// 前一个添加的前缀</span></span><br><span class="line">    Slice last_prefix = <span class="built_in">Slice</span>(last_prefix_str_);  <span class="comment">// 前缀</span></span><br><span class="line">    <span class="comment">// 遇到新的前缀</span></span><br><span class="line">    <span class="keyword">if</span> (!last_prefix_recorded_ || last_prefix.<span class="built_in">compare</span>(prefix) != <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// 记录前缀</span></span><br><span class="line">      <span class="built_in">AddKey</span>(prefix);</span><br><span class="line">      last_prefix_recorded_ = <span class="literal">true</span>; </span><br><span class="line">      last_prefix_str_.<span class="built_in">assign</span>(prefix.<span class="built_in">data</span>(), prefix.<span class="built_in">size</span>());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 直接添加 prefix</span></span><br><span class="line">    <span class="built_in">AddKey</span>(prefix);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Finish-1"><a href="#Finish-1" class="headerlink" title="Finish"></a>Finish</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">FullFilterBlockBuilder::Reset</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  last_whole_key_recorded_ = <span class="literal">false</span>;</span><br><span class="line">  last_prefix_recorded_ = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Slice <span class="title">FullFilterBlockBuilder::Finish</span><span class="params">(<span class="type">const</span> BlockHandle&amp; <span class="comment">/*tmp*/</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">                                     Status* status)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">Reset</span>();</span><br><span class="line">  <span class="comment">// In this impl we ignore BlockHandle</span></span><br><span class="line">  *status = Status::<span class="built_in">OK</span>();</span><br><span class="line">  <span class="keyword">if</span> (any_added_) &#123;</span><br><span class="line">    any_added_ = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span> filter_bits_builder_-&gt;<span class="built_in">Finish</span>(&amp;filter_data_);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Slice</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="PartitionedFilterBlockBuilder"><a href="#PartitionedFilterBlockBuilder" class="headerlink" title="PartitionedFilterBlockBuilder"></a>PartitionedFilterBlockBuilder</h2><p>对应于 <code>PartitionedIndexBuilder</code>，rocksdb 现在是一个<code>partition filter block</code>  对应一个<code>partition index block</code>。</p>
<p>因此，每生成一个 <code>partition filter block</code> 也会请求  <code>PartitionedIndexBuilder</code> 生成一个 <code>partition index block</code>，来保证一一对应。</p>
<p>两种原理都差不多。</p>
<p>在<code>PartitionedFilterBlockBuilder</code>内部，也有个<code>FilterEntry</code>结构体，类似于<code>PartitionedIndexBuilder::Entry</code>，每个<code>value</code>都是一个<code>filter</code>。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PartitionedFilterBlockBuilder</span> : <span class="keyword">public</span> FullFilterBlockBuilder &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">PartitionedFilterBlockBuilder</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="type">const</span> SliceTransform* prefix_extractor, </span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="type">bool</span> whole_key_filtering,</span></span></span><br><span class="line"><span class="params"><span class="function">      FilterBitsBuilder* filter_bits_builder, </span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="type">int</span> index_block_restart_interval,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="type">const</span> <span class="type">bool</span> use_value_delta_encoding,</span></span></span><br><span class="line"><span class="params"><span class="function">      PartitionedIndexBuilder* <span class="type">const</span> p_index_builder,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="type">const</span> <span class="type">uint32_t</span> partition_size)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">virtual</span> ~<span class="built_in">PartitionedFilterBlockBuilder</span>();</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">AddKey</span><span class="params">(<span class="type">const</span> Slice&amp; key)</span> <span class="keyword">override</span></span>;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">Add</span><span class="params">(<span class="type">const</span> Slice&amp; key)</span> <span class="keyword">override</span></span>;</span><br><span class="line">  <span class="function"><span class="type">size_t</span> <span class="title">EstimateEntriesAdded</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> Slice <span class="title">Finish</span><span class="params">(<span class="type">const</span> BlockHandle&amp; last_partition_block_handle,</span></span></span><br><span class="line"><span class="params"><span class="function">                       Status* status)</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line"></span><br><span class="line">  BlockBuilder index_on_filter_block_builder_;  <span class="comment">// top-level index builder</span></span><br><span class="line">  BlockBuilder index_on_filter_block_builder_without_seq_;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">FilterEntry</span> &#123;</span><br><span class="line">    std::string key;</span><br><span class="line">    Slice filter;</span><br><span class="line">  &#125;;</span><br><span class="line">  std::list&lt;FilterEntry&gt; filters;      <span class="comment">// list of partitioned indexes and their keys</span></span><br><span class="line">  std::unique_ptr&lt;IndexBuilder&gt; value; <span class="comment">// 可以存储 PartitionedIndexBuilder</span></span><br><span class="line">  std::vector&lt;std::unique_ptr&lt;<span class="type">const</span> <span class="type">char</span>[]&gt;&gt; filter_gc;</span><br><span class="line">  <span class="type">bool</span> finishing_filters = <span class="literal">false</span>;      <span class="comment">// 为true，表示正调用 Finish 函数，尚未返回 Status::OK()</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">MaybeCutAFilterBlock</span><span class="params">(<span class="type">const</span> Slice* next_key)</span></span>;</span><br><span class="line">  </span><br><span class="line">  PartitionedIndexBuilder* <span class="type">const</span> p_index_builder_;</span><br><span class="line">  <span class="type">uint32_t</span> keys_per_partition_;			<span class="comment">// 每个 partition 中 key 的数量</span></span><br><span class="line">  <span class="type">uint32_t</span> keys_added_to_partition_;<span class="comment">// 最近一个partion添加的key的数量</span></span><br><span class="line">  <span class="type">uint64_t</span> total_added_in_built_;	  <span class="comment">// 总共添加的key的数量</span></span><br><span class="line">  BlockHandle last_encoded_handle_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="MaybeCutAFilterBlock"><a href="#MaybeCutAFilterBlock" class="headerlink" title="MaybeCutAFilterBlock"></a>MaybeCutAFilterBlock</h3><p><code>MaybeCutAFilterBlock</code> 函数，用于判断当前是否需要生成一个<code>filter block</code>： <strong>当前 <code>partition</code>添加的key的数量 <code>keys_added_to_partition_</code> 已经到达阈值 <code>keys_per_partition_</code></strong> 。</p>
<p>由于<code>partition filter block</code> 和 <code>partition index block</code> 的数目是一一对应的。因此，需要请求 <code>PartitionedIndexBuilder</code> 对象 <code>p_index_builder_</code>  也生成一个<code>partition index block</code>。此外，生成的<code>partition idnex block</code>  和 <code>partition filter block</code> 对应的key是相同的。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">PartitionedIndexBuilder</span>::Entry &#123;</span><br><span class="line">  std::string key;														  <span class="comment">// sub_index_last_key_;</span></span><br><span class="line">  std::unique_ptr&lt;ShortenedIndexBuilder&gt; value; <span class="comment">// partition index block</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">PartitionedFilterBlockBuilderFilterEntry</span> &#123;</span><br><span class="line">  std::string key;	<span class="comment">// sub_index_last_key_</span></span><br><span class="line">  Slice filter;	    <span class="comment">// partition filter block</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>MaybeCutAFilterBlock</code> 的函数分为三步：</p>
<ol>
<li>如果当前 <code>partition filter block</code>的<code>keys_added_to_partition_</code>已达到阈值，则请求对应的<code>partiiton index block</code>也创建完毕，否则就阻塞等待；</li>
<li>将待添加的<code>next_key</code>的前缀<code>next_key_prefix</code>添加到<code>partition filer block</code>；</li>
<li>生成<code>partition filter block</code>，并添加到<code>filters</code> 中。</li>
</ol>
<p>顺着源码更加详细地去理解这个过程。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">PartitionedFilterBlockBuilder::MaybeCutAFilterBlock</span><span class="params">(<span class="type">const</span> Slice* next_key)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 当前 parition 的 key 达到阈值</span></span><br><span class="line">  <span class="keyword">if</span> (keys_added_to_partition_ == keys_per_partition_) &#123;</span><br><span class="line">    <span class="comment">// 请求 p_index_builder_ 生成一个 partition</span></span><br><span class="line">    p_index_builder_-&gt;<span class="built_in">RequestPartitionCut</span>();</span><br><span class="line">  &#125;</span><br><span class="line">		</span><br><span class="line">  <span class="keyword">if</span> (!p_index_builder_-&gt;<span class="built_in">ShouldCutFilterBlock</span>()) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/// p_index_builder_ 已生成一个 partition</span></span><br><span class="line"> </span><br><span class="line">  filter_gc.<span class="built_in">push_back</span>(std::<span class="built_in">unique_ptr</span>&lt;<span class="type">const</span> <span class="type">char</span>[]&gt;(<span class="literal">nullptr</span>));</span><br><span class="line">	</span><br><span class="line">  <span class="comment">// 判断是否需要添加 next_key 的前缀</span></span><br><span class="line">  <span class="type">const</span> <span class="type">bool</span> maybe_add_prefix =</span><br><span class="line">      next_key &amp;&amp; <span class="built_in">prefix_extractor</span>() &amp;&amp; <span class="built_in">prefix_extractor</span>()-&gt;<span class="built_in">InDomain</span>(*next_key);</span><br><span class="line">  <span class="keyword">if</span> (maybe_add_prefix) &#123;</span><br><span class="line">    <span class="type">const</span> Slice next_key_prefix = <span class="built_in">prefix_extractor</span>()-&gt;<span class="built_in">Transform</span>(*next_key);</span><br><span class="line">    <span class="comment">// 与之前的前缀不同，则添加</span></span><br><span class="line">    <span class="keyword">if</span> (next_key_prefix.<span class="built_in">compare</span>(<span class="built_in">last_prefix_str</span>()) != <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">AddKey</span>(next_key_prefix);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">	</span><br><span class="line">  total_added_in_built_ += filter_bits_builder_-&gt;<span class="built_in">EstimateEntriesAdded</span>();</span><br><span class="line">  <span class="comment">// 生成一个 filter block</span></span><br><span class="line">  Slice filter = filter_bits_builder_-&gt;<span class="built_in">Finish</span>(&amp;filter_gc.<span class="built_in">back</span>());</span><br><span class="line">  <span class="comment">// index_key 是 partition index block 存储的时的 key</span></span><br><span class="line">  std::string&amp; index_key = p_index_builder_-&gt;<span class="built_in">GetPartitionKey</span>();</span><br><span class="line">  <span class="comment">// &#123;index_key, PartitionFilter&#125;</span></span><br><span class="line">  filters.<span class="built_in">push_back</span>(&#123;index_key, filter&#125;);</span><br><span class="line">  <span class="comment">// 当前 partition 已添加的key数清零</span></span><br><span class="line">  keys_added_to_partition_ = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">Reset</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="AddKey-2"><a href="#AddKey-2" class="headerlink" title="AddKey"></a>AddKey</h4><p>添加 <code>key</code> 至当前<code>partition filter block</code> 中。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">PartitionedFilterBlockBuilder::AddKey</span><span class="params">(<span class="type">const</span> Slice&amp; key)</span> </span>&#123;</span><br><span class="line">  FullFilterBlockBuilder::<span class="built_in">AddKey</span>(key);</span><br><span class="line">  keys_added_to_partition_++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Add-2"><a href="#Add-2" class="headerlink" title="Add"></a>Add</h3><p>由于<code>PartitionedFilterBlockBuilder</code> 继承自<code>FullFilterBlockBuilder</code>，唯一的区别就在于将一整个<code>Filter Block</code>，划分为多个<code>partitions</code>。</p>
<p>因此，在每次<code>Add</code>新的<code>key</code>，都先判断下是是否要需要生成新的<code>partition filter block</code>，然后将<code>key</code>添加到当前<code>partiton filter block</code>。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">PartitionedFilterBlockBuilder::Add</span><span class="params">(<span class="type">const</span> Slice&amp; key)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">MaybeCutAFilterBlock</span>(&amp;key);</span><br><span class="line">  FullFilterBlockBuilder::<span class="built_in">Add</span>(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Finish-2"><a href="#Finish-2" class="headerlink" title="Finish"></a>Finish</h3><p>类似于<code>PartitionIndexBuiler</code>, 这里要将<code>fiters</code> 中记录的<code>partitions</code> 都写入到SST中，并记录下每个<code>partition</code> 在SST中的偏移量offset，根据<code>partiton</code>的大小size和offset生成 <code>TopLevelIndex</code>。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Slice <span class="title">PartitionedFilterBlockBuilder::Finish</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> BlockHandle&amp; last_partition_block_handle, </span></span></span><br><span class="line"><span class="params"><span class="function">    Status* status)</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (finishing_filters == <span class="literal">true</span>) &#123;</span><br><span class="line">    FilterEntry&amp; last_entry = filters.<span class="built_in">front</span>();</span><br><span class="line">    std::string handle_encoding;</span><br><span class="line">    last_partition_block_handle.<span class="built_in">EncodeTo</span>(&amp;handle_encoding);</span><br><span class="line">    std::string handle_delta_encoding;</span><br><span class="line">    <span class="built_in">PutVarsignedint64</span>(</span><br><span class="line">        &amp;handle_delta_encoding,</span><br><span class="line">        last_partition_block_handle.<span class="built_in">size</span>() - last_encoded_handle_.<span class="built_in">size</span>());</span><br><span class="line">    last_encoded_handle_ = last_partition_block_handle;</span><br><span class="line">    <span class="function"><span class="type">const</span> Slice <span class="title">handle_delta_encoding_slice</span><span class="params">(handle_delta_encoding)</span></span>;</span><br><span class="line">    index_on_filter_block_builder_.<span class="built_in">Add</span>(last_entry.key,  	<span class="comment">// key 相同</span></span><br><span class="line">                                       handle_encoding,   <span class="comment">// block_handle</span></span><br><span class="line">                                       &amp;handle_delta_encoding_slice);</span><br><span class="line">    <span class="keyword">if</span> (!p_index_builder_-&gt;<span class="built_in">seperator_is_key_plus_seq</span>()) &#123;</span><br><span class="line">      index_on_filter_block_builder_without_seq_.<span class="built_in">Add</span>(</span><br><span class="line">          <span class="built_in">ExtractUserKey</span>(last_entry.key), handle_encoding,</span><br><span class="line">          &amp;handle_delta_encoding_slice);</span><br><span class="line">    &#125;</span><br><span class="line">    filters.<span class="built_in">pop_front</span>();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 第一次调用 ::Finish 函数，此时没有 next_key，</span></span><br><span class="line">    <span class="comment">// 仅仅是为了生成最后一个 partition fiter block</span></span><br><span class="line">    <span class="built_in">MaybeCutAFilterBlock</span>(<span class="literal">nullptr</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">UNLIKELY</span>(filters.<span class="built_in">empty</span>())) &#123;</span><br><span class="line">    *status = Status::<span class="built_in">OK</span>();</span><br><span class="line">    <span class="keyword">if</span> (finishing_filters) &#123;</span><br><span class="line">       <span class="comment">/// 最后一次调用 ::Finish</span></span><br><span class="line">      total_added_in_built_ = <span class="number">0</span>;</span><br><span class="line">      <span class="comment">// 返回partitions的元信息</span></span><br><span class="line">      <span class="keyword">if</span> (p_index_builder_-&gt;<span class="built_in">seperator_is_key_plus_seq</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> index_on_filter_block_builder_.<span class="built_in">Finish</span>();</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> index_on_filter_block_builder_without_seq_.<span class="built_in">Finish</span>();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// This is the rare case where no key was added to the filter</span></span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Slice</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 返回当前 partition 的信息</span></span><br><span class="line">    *status = Status::<span class="built_in">Incomplete</span>();</span><br><span class="line">    finishing_filters = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">return</span> filters.<span class="built_in">front</span>().filter;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives">archives</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#FilterBlockBuilder"><span class="toc-number">1.</span> <span class="toc-text">FilterBlockBuilder</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BlockBasedFilterBlockBuilder"><span class="toc-number">2.</span> <span class="toc-text">BlockBasedFilterBlockBuilder</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Add"><span class="toc-number">2.1.</span> <span class="toc-text">Add</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#AddKey"><span class="toc-number">2.1.1.</span> <span class="toc-text">AddKey</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AddPrefix"><span class="toc-number">2.1.2.</span> <span class="toc-text">AddPrefix</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#StartBlock"><span class="toc-number">2.2.</span> <span class="toc-text">StartBlock</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GenerateFilter"><span class="toc-number">2.3.</span> <span class="toc-text">GenerateFilter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Finish"><span class="toc-number">2.4.</span> <span class="toc-text">Finish</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FullFilterBlockBuilder"><span class="toc-number">3.</span> <span class="toc-text">FullFilterBlockBuilder</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Add-1"><span class="toc-number">3.1.</span> <span class="toc-text">Add</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#AddKey-1"><span class="toc-number">3.1.1.</span> <span class="toc-text">AddKey</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AddPrefix-1"><span class="toc-number">3.1.2.</span> <span class="toc-text">AddPrefix</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Finish-1"><span class="toc-number">3.1.3.</span> <span class="toc-text">Finish</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PartitionedFilterBlockBuilder"><span class="toc-number">4.</span> <span class="toc-text">PartitionedFilterBlockBuilder</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MaybeCutAFilterBlock"><span class="toc-number">4.1.</span> <span class="toc-text">MaybeCutAFilterBlock</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#AddKey-2"><span class="toc-number">4.1.1.</span> <span class="toc-text">AddKey</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Add-2"><span class="toc-number">4.2.</span> <span class="toc-text">Add</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Finish-2"><span class="toc-number">4.3.</span> <span class="toc-text">Finish</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://szza.github.io/2021/11/27/rocksdb/Table/builder/3_FilterBlock/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://szza.github.io/2021/11/27/rocksdb/Table/builder/3_FilterBlock/&text=FilterBlock 源码分析"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://szza.github.io/2021/11/27/rocksdb/Table/builder/3_FilterBlock/&title=FilterBlock 源码分析"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://szza.github.io/2021/11/27/rocksdb/Table/builder/3_FilterBlock/&is_video=false&description=FilterBlock 源码分析"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=FilterBlock 源码分析&body=Check out this article: https://szza.github.io/2021/11/27/rocksdb/Table/builder/3_FilterBlock/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://szza.github.io/2021/11/27/rocksdb/Table/builder/3_FilterBlock/&title=FilterBlock 源码分析"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://szza.github.io/2021/11/27/rocksdb/Table/builder/3_FilterBlock/&title=FilterBlock 源码分析"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://szza.github.io/2021/11/27/rocksdb/Table/builder/3_FilterBlock/&title=FilterBlock 源码分析"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://szza.github.io/2021/11/27/rocksdb/Table/builder/3_FilterBlock/&title=FilterBlock 源码分析"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://szza.github.io/2021/11/27/rocksdb/Table/builder/3_FilterBlock/&name=FilterBlock 源码分析&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://szza.github.io/2021/11/27/rocksdb/Table/builder/3_FilterBlock/&t=FilterBlock 源码分析"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2021-2025
    fibonaccii
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives">archives</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

    <script async src="https://www.googletagmanager.com/gtag/js?id=szza"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'szza');
    </script>

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->


</body>
</html>
