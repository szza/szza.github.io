<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="RIO为读写流提供了统一的接口  不仅可以用于读写RDB、AOF，实现持久化 也可以用于读写socket与pipe，实现主从同步任务">
<meta property="og:type" content="article">
<meta property="og:title" content="剖析REDIS的rio">
<meta property="og:url" content="https://szza.github.io/2021/01/27/Redis/%E6%8C%81%E4%B9%85%E5%8C%96/RIO/index.html">
<meta property="og:site_name" content="szza">
<meta property="og:description" content="RIO为读写流提供了统一的接口  不仅可以用于读写RDB、AOF，实现持久化 也可以用于读写socket与pipe，实现主从同步任务">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2021-01-27T08:36:18.000Z">
<meta property="article:modified_time" content="2023-08-26T17:48:00.916Z">
<meta property="article:author" content="fibonaccii">
<meta property="article:tag" content="Redis6.0">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/id.jpg">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/id.jpg" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/id.jpg">
        
      
    
    <!-- title -->
    <title>剖析REDIS的rio</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="szza" type="application/atom+xml">
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives">archives</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2021/01/29/Redis/%E5%88%86%E5%B8%83%E5%BC%8F/replication/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2021/01/26/Redis/Threads/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://szza.github.io/2021/01/27/Redis/%E6%8C%81%E4%B9%85%E5%8C%96/RIO/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://szza.github.io/2021/01/27/Redis/%E6%8C%81%E4%B9%85%E5%8C%96/RIO/&text=剖析REDIS的rio"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://szza.github.io/2021/01/27/Redis/%E6%8C%81%E4%B9%85%E5%8C%96/RIO/&title=剖析REDIS的rio"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://szza.github.io/2021/01/27/Redis/%E6%8C%81%E4%B9%85%E5%8C%96/RIO/&is_video=false&description=剖析REDIS的rio"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=剖析REDIS的rio&body=Check out this article: https://szza.github.io/2021/01/27/Redis/%E6%8C%81%E4%B9%85%E5%8C%96/RIO/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://szza.github.io/2021/01/27/Redis/%E6%8C%81%E4%B9%85%E5%8C%96/RIO/&title=剖析REDIS的rio"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://szza.github.io/2021/01/27/Redis/%E6%8C%81%E4%B9%85%E5%8C%96/RIO/&title=剖析REDIS的rio"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://szza.github.io/2021/01/27/Redis/%E6%8C%81%E4%B9%85%E5%8C%96/RIO/&title=剖析REDIS的rio"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://szza.github.io/2021/01/27/Redis/%E6%8C%81%E4%B9%85%E5%8C%96/RIO/&title=剖析REDIS的rio"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://szza.github.io/2021/01/27/Redis/%E6%8C%81%E4%B9%85%E5%8C%96/RIO/&name=剖析REDIS的rio&description=&lt;p&gt;RIO为读写流提供了统一的接口&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;不仅可以用于读写RDB、AOF，实现持久化&lt;/li&gt;
&lt;li&gt;也可以用于读写socket与pipe，实现主从同步任务&lt;/li&gt;
&lt;/ul&gt;"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://szza.github.io/2021/01/27/Redis/%E6%8C%81%E4%B9%85%E5%8C%96/RIO/&t=剖析REDIS的rio"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#RIO"><span class="toc-number">1.</span> <span class="toc-text">RIO</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#rioBufferIO"><span class="toc-number">1.1.</span> <span class="toc-text">rioBufferIO</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#rioInitWithBuffer"><span class="toc-number">1.1.1.</span> <span class="toc-text">rioInitWithBuffer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rioBufferWrite"><span class="toc-number">1.1.2.</span> <span class="toc-text">rioBufferWrite</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rioBufferRead"><span class="toc-number">1.1.3.</span> <span class="toc-text">rioBufferRead</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rioBufferTell"><span class="toc-number">1.1.4.</span> <span class="toc-text">rioBufferTell</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rioBufferFlush"><span class="toc-number">1.1.5.</span> <span class="toc-text">rioBufferFlush</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rioFileIO"><span class="toc-number">1.2.</span> <span class="toc-text">rioFileIO</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#rioInitWithFile"><span class="toc-number">1.2.1.</span> <span class="toc-text">rioInitWithFile</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#rioSetAutoSync"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">rioSetAutoSync</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rioFileWrite"><span class="toc-number">1.2.2.</span> <span class="toc-text">rioFileWrite</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rioFileRead"><span class="toc-number">1.2.3.</span> <span class="toc-text">rioFileRead</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rioConnIO"><span class="toc-number">1.3.</span> <span class="toc-text">rioConnIO</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#rioInitWithConn"><span class="toc-number">1.3.1.</span> <span class="toc-text">rioInitWithConn</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rioFreeConn"><span class="toc-number">1.3.2.</span> <span class="toc-text">rioFreeConn</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rioConnWrite"><span class="toc-number">1.3.3.</span> <span class="toc-text">rioConnWrite</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rioConnRead"><span class="toc-number">1.3.4.</span> <span class="toc-text">rioConnRead</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rioFdIO"><span class="toc-number">1.4.</span> <span class="toc-text">rioFdIO</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#rioInitWithFd"><span class="toc-number">1.4.1.</span> <span class="toc-text">rioInitWithFd</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rioFreeFd"><span class="toc-number">1.4.2.</span> <span class="toc-text">rioFreeFd</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rioFdWrite"><span class="toc-number">1.4.3.</span> <span class="toc-text">rioFdWrite</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rioFdRead"><span class="toc-number">1.4.4.</span> <span class="toc-text">rioFdRead</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rioFdTell"><span class="toc-number">1.4.5.</span> <span class="toc-text">rioFdTell</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rioGenericUpdateChecksum"><span class="toc-number">1.5.</span> <span class="toc-text">rioGenericUpdateChecksum</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#W-R"><span class="toc-number">2.</span> <span class="toc-text">W &amp; R</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Error"><span class="toc-number">2.1.</span> <span class="toc-text">Error</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rioWrite"><span class="toc-number">2.2.</span> <span class="toc-text">rioWrite</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#rdbWriteRaw"><span class="toc-number">2.2.1.</span> <span class="toc-text">rdbWriteRaw</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rioRead"><span class="toc-number">2.3.</span> <span class="toc-text">rioRead</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        剖析REDIS的rio
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">fibonaccii</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2021-01-27T08:36:18.000Z" itemprop="datePublished">2021-01-27</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/Redis6-0/" rel="tag">Redis6.0</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>RIO为读写流提供了统一的接口</p>
<ul>
<li>不仅可以用于读写RDB、AOF，实现持久化</li>
<li>也可以用于读写socket与pipe，实现主从同步任务</li>
</ul>
<span id="more"></span>

<h2 id="RIO"><a href="#RIO" class="headerlink" title="RIO"></a>RIO</h2><p><code>rio</code> 用于操作不同读写流，因此需要提供统一的接口。</p>
<ul>
<li><p>操作缓冲区的方法：读写、当前位置、缓冲区</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">size_t</span> (*read) (<span class="keyword">struct</span> _rio *, <span class="type">void</span> *buf,       <span class="type">size_t</span> len);</span><br><span class="line"><span class="type">size_t</span> (*write)(<span class="keyword">struct</span> _rio *, <span class="type">const</span> <span class="type">void</span> *buf, <span class="type">size_t</span> len);</span><br><span class="line"><span class="type">off_t</span>  (*tell) (<span class="keyword">struct</span> _rio *);</span><br><span class="line"><span class="type">int</span>    (*flush)(<span class="keyword">struct</span> _rio *);</span><br></pre></td></tr></table></figure>
</li>
<li><p>计算校验和</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">void</span> (*update_cksum)(<span class="keyword">struct</span> _rio *, <span class="type">const</span> <span class="type">void</span> *buf, <span class="type">size_t</span> len);</span><br><span class="line">  	</span><br><span class="line"><span class="type">uint64_t</span> cksum;</span><br></pre></td></tr></table></figure>
</li>
<li><p>基于不同后端的 <code>rio</code>对象，为节省内存使用了<code>union</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">    <span class="comment">// 内存</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span> <span class="comment">/*...*/</span> &#125;  buffer;	<span class="comment">// 支持读写</span></span><br><span class="line">     </span><br><span class="line">    <span class="comment">// 文件fp</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span> <span class="comment">/*...*/</span> &#125;  file;	<span class="comment">// 支持读写，实现持久化</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// socketfd</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span> <span class="comment">/*...*/</span> &#125;  conn;	<span class="comment">// 仅支持读，实现主从复制</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 文件fd</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span> <span class="comment">/*...*/</span> &#125;  fd;	<span class="comment">// 仅支持写，实现主从同步</span></span><br><span class="line">&#125; io;</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>RIO</strong>的完整结构如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">_rio</span> &#123;</span><br><span class="line">    <span class="comment">// 返回0表示错误，非0即成功</span></span><br><span class="line">    <span class="built_in">size_t</span> (*read) (<span class="keyword">struct</span> _rio *, <span class="type">void</span> *buf,       <span class="type">size_t</span> len);</span><br><span class="line">    <span class="built_in">size_t</span> (*write)(<span class="keyword">struct</span> _rio *, <span class="type">const</span> <span class="type">void</span> *buf, <span class="type">size_t</span> len);</span><br><span class="line">    <span class="built_in">off_t</span>  (*tell) (<span class="keyword">struct</span> _rio *);</span><br><span class="line">    <span class="built_in">int</span>    (*flush)(<span class="keyword">struct</span> _rio *);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 校验和计算函数</span></span><br><span class="line">    <span class="built_in">void</span> (*update_cksum)(<span class="keyword">struct</span> _rio *, <span class="type">const</span> <span class="type">void</span> *buf, <span class="type">size_t</span> len);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* The current checksum and flags (see RIO_FLAG_*) */</span></span><br><span class="line">    <span class="type">uint64_t</span> cksum, flags;</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> processed_bytes;    <span class="comment">// 当前处理字节</span></span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> max_processing_chunk; <span class="comment">// 单次最大/写字节数</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Backend-specific vars. */</span></span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        <span class="comment">/* In-memory buffer target. */</span></span><br><span class="line">        <span class="comment">// 内存</span></span><br><span class="line">        <span class="keyword">struct</span> &#123;</span><br><span class="line">            sds   ptr;  <span class="comment">// buffer </span></span><br><span class="line">            <span class="type">off_t</span> pos;  <span class="comment">// 位置</span></span><br><span class="line">        &#125; buffer;</span><br><span class="line">        <span class="comment">/* Stdio file pointer target. */</span></span><br><span class="line">        <span class="comment">// 文件fp</span></span><br><span class="line">        <span class="keyword">struct</span> &#123;</span><br><span class="line">            FILE *fp;</span><br><span class="line">            <span class="type">off_t</span> buffered; <span class="comment">/* Bytes written since last fsync. */</span></span><br><span class="line">            <span class="type">off_t</span> autosync; <span class="comment">/* fsync after &#x27;autosync&#x27; bytes written. */</span></span><br><span class="line">        &#125; file;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Connection object (used to read from socket) */</span></span><br><span class="line">        <span class="comment">// socketfd</span></span><br><span class="line">        <span class="keyword">struct</span> &#123;</span><br><span class="line">            connection* conn;   <span class="comment">/* Connection */</span></span><br><span class="line">            <span class="type">off_t</span> pos;          <span class="comment">/* pos in buf that was returned */</span></span><br><span class="line">            sds   buf;          <span class="comment">/* buffered data */</span>             </span><br><span class="line">            <span class="type">size_t</span> read_limit;  <span class="comment">/* don&#x27;t allow to buffer/read more than that */</span>       <span class="comment">// 读取字节数限制</span></span><br><span class="line">            <span class="type">size_t</span> read_so_far; <span class="comment">/* amount of data read from the rio (not buffered) */</span> <span class="comment">// 目前已经读取字节数</span></span><br><span class="line">        &#125; conn;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* FD target (used to write to pipe). */</span></span><br><span class="line">        <span class="comment">// 文件fd</span></span><br><span class="line">        <span class="keyword">struct</span> &#123;</span><br><span class="line">            <span class="type">int</span> fd;       <span class="comment">/* File descriptor. */</span></span><br><span class="line">            <span class="type">off_t</span> pos;</span><br><span class="line">            sds buf;</span><br><span class="line">        &#125; fd;</span><br><span class="line">    &#125; io;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>下面分别基于四个后端，实现不同的 <code>write</code> 、<code>read</code>、<code>tell</code>和<code>flush</code>操作</p>
<h3 id="rioBufferIO"><a href="#rioBufferIO" class="headerlink" title="rioBufferIO"></a>rioBufferIO</h3><p>处于 <code>buffer</code>模式下，数据都是在内存中操作。结构体如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 内存</span></span><br><span class="line"><span class="keyword">struct</span> &#123;</span><br><span class="line">    sds   ptr;  <span class="comment">// buffer </span></span><br><span class="line">    <span class="type">off_t</span> pos;  <span class="comment">// 位置</span></span><br><span class="line">&#125; buffer;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>ptr</code>：向 <code>ptr</code>里写，or 从 <code>ptr</code> 里读</li>
<li><code>pps</code>：当前读&#x2F;写的位置</li>
</ul>
<p>基于<code>Buffer</code>模式下的<code>rio</code>遍历如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 全局变量</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> rio rioBufferIO = &#123;</span><br><span class="line">    rioBufferRead,  <span class="comment">// read </span></span><br><span class="line">    rioBufferWrite, <span class="comment">// write</span></span><br><span class="line">    rioBufferTell,  <span class="comment">// tell</span></span><br><span class="line">    rioBufferFlush, <span class="comment">// flush</span></span><br><span class="line">    <span class="literal">NULL</span>,           <span class="comment">/* update_checksum */</span></span><br><span class="line"></span><br><span class="line">    <span class="number">0</span>,              <span class="comment">/* current checksum */</span></span><br><span class="line">    <span class="number">0</span>,              <span class="comment">/* flags */</span></span><br><span class="line">    <span class="number">0</span>,              <span class="comment">/* bytes read or written */</span></span><br><span class="line">    <span class="number">0</span>,              <span class="comment">/* read/write chunk size */</span></span><br><span class="line">    &#123; &#123; <span class="literal">NULL</span>, <span class="number">0</span> &#125; &#125; <span class="comment">/* union for io-specific vars */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="rioInitWithBuffer"><a href="#rioInitWithBuffer" class="headerlink" title="rioInitWithBuffer"></a>rioInitWithBuffer</h4><p>初始化基于<code>buffer</code>的<code>rio</code>对象</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">rioInitWithBuffer</span><span class="params">(rio *r, sds s)</span> </span>&#123;</span><br><span class="line">    *r = rioBufferIO;</span><br><span class="line">    r-&gt;io.buffer.ptr = s;</span><br><span class="line">    r-&gt;io.buffer.pos = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面是四个回调函数</p>
<h4 id="rioBufferWrite"><a href="#rioBufferWrite" class="headerlink" title="rioBufferWrite"></a>rioBufferWrite</h4><p>向<code>r-&gt;io.buf.ptr</code>里写数据，直接在后面追加即可</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">size_t</span> <span class="title">rioBufferWrite</span><span class="params">(rio *r, <span class="type">const</span> <span class="type">void</span> *buf, <span class="type">size_t</span> len)</span> </span>&#123;</span><br><span class="line">    r-&gt;io.buffer.ptr = <span class="built_in">sdscatlen</span>(r-&gt;io.buffer.ptr,(<span class="type">char</span>*)buf,len);</span><br><span class="line">    r-&gt;io.buffer.pos += len;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rioBufferRead"><a href="#rioBufferRead" class="headerlink" title="rioBufferRead"></a>rioBufferRead</h4><p>从 <code>r-&gt;io.buf.ptr</code> 中读取数据到<code>buf</code>中，即将数据复制到<code>buf</code>中。</p>
<p>注意：不能同时读和写，只能用于一个，因此在读写操作中都是  <code>r-&gt;io.buffer.pos += len</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">size_t</span> <span class="title">rioBufferRead</span><span class="params">(rio *r, <span class="type">void</span> *buf, <span class="type">size_t</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">sdslen</span>(r-&gt;io.buffer.ptr)-r-&gt;io.buffer.pos &lt; len)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">/* not enough buffer to return len bytes. */</span></span><br><span class="line">    <span class="built_in">memcpy</span>(buf, r-&gt;io.buffer.ptr+r-&gt;io.buffer.pos, len);</span><br><span class="line">    r-&gt;io.buffer.pos += len;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rioBufferTell"><a href="#rioBufferTell" class="headerlink" title="rioBufferTell"></a>rioBufferTell</h4><p>直接返回当前操作的位置即可</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回当前读写的位置</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">off_t</span> <span class="title">rioBufferTell</span><span class="params">(rio *r)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> r-&gt;io.buffer.pos;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rioBufferFlush"><a href="#rioBufferFlush" class="headerlink" title="rioBufferFlush"></a>rioBufferFlush</h4><p><code>buffer</code>模式下，一直在内存中，不需要<code>flush</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Flushes any buffer to target device if applicable.</span></span><br><span class="line"><span class="comment">  * Returns 1 on success and 0 on failures. */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">rioBufferFlush</span><span class="params">(rio *r)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">UNUSED</span>(r);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>; <span class="comment">/* Nothing to do, our write just appends to the buffer. */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="rioFileIO"><a href="#rioFileIO" class="headerlink" title="rioFileIO"></a>rioFileIO</h3><p>基于文件流实现的<code>rio</code>对象  <code>rioFileIO</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> rio rioFileIO = &#123;</span><br><span class="line">    rioFileRead,</span><br><span class="line">    rioFileWrite,</span><br><span class="line">    rioFileTell,</span><br><span class="line">    rioFileFlush,</span><br><span class="line">    <span class="literal">NULL</span>,           <span class="comment">/* update_checksum */</span></span><br><span class="line">    <span class="number">0</span>,              <span class="comment">/* current checksum */</span></span><br><span class="line">    <span class="number">0</span>,              <span class="comment">/* flags */</span></span><br><span class="line">    <span class="number">0</span>,              <span class="comment">/* bytes read or written */</span></span><br><span class="line">    <span class="number">0</span>,              <span class="comment">/* read/write chunk size */</span></span><br><span class="line">    &#123; &#123; <span class="literal">NULL</span>, <span class="number">0</span> &#125; &#125; <span class="comment">/* union for io-specific vars */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="rioInitWithFile"><a href="#rioInitWithFile" class="headerlink" title="rioInitWithFile"></a>rioInitWithFile</h4><p>以 <code>rioFileIO</code> 来初始化 <code>rio</code> 对象：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> &#123;</span><br><span class="line">    FILE *fp;</span><br><span class="line">    <span class="type">off_t</span> buffered; <span class="comment">/* Bytes written since last fsync. */</span> 		<span class="comment">// 已向 fp 中写入的字节数</span></span><br><span class="line">    <span class="type">off_t</span> autosync; <span class="comment">/* fsync after &#x27;autosync&#x27; bytes written. */</span> <span class="comment">// buffered 达到 autosync，则flush一次</span></span><br><span class="line">&#125; file;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">rioInitWithFile</span><span class="params">(rio *r, FILE *fp)</span> </span>&#123;</span><br><span class="line">    *r = rioFileIO;</span><br><span class="line">    r-&gt;io.file.fp = fp;		<span class="comment">// 文件流</span></span><br><span class="line">    r-&gt;io.file.buffered = <span class="number">0</span>;</span><br><span class="line">    r-&gt;io.file.autosync = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="rioSetAutoSync"><a href="#rioSetAutoSync" class="headerlink" title="rioSetAutoSync"></a>rioSetAutoSync</h5><p>为防止最后写完数据再同步，会对服务器造成较长时间的阻塞。因此，可以使用<code>rioSetAutoSync</code>函数，开启自动同步，即在向rio写入的过程中，每间隔累计超过<code>byte</code>个字节，就同步一次。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">rioSetAutoSync</span><span class="params">(rio *r, <span class="type">off_t</span> bytes)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(r-&gt;write != rioFileIO.write) </span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    r-&gt;io.file.autosync = bytes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rioFileWrite"><a href="#rioFileWrite" class="headerlink" title="rioFileWrite"></a>rioFileWrite</h4><p>将 <code>buf</code>中的数据写到 <code>r-&gt;io.file.fp</code>中</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将数据写到文件r中</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">size_t</span> <span class="title">rioFileWrite</span><span class="params">(rio *r, <span class="type">const</span> <span class="type">void</span> *buf, <span class="type">size_t</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="type">size_t</span> retval;</span><br><span class="line"></span><br><span class="line">    retval = <span class="built_in">fwrite</span>(buf, len, <span class="number">1</span> ,r-&gt;io.file.fp);</span><br><span class="line">    r-&gt;io.file.buffered += len;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果达到flush的标准，就flush一下</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;io.file.autosync &amp;&amp;</span><br><span class="line">        r-&gt;io.file.buffered &gt;= r-&gt;io.file.autosync)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">fflush</span>(r-&gt;io.file.fp);</span><br><span class="line">        <span class="built_in">redis_fsync</span>(<span class="built_in">fileno</span>(r-&gt;io.file.fp)); <span class="comment">// fdatasync(fileno(r-&gt;io.file.fp))，这是为了彻底将数据写入到文件</span></span><br><span class="line">        r-&gt;io.file.buffered = <span class="number">0</span>;		   <span class="comment">// 置0</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rioFileRead"><a href="#rioFileRead" class="headerlink" title="rioFileRead"></a>rioFileRead</h4><p>读取，则直接调用 <code>fread</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Returns 1 or 0 for success/failure. */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">size_t</span> <span class="title">rioFileRead</span><span class="params">(rio *r, <span class="type">void</span> *buf, <span class="type">size_t</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">fread</span>(buf,len,<span class="number">1</span>,r-&gt;io.file.fp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="rioConnIO"><a href="#rioConnIO" class="headerlink" title="rioConnIO"></a>rioConnIO</h3><p><code>rioConnIO</code> 是基于<code>socket</code> 实现的 <code>rio</code>对象，也有相应的读写函数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> rio rioConnIO = &#123;</span><br><span class="line">    rioConnRead,</span><br><span class="line">    rioConnWrite,</span><br><span class="line">    rioConnTell,</span><br><span class="line">    rioConnFlush,</span><br><span class="line">    <span class="literal">NULL</span>,           <span class="comment">/* update_checksum */</span></span><br><span class="line">    <span class="number">0</span>,              <span class="comment">/* current checksum */</span></span><br><span class="line">    <span class="number">0</span>,              <span class="comment">/* flags */</span></span><br><span class="line">    <span class="number">0</span>,              <span class="comment">/* bytes read or written */</span></span><br><span class="line">    <span class="number">0</span>,              <span class="comment">/* read/write chunk size */</span></span><br><span class="line">    &#123; &#123; <span class="literal">NULL</span>, <span class="number">0</span> &#125; &#125; <span class="comment">/* union for io-specific vars */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="rioInitWithConn"><a href="#rioInitWithConn" class="headerlink" title="rioInitWithConn"></a>rioInitWithConn</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// socketfd</span></span><br><span class="line"><span class="keyword">struct</span> &#123;</span><br><span class="line">    connection* conn;   <span class="comment">/* Connection */</span></span><br><span class="line">    <span class="type">off_t</span> pos;          <span class="comment">/* pos in buf that was returned */</span>					<span class="comment">// 当前在buf的读取位置</span></span><br><span class="line">    sds   buf;          <span class="comment">/* buffered data */</span>             					<span class="comment">// 读缓冲区</span></span><br><span class="line">    <span class="type">size_t</span> read_limit;  <span class="comment">/* don&#x27;t allow to buffer/read more than that */</span>       <span class="comment">// 从 rioConnIO 中读取字节数限制</span></span><br><span class="line">    <span class="type">size_t</span> read_so_far; <span class="comment">/* amount of data read from the rio (not buffered) */</span> <span class="comment">// 从 rioConnIO 中已读取字节数</span></span><br><span class="line">&#125; conn;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">rioInitWithConn</span><span class="params">(rio *r, connection *conn, <span class="type">size_t</span> read_limit)</span> </span>&#123;</span><br><span class="line">    *r = rioConnIO;</span><br><span class="line">    r-&gt;io.conn.conn = conn;</span><br><span class="line">    r-&gt;io.conn.pos = <span class="number">0</span>;</span><br><span class="line">    r-&gt;io.conn.read_limit = read_limit;</span><br><span class="line">    r-&gt;io.conn.read_so_far = <span class="number">0</span>;</span><br><span class="line">    r-&gt;io.conn.buf = <span class="built_in">sdsnewlen</span>(<span class="literal">NULL</span>, PROTO_IOBUF_LEN);</span><br><span class="line">    <span class="built_in">sdsclear</span>(r-&gt;io.conn.buf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rioFreeConn"><a href="#rioFreeConn" class="headerlink" title="rioFreeConn"></a>rioFreeConn</h4><p>释放内存，输入参数 <code>reamining</code> 决定是否保留 <code>r-&gt;io.conn.buf</code>的剩余空间</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">rioFreeConn</span><span class="params">(rio *r, sds *remaining)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (remaining &amp;&amp; (<span class="type">size_t</span>)r-&gt;io.conn.pos &lt; <span class="built_in">sdslen</span>(r-&gt;io.conn.buf)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (r-&gt;io.conn.pos &gt; <span class="number">0</span>) </span><br><span class="line">            <span class="built_in">sdsrange</span>(r-&gt;io.conn.buf, r-&gt;io.conn.pos, <span class="number">-1</span>);</span><br><span class="line">        <span class="comment">// 将剩余空间，返回给 remaining</span></span><br><span class="line">        *remaining = r-&gt;io.conn.buf;   </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 直接释放内存了</span></span><br><span class="line">        <span class="built_in">sdsfree</span>(r-&gt;io.conn.buf);</span><br><span class="line">        <span class="keyword">if</span> (remaining) </span><br><span class="line">            *remaining = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    r-&gt;io.conn.buf = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rioConnWrite"><a href="#rioConnWrite" class="headerlink" title="rioConnWrite"></a>rioConnWrite</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 没有写实现</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">size_t</span> <span class="title">rioConnWrite</span><span class="params">(rio *r, <span class="type">const</span> <span class="type">void</span> *buf, <span class="type">size_t</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">UNUSED</span>(r);</span><br><span class="line">    <span class="built_in">UNUSED</span>(buf);</span><br><span class="line">    <span class="built_in">UNUSED</span>(len);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">/* Error, this target does not yet support writing. */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rioConnRead"><a href="#rioConnRead" class="headerlink" title="rioConnRead"></a>rioConnRead</h4><p>要从 <code>r-&gt;io.conn.buf</code> 中读取<code>len</code>个字节，整个流程步骤如下</p>
<ol>
<li><p>先看 <code>r-&gt;io.conn.buf</code> 当前的空间容量是否满足 <code>len</code>个字节，如果不满足，则需要扩容</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">sdslen</span>(r-&gt;io.conn.buf) + <span class="built_in">sdsavail</span>(r-&gt;io.conn.buf) &lt; len)</span><br><span class="line">    r-&gt;io.conn.buf = <span class="built_in">sdsMakeRoomFor</span>(r-&gt;io.conn.buf, len - <span class="built_in">sdslen</span>(r-&gt;io.conn.buf));</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果 <code>r-&gt;io.conn.buf</code>中的剩余可读字节少于 <code>len</code>，并且加上剩余可用空间后也小于 <code>len</code>，则说明 <code>r-&gt;io.conn.buf</code>内存不足，则调整  <code>r-&gt;io.conn.buf</code>及 <code>r-&gt;io.conn.pos</code>，为后面从 <code>r-&gt;io.conn</code>接受数据准备</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (avail &lt; len &amp;&amp; <span class="built_in">sdsavail</span>(r-&gt;io.conn.buf) &lt; len - avail) &#123;</span><br><span class="line">    <span class="built_in">sdsrange</span>(r-&gt;io.conn.buf, r-&gt;io.conn.pos, <span class="number">-1</span>);</span><br><span class="line">    r-&gt;io.conn.pos = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果 <code>len</code> 中的可读字节数小于 <code>len</code>，则不断地从 <code>r-&gt;io.conn</code> 接受数据，填充到 <code>r-&gt;io.conn.buf</code>，直至可读字节满足<code>len</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (len &gt; sdslen(r-&gt;io.conn.buf) - r-&gt;io.conn.pos) &#123; <span class="comment">/****/</span> &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>可读字节数 <code>sdslen(r-&gt;io.conn.buf) - r-&gt;io.conn.pos</code>  满足 <code>len</code> 个字节，则可以将数据复制到 <code>buf</code>中</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 数据满足了，将 r-&gt;io.conn.buf的可读字节数复制到 buf 只能</span></span><br><span class="line"><span class="built_in">memcpy</span>(buf, (<span class="type">char</span>*)r-&gt;io.conn.buf + r-&gt;io.conn.pos, len);</span><br><span class="line">r-&gt;io.conn.read_so_far += len;</span><br><span class="line">r-&gt;io.conn.pos += len;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>完整的过程如下</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> PROTO_IOBUF_LEN         (1024*16)  <span class="comment">/* Generic I/O buffer size */</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">size_t</span> <span class="title">rioConnRead</span><span class="params">(rio *r, <span class="type">void</span> *buf, <span class="type">size_t</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="type">size_t</span> avail = <span class="built_in">sdslen</span>(r-&gt;io.conn.buf)-r-&gt;io.conn.pos; <span class="comment">// 剩余可读字节数</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* If the buffer is too small for the entire request: realloc. */</span></span><br><span class="line">    <span class="comment">// 如果 r 缓冲区总的长度都是小于 len</span></span><br><span class="line">    <span class="comment">// 就需要realloc，使其容量是 len</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">sdslen</span>(r-&gt;io.conn.buf) + <span class="built_in">sdsavail</span>(r-&gt;io.conn.buf) &lt; len)</span><br><span class="line">        r-&gt;io.conn.buf = <span class="built_in">sdsMakeRoomFor</span>(r-&gt;io.conn.buf, len - <span class="built_in">sdslen</span>(r-&gt;io.conn.buf));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* If the remaining unused buffer is not large enough: memmove so that we</span></span><br><span class="line"><span class="comment">     * can read the rest. </span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * 如果剩余可读字节数 avail 小于 len，加上 buf 中剩余空间还是小于 len</span></span><br><span class="line"><span class="comment">     * 则调整 pos， 以及buf的start</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (avail &lt; len &amp;&amp; <span class="built_in">sdsavail</span>(r-&gt;io.conn.buf) &lt; len - avail) &#123;</span><br><span class="line">        <span class="built_in">sdsrange</span>(r-&gt;io.conn.buf, r-&gt;io.conn.pos, <span class="number">-1</span>);</span><br><span class="line">        r-&gt;io.conn.pos = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* If we don&#x27;t already have all the data in the sds, read more */</span></span><br><span class="line">    <span class="comment">// while循环连续的从 r-&gt;io.conn 中读取数据，直到 r-&gt;io.conn.buf 中可取字节数大于等于 len</span></span><br><span class="line">    <span class="comment">// r-&gt;io.conn.pos 不变</span></span><br><span class="line">    <span class="keyword">while</span> (len &gt; <span class="built_in">sdslen</span>(r-&gt;io.conn.buf) - r-&gt;io.conn.pos) &#123;</span><br><span class="line">        <span class="type">size_t</span> buffered = <span class="built_in">sdslen</span>(r-&gt;io.conn.buf) - r-&gt;io.conn.pos; <span class="comment">// 当前剩余可读字节</span></span><br><span class="line">        <span class="type">size_t</span> toread = len - buffered;                            <span class="comment">// 还需要再读取的字节数</span></span><br><span class="line">     </span><br><span class="line">        <span class="comment">/* Read either what&#x27;s missing, or PROTO_IOBUF_LEN, the bigger of the two. */</span></span><br><span class="line">        <span class="keyword">if</span> (toread &lt; PROTO_IOBUF_LEN) toread = PROTO_IOBUF_LEN;    <span class="comment">// 按照大的来</span></span><br><span class="line">        <span class="comment">// 确保待读取字节数 toread 不会超过 r-&gt;io.conn.buf 的剩余空间</span></span><br><span class="line">        <span class="keyword">if</span> (toread &gt; <span class="built_in">sdsavail</span>(r-&gt;io.conn.buf)) toread = <span class="built_in">sdsavail</span>(r-&gt;io.conn.buf);  </span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (r-&gt;io.conn.read_limit != <span class="number">0</span> &amp;&amp;</span><br><span class="line">            r-&gt;io.conn.read_so_far + buffered + toread &gt; r-&gt;io.conn.read_limit)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 在没有读取 toread 个字节之前，还没超出限制</span></span><br><span class="line">            <span class="keyword">if</span> (r-&gt;io.conn.read_limit &gt;= r-&gt;io.conn.read_so_far - buffered)</span><br><span class="line">                <span class="comment">// 在没有出限制的情况下，最大可读字节数</span></span><br><span class="line">                toread = r-&gt;io.conn.read_limit - r-&gt;io.conn.read_so_far - buffered; </span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 否则，超出限制则溢出错误</span></span><br><span class="line">                errno = EOVERFLOW;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 从 conn 中读取字节，填充到 io-&gt;conn.buf</span></span><br><span class="line">        <span class="type">int</span> retval = <span class="built_in">connRead</span>(r-&gt;io.conn.conn,</span><br><span class="line">                              (<span class="type">char</span>*)r-&gt;io.conn.buf + <span class="built_in">sdslen</span>(r-&gt;io.conn.buf),</span><br><span class="line">                              toread);</span><br><span class="line">        <span class="keyword">if</span> (retval &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (errno == EWOULDBLOCK) </span><br><span class="line">                errno = ETIMEDOUT;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">sdsIncrLen</span>(r-&gt;io.conn.buf, retval);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 数据满足了，将 r-&gt;io.conn.buf的可读字节数复制到 buf 只能</span></span><br><span class="line">    <span class="built_in">memcpy</span>(buf, (<span class="type">char</span>*)r-&gt;io.conn.buf + r-&gt;io.conn.pos, len);</span><br><span class="line">    r-&gt;io.conn.read_so_far += len;		<span class="comment">// 每次从 rioConnIO 读写的字节数</span></span><br><span class="line">    r-&gt;io.conn.pos += len;			   <span class="comment">// 更新在读 buf 的位置 </span></span><br><span class="line">    <span class="keyword">return</span> len;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="rioFdIO"><a href="#rioFdIO" class="headerlink" title="rioFdIO"></a>rioFdIO</h3><p>不同于 <code>rioFileIO</code>，这是以文件描述符 <code>fd</code>为接口。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> rio rioFdIO = &#123;</span><br><span class="line">    rioFdRead,</span><br><span class="line">    rioFdWrite,</span><br><span class="line">    rioFdTell,</span><br><span class="line">    rioFdFlush,</span><br><span class="line">    <span class="literal">NULL</span>,           <span class="comment">/* update_checksum */</span></span><br><span class="line">    <span class="number">0</span>,              <span class="comment">/* current checksum */</span></span><br><span class="line">    <span class="number">0</span>,              <span class="comment">/* flags */</span></span><br><span class="line">    <span class="number">0</span>,              <span class="comment">/* bytes read or written */</span></span><br><span class="line">    <span class="number">0</span>,              <span class="comment">/* read/write chunk size */</span></span><br><span class="line">    &#123; &#123; <span class="literal">NULL</span>, <span class="number">0</span> &#125; &#125; <span class="comment">/* union for io-specific vars */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="rioInitWithFd"><a href="#rioInitWithFd" class="headerlink" title="rioInitWithFd"></a>rioInitWithFd</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 文件fd</span></span><br><span class="line"><span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="type">int</span> fd;       <span class="comment">/* File descriptor. */</span></span><br><span class="line">    <span class="type">off_t</span> pos;	 <span class="comment">// 不是buf的当前写字节数，而是一共写入fd的字节数</span></span><br><span class="line">    sds buf;</span><br><span class="line">&#125; fd;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">rioInitWithFd</span><span class="params">(rio *r, <span class="type">int</span> fd)</span> </span>&#123;</span><br><span class="line">    *r = rioFdIO;</span><br><span class="line">    r-&gt;io.fd.fd = fd;</span><br><span class="line">    r-&gt;io.fd.pos = <span class="number">0</span>;</span><br><span class="line">    r-&gt;io.fd.buf = <span class="built_in">sdsempty</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>rioFdIO</code>中，读写都要先通过 <code>io-&gt;fd.buf</code>，即写数据先写入 <code>io-&gt;fd.buf</code>，相当于实现了<code>fp</code>类型的文件流。</p>
<h4 id="rioFreeFd"><a href="#rioFreeFd" class="headerlink" title="rioFreeFd"></a>rioFreeFd</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* release the rio stream. */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">rioFreeFd</span><span class="params">(rio *r)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">sdsfree</span>(r-&gt;io.fd.buf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rioFdWrite"><a href="#rioFdWrite" class="headerlink" title="rioFdWrite"></a>rioFdWrite</h4><p>将<code>buf</code>中的数据写入文件 <code>rioFdIO</code>。涉及到写，则可能需要<code>flush</code>。</p>
<ol>
<li><p>写操作，是先将数据写入到缓冲区 <code>io-&gt;fd.buf</code> 。要根据<code>buf</code>中长度 <code>len</code>，查看是否需要先对 <code>io-&gt;fd.buf</code> 先执行一次<code>flush</code></p>
<ul>
<li><p>如果<code> len &gt;  PROTO_IOBUF_LEN</code>，则直接先将   <code>io-&gt;fd.buf</code>  中的数据发送出去，即<code>flush</code>一次</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 如果len很大，先flush</span></span><br><span class="line"><span class="keyword">if</span> (len &gt; PROTO_IOBUF_LEN) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">sdslen</span>(r-&gt;io.fd.buf)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">rioFdWrite</span>(r, <span class="literal">NULL</span>, <span class="number">0</span>) == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>否则，就将<code>buf</code>数据添加到 <code>io-&gt;fd.buf</code>中，再查看是否需要 <code>flush</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (len) &#123;</span><br><span class="line">    r-&gt;io.fd.buf = <span class="built_in">sdscatlen</span>(r-&gt;io.fd.buf, buf, len); <span class="comment">// 直接添加到内部缓冲区</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">sdslen</span>(r-&gt;io.fd.buf) &gt; PROTO_IOBUF_LEN)		  <span class="comment">// 超过限制，也flush</span></span><br><span class="line">        doflush = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (!doflush)								   <span class="comment">// 不 flush，则直接返回</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 说明需要flush</span></span><br><span class="line">    <span class="comment">// len==0 也是直接到此</span></span><br><span class="line">    p = (<span class="type">unsigned</span> <span class="type">char</span>*) r-&gt;io.fd.buf;</span><br><span class="line">    len = <span class="built_in">sdslen</span>(r-&gt;io.fd.buf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>运行至此，说明需要将 <code>io-&gt;fd.buf</code>中的数据发送出去了</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">size_t</span> nwritten = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span>(nwritten != len) &#123;</span><br><span class="line">      retval = <span class="built_in">write</span>(r-&gt;io.fd.fd,p+nwritten,len-nwritten);</span><br><span class="line">      <span class="keyword">if</span> (retval &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="comment">/* With blocking io, which is the sole user of this</span></span><br><span class="line"><span class="comment">           * rio target, EWOULDBLOCK is returned only because of</span></span><br><span class="line"><span class="comment">           * the SO_SNDTIMEO socket option, so we translate the error</span></span><br><span class="line"><span class="comment">           * into one more recognizable by the user. */</span></span><br><span class="line">          <span class="keyword">if</span> (retval == <span class="number">-1</span> &amp;&amp; errno == EWOULDBLOCK) </span><br><span class="line">              errno = ETIMEDOUT;</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">/* error. */</span></span><br><span class="line">      &#125;</span><br><span class="line">      nwritten += retval;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>更新参数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">r-&gt;io.fd.pos += len;   	<span class="comment">// 总写入字节数</span></span><br><span class="line"><span class="built_in">sdsclear</span>(r-&gt;io.fd.buf);</span><br></pre></td></tr></table></figure></li>
</ol>
<p>完整的流程如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">size_t</span> <span class="title">rioFdWrite</span><span class="params">(rio *r, <span class="type">const</span> <span class="type">void</span> *buf, <span class="type">size_t</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="type">ssize_t</span> retval;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *p = (<span class="type">unsigned</span> <span class="type">char</span>*) buf;</span><br><span class="line">    <span class="type">int</span> doflush = (buf == <span class="literal">NULL</span> &amp;&amp; len == <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* For small writes, we rather keep the data in user-space buffer, and flush</span></span><br><span class="line"><span class="comment">     * it only when it grows. however for larger writes, we prefer to flush</span></span><br><span class="line"><span class="comment">     * any pre-existing buffer, and write the new one directly without reallocs</span></span><br><span class="line"><span class="comment">     * and memory copying. */</span></span><br><span class="line">    <span class="keyword">if</span> (len &gt; PROTO_IOBUF_LEN) &#123;</span><br><span class="line">        <span class="comment">/* First, flush any pre-existing buffered data. */</span></span><br><span class="line">        <span class="comment">// 如果数据很大，1直接flush</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">sdslen</span>(r-&gt;io.fd.buf)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">rioFdWrite</span>(r, <span class="literal">NULL</span>, <span class="number">0</span>) == <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* Write the new data, keeping &#x27;p&#x27; and &#x27;len&#x27; from the input. */</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (len) &#123;</span><br><span class="line">            <span class="comment">// 否则是直接将数据添加到缓冲区 r-&gt;io.fd.buf</span></span><br><span class="line">            r-&gt;io.fd.buf = <span class="built_in">sdscatlen</span>(r-&gt;io.fd.buf, buf, len);</span><br><span class="line">            <span class="comment">// 超过限制，也flush</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">sdslen</span>(r-&gt;io.fd.buf) &gt; PROTO_IOBUF_LEN)</span><br><span class="line">                doflush = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (!doflush)</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 说明需要flush</span></span><br><span class="line">        <span class="comment">// len==0 也是直接到此</span></span><br><span class="line">        <span class="comment">/* Flusing the buffered data. set &#x27;p&#x27; and &#x27;len&#x27; accordintly. */</span></span><br><span class="line">        p = (<span class="type">unsigned</span> <span class="type">char</span>*) r-&gt;io.fd.buf;</span><br><span class="line">        len = <span class="built_in">sdslen</span>(r-&gt;io.fd.buf);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> nwritten = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(nwritten != len) &#123;</span><br><span class="line">        retval = <span class="built_in">write</span>(r-&gt;io.fd.fd,p+nwritten,len-nwritten);</span><br><span class="line">        <span class="keyword">if</span> (retval &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">/* With blocking io, which is the sole user of this</span></span><br><span class="line"><span class="comment">             * rio target, EWOULDBLOCK is returned only because of</span></span><br><span class="line"><span class="comment">             * the SO_SNDTIMEO socket option, so we translate the error</span></span><br><span class="line"><span class="comment">             * into one more recognizable by the user. */</span></span><br><span class="line">            <span class="keyword">if</span> (retval == <span class="number">-1</span> &amp;&amp; errno == EWOULDBLOCK) </span><br><span class="line">                errno = ETIMEDOUT;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">/* error. */</span></span><br><span class="line">        &#125;</span><br><span class="line">        nwritten += retval;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    r-&gt;io.fd.pos += len; </span><br><span class="line">    <span class="built_in">sdsclear</span>(r-&gt;io.fd.buf);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rioFdRead"><a href="#rioFdRead" class="headerlink" title="rioFdRead"></a>rioFdRead</h4><p>没有实现读，即不支持读</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Returns 1 or 0 for success/failure. */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">size_t</span> <span class="title">rioFdRead</span><span class="params">(rio *r, <span class="type">void</span> *buf, <span class="type">size_t</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">UNUSED</span>(r);</span><br><span class="line">    <span class="built_in">UNUSED</span>(buf);</span><br><span class="line">    <span class="built_in">UNUSED</span>(len);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">/* Error, this target does not support reading. */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rioFdTell"><a href="#rioFdTell" class="headerlink" title="rioFdTell"></a>rioFdTell</h4><p>总的已读字节数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Returns read/write position in file. */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">off_t</span> <span class="title">rioFdTell</span><span class="params">(rio *r)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> r-&gt;io.fd.pos;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="rioGenericUpdateChecksum"><a href="#rioGenericUpdateChecksum" class="headerlink" title="rioGenericUpdateChecksum"></a>rioGenericUpdateChecksum</h3><p>校验和计算函数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 用于计算校验和，可以用于使用在内部和文件流中</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">rioGenericUpdateChecksum</span><span class="params">(rio *r, <span class="type">const</span> <span class="type">void</span> *buf, <span class="type">size_t</span> len)</span> </span>&#123;</span><br><span class="line">    r-&gt;cksum = <span class="built_in">crc64</span>(r-&gt;cksum,buf,len);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="W-R"><a href="#W-R" class="headerlink" title="W &amp; R"></a>W &amp; R</h2><h3 id="Error"><a href="#Error" class="headerlink" title="Error"></a>Error</h3><p>读写有两种错误，在 <code>rioWrite</code>和 <code>rioRead</code>发生错误时设置。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> RIO_FLAG_READ_ERROR  (1&lt;&lt;0)	  	<span class="comment">// 读错误</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RIO_FLAG_WRITE_ERROR (1&lt;&lt;1)		<span class="comment">// 写错误</span></span></span><br></pre></td></tr></table></figure>

<p>对错误标志位获取及改变</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> <span class="title">rioGetReadError</span><span class="params">(rio *r)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (r-&gt;flags &amp; RIO_FLAG_READ_ERROR) != <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Like rioGetReadError() but for write errors. */</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> <span class="title">rioGetWriteError</span><span class="params">(rio *r)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (r-&gt;flags &amp; RIO_FLAG_WRITE_ERROR) != <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title">rioClearErrors</span><span class="params">(rio *r)</span> </span>&#123;</span><br><span class="line">    r-&gt;flags &amp;= ~(RIO_FLAG_READ_ERROR|RIO_FLAG_WRITE_ERROR);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="rioWrite"><a href="#rioWrite" class="headerlink" title="rioWrite"></a>rioWrite</h3><p>对写操作的高级封装，<code>r-&gt;write</code>底层是上面四种不同IO接口的其中之一。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">size_t</span> <span class="title">rioWrite</span><span class="params">(rio *r, <span class="type">const</span> <span class="type">void</span> *buf, <span class="type">size_t</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (r-&gt;flags &amp; RIO_FLAG_WRITE_ERROR) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (len) &#123;</span><br><span class="line">        <span class="comment">// 单次最大写字节数</span></span><br><span class="line">        <span class="type">size_t</span> bytes_to_write = (r-&gt;max_processing_chunk &amp;&amp; r-&gt;max_processing_chunk &lt; len) ? </span><br><span class="line">                                 r-&gt;max_processing_chunk : </span><br><span class="line">                                 len;</span><br><span class="line">        <span class="comment">// 是否有校验和函数</span></span><br><span class="line">        <span class="keyword">if</span> (r-&gt;update_cksum) </span><br><span class="line">            r-&gt;<span class="built_in">update_cksum</span>(r, buf, bytes_to_write);</span><br><span class="line">        <span class="keyword">if</span> (r-&gt;<span class="built_in">write</span>(r, buf, bytes_to_write) == <span class="number">0</span>) &#123;</span><br><span class="line">            r-&gt;flags |= RIO_FLAG_WRITE_ERROR; </span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        buf = (<span class="type">char</span>*)buf + bytes_to_write; </span><br><span class="line">        len -= bytes_to_write;</span><br><span class="line">        r-&gt;processed_bytes += bytes_to_write;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rdbWriteRaw"><a href="#rdbWriteRaw" class="headerlink" title="rdbWriteRaw"></a>rdbWriteRaw</h4><p><code>rdbWriteRaw</code>函数，在 <code>rdb.c</code> 中广泛使用，是 <code>rioWrite</code>的一个<code>Wrapper</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">rdbWriteRaw</span><span class="params">(rio *rdb, <span class="type">void</span> *p, <span class="type">size_t</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (rdb &amp;&amp; <span class="built_in">rioWrite</span>(rdb, p,len) == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">return</span> len;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="rioRead"><a href="#rioRead" class="headerlink" title="rioRead"></a>rioRead</h3><p>读操作也个高级封装</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">size_t</span> <span class="title">rioRead</span><span class="params">(rio *r, <span class="type">void</span> *buf, <span class="type">size_t</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (r-&gt;flags &amp; RIO_FLAG_READ_ERROR) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (len) &#123;</span><br><span class="line">        <span class="type">size_t</span> bytes_to_read = (r-&gt;max_processing_chunk &amp;&amp; r-&gt;max_processing_chunk &lt; len) ?</span><br><span class="line">                                r-&gt;max_processing_chunk : </span><br><span class="line">                                len;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (r-&gt;<span class="built_in">read</span>(r, buf, bytes_to_read) == <span class="number">0</span>) &#123;</span><br><span class="line">            r-&gt;flags |= RIO_FLAG_READ_ERROR;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (r-&gt;update_cksum) </span><br><span class="line">            r-&gt;<span class="built_in">update_cksum</span>(r, buf, bytes_to_read);</span><br><span class="line"></span><br><span class="line">        buf = (<span class="type">char</span>*)buf + bytes_to_read;   <span class="comment">// 更新到末尾  </span></span><br><span class="line">        len -= bytes_to_read;</span><br><span class="line">        r-&gt;processed_bytes += bytes_to_read;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives">archives</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#RIO"><span class="toc-number">1.</span> <span class="toc-text">RIO</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#rioBufferIO"><span class="toc-number">1.1.</span> <span class="toc-text">rioBufferIO</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#rioInitWithBuffer"><span class="toc-number">1.1.1.</span> <span class="toc-text">rioInitWithBuffer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rioBufferWrite"><span class="toc-number">1.1.2.</span> <span class="toc-text">rioBufferWrite</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rioBufferRead"><span class="toc-number">1.1.3.</span> <span class="toc-text">rioBufferRead</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rioBufferTell"><span class="toc-number">1.1.4.</span> <span class="toc-text">rioBufferTell</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rioBufferFlush"><span class="toc-number">1.1.5.</span> <span class="toc-text">rioBufferFlush</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rioFileIO"><span class="toc-number">1.2.</span> <span class="toc-text">rioFileIO</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#rioInitWithFile"><span class="toc-number">1.2.1.</span> <span class="toc-text">rioInitWithFile</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#rioSetAutoSync"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">rioSetAutoSync</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rioFileWrite"><span class="toc-number">1.2.2.</span> <span class="toc-text">rioFileWrite</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rioFileRead"><span class="toc-number">1.2.3.</span> <span class="toc-text">rioFileRead</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rioConnIO"><span class="toc-number">1.3.</span> <span class="toc-text">rioConnIO</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#rioInitWithConn"><span class="toc-number">1.3.1.</span> <span class="toc-text">rioInitWithConn</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rioFreeConn"><span class="toc-number">1.3.2.</span> <span class="toc-text">rioFreeConn</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rioConnWrite"><span class="toc-number">1.3.3.</span> <span class="toc-text">rioConnWrite</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rioConnRead"><span class="toc-number">1.3.4.</span> <span class="toc-text">rioConnRead</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rioFdIO"><span class="toc-number">1.4.</span> <span class="toc-text">rioFdIO</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#rioInitWithFd"><span class="toc-number">1.4.1.</span> <span class="toc-text">rioInitWithFd</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rioFreeFd"><span class="toc-number">1.4.2.</span> <span class="toc-text">rioFreeFd</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rioFdWrite"><span class="toc-number">1.4.3.</span> <span class="toc-text">rioFdWrite</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rioFdRead"><span class="toc-number">1.4.4.</span> <span class="toc-text">rioFdRead</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rioFdTell"><span class="toc-number">1.4.5.</span> <span class="toc-text">rioFdTell</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rioGenericUpdateChecksum"><span class="toc-number">1.5.</span> <span class="toc-text">rioGenericUpdateChecksum</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#W-R"><span class="toc-number">2.</span> <span class="toc-text">W &amp; R</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Error"><span class="toc-number">2.1.</span> <span class="toc-text">Error</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rioWrite"><span class="toc-number">2.2.</span> <span class="toc-text">rioWrite</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#rdbWriteRaw"><span class="toc-number">2.2.1.</span> <span class="toc-text">rdbWriteRaw</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rioRead"><span class="toc-number">2.3.</span> <span class="toc-text">rioRead</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://szza.github.io/2021/01/27/Redis/%E6%8C%81%E4%B9%85%E5%8C%96/RIO/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://szza.github.io/2021/01/27/Redis/%E6%8C%81%E4%B9%85%E5%8C%96/RIO/&text=剖析REDIS的rio"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://szza.github.io/2021/01/27/Redis/%E6%8C%81%E4%B9%85%E5%8C%96/RIO/&title=剖析REDIS的rio"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://szza.github.io/2021/01/27/Redis/%E6%8C%81%E4%B9%85%E5%8C%96/RIO/&is_video=false&description=剖析REDIS的rio"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=剖析REDIS的rio&body=Check out this article: https://szza.github.io/2021/01/27/Redis/%E6%8C%81%E4%B9%85%E5%8C%96/RIO/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://szza.github.io/2021/01/27/Redis/%E6%8C%81%E4%B9%85%E5%8C%96/RIO/&title=剖析REDIS的rio"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://szza.github.io/2021/01/27/Redis/%E6%8C%81%E4%B9%85%E5%8C%96/RIO/&title=剖析REDIS的rio"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://szza.github.io/2021/01/27/Redis/%E6%8C%81%E4%B9%85%E5%8C%96/RIO/&title=剖析REDIS的rio"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://szza.github.io/2021/01/27/Redis/%E6%8C%81%E4%B9%85%E5%8C%96/RIO/&title=剖析REDIS的rio"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://szza.github.io/2021/01/27/Redis/%E6%8C%81%E4%B9%85%E5%8C%96/RIO/&name=剖析REDIS的rio&description=&lt;p&gt;RIO为读写流提供了统一的接口&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;不仅可以用于读写RDB、AOF，实现持久化&lt;/li&gt;
&lt;li&gt;也可以用于读写socket与pipe，实现主从同步任务&lt;/li&gt;
&lt;/ul&gt;"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://szza.github.io/2021/01/27/Redis/%E6%8C%81%E4%B9%85%E5%8C%96/RIO/&t=剖析REDIS的rio"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2021-2023
    fibonaccii
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives">archives</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

    <script async src="https://www.googletagmanager.com/gtag/js?id=szza"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'szza');
    </script>

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->


</body>
</html>
