<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="目录 概述 搜索任务入口 Segment 搜索执行 SearchRequest 和 Plan 参数 Segment Search 内部执行 结果归约（Reduce） 高级搜索（Advanced Search） 完整流程总结   概述本文档全面分析 Milvus 的搜索流程，从 QueryNode 接收搜索请求开始，到返回最终结果为止。涵盖搜索任务的执行、segment 搜索、计划节点执行、结果归约">
<meta property="og:type" content="article">
<meta property="og:title" content="Milvus 搜索流程全面分析">
<meta property="og:url" content="https://szza.github.io/2025/08/10/Milvus/19_search_flow_comprehensive_analysis/index.html">
<meta property="og:site_name" content="szza">
<meta property="og:description" content="目录 概述 搜索任务入口 Segment 搜索执行 SearchRequest 和 Plan 参数 Segment Search 内部执行 结果归约（Reduce） 高级搜索（Advanced Search） 完整流程总结   概述本文档全面分析 Milvus 的搜索流程，从 QueryNode 接收搜索请求开始，到返回最终结果为止。涵盖搜索任务的执行、segment 搜索、计划节点执行、结果归约">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-08-10T08:00:00.000Z">
<meta property="article:modified_time" content="2026-01-06T13:10:38.776Z">
<meta property="article:author" content="fibonaccii">
<meta property="article:tag" content="Milvus">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/id.jpg">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/id.jpg" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/id.jpg">
        
      
    
    <!-- title -->
    <title>Milvus 搜索流程全面分析</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="szza" type="application/atom+xml">
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives">archives</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" href="/2025/08/10/Milvus/18_why_reduce_search_results/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://szza.github.io/2025/08/10/Milvus/19_search_flow_comprehensive_analysis/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://szza.github.io/2025/08/10/Milvus/19_search_flow_comprehensive_analysis/&text=Milvus 搜索流程全面分析"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://szza.github.io/2025/08/10/Milvus/19_search_flow_comprehensive_analysis/&title=Milvus 搜索流程全面分析"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://szza.github.io/2025/08/10/Milvus/19_search_flow_comprehensive_analysis/&is_video=false&description=Milvus 搜索流程全面分析"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Milvus 搜索流程全面分析&body=Check out this article: https://szza.github.io/2025/08/10/Milvus/19_search_flow_comprehensive_analysis/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://szza.github.io/2025/08/10/Milvus/19_search_flow_comprehensive_analysis/&title=Milvus 搜索流程全面分析"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://szza.github.io/2025/08/10/Milvus/19_search_flow_comprehensive_analysis/&title=Milvus 搜索流程全面分析"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://szza.github.io/2025/08/10/Milvus/19_search_flow_comprehensive_analysis/&title=Milvus 搜索流程全面分析"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://szza.github.io/2025/08/10/Milvus/19_search_flow_comprehensive_analysis/&title=Milvus 搜索流程全面分析"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://szza.github.io/2025/08/10/Milvus/19_search_flow_comprehensive_analysis/&name=Milvus 搜索流程全面分析&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://szza.github.io/2025/08/10/Milvus/19_search_flow_comprehensive_analysis/&t=Milvus 搜索流程全面分析"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95"><span class="toc-number">1.</span> <span class="toc-text">目录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">2.</span> <span class="toc-text">概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2%E6%B5%81%E7%A8%8B%E6%A6%82%E8%A7%88"><span class="toc-number">2.1.</span> <span class="toc-text">搜索流程概览</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2%E4%BB%BB%E5%8A%A1%E5%85%A5%E5%8F%A3"><span class="toc-number">3.</span> <span class="toc-text">搜索任务入口</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-SearchTask-Execute"><span class="toc-number">3.1.</span> <span class="toc-text">1. SearchTask.Execute</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E7%AD%BE%E5%90%8D"><span class="toc-number">3.1.1.</span> <span class="toc-text">函数签名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-number">3.1.2.</span> <span class="toc-text">执行流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E6%AD%A5%E9%AA%A4"><span class="toc-number">3.1.3.</span> <span class="toc-text">关键步骤</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-StreamingSearchTask-Execute"><span class="toc-number">3.2.</span> <span class="toc-text">2. StreamingSearchTask.Execute</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B-1"><span class="toc-number">3.2.1.</span> <span class="toc-text">执行流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%81%E5%BC%8F%E6%90%9C%E7%B4%A2%E7%9A%84%E4%BC%98%E5%8A%BF"><span class="toc-number">3.2.2.</span> <span class="toc-text">流式搜索的优势</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Segment-%E6%90%9C%E7%B4%A2%E6%89%A7%E8%A1%8C"><span class="toc-number">4.</span> <span class="toc-text">Segment 搜索执行</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-searchSegments-%E5%87%BD%E6%95%B0"><span class="toc-number">4.1.</span> <span class="toc-text">1. searchSegments 函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E7%AD%BE%E5%90%8D-1"><span class="toc-number">4.1.1.</span> <span class="toc-text">函数签名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B-2"><span class="toc-number">4.1.2.</span> <span class="toc-text">执行流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E7%89%B9%E6%80%A7"><span class="toc-number">4.1.3.</span> <span class="toc-text">关键特性</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-SearchHistorical-%E5%92%8C-SearchStreaming"><span class="toc-number">4.2.</span> <span class="toc-text">2. SearchHistorical 和 SearchStreaming</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SearchHistorical"><span class="toc-number">4.2.1.</span> <span class="toc-text">SearchHistorical</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SearchStreaming"><span class="toc-number">4.2.2.</span> <span class="toc-text">SearchStreaming</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SearchRequest-%E5%92%8C-Plan-%E5%8F%82%E6%95%B0"><span class="toc-number">5.</span> <span class="toc-text">SearchRequest 和 Plan 参数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-SearchRequest-%E7%BB%93%E6%9E%84"><span class="toc-number">5.1.</span> <span class="toc-text">1. SearchRequest 结构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%93%E6%9E%84%E5%AE%9A%E4%B9%89"><span class="toc-number">5.1.1.</span> <span class="toc-text">结构定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B"><span class="toc-number">5.1.2.</span> <span class="toc-text">创建过程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Plan-%E5%8F%82%E6%95%B0%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">5.2.</span> <span class="toc-text">2. Plan 参数的作用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Plan-%E7%BB%93%E6%9E%84%EF%BC%88C-%EF%BC%89"><span class="toc-number">5.2.1.</span> <span class="toc-text">Plan 结构（C++）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Plan-%E7%9A%84%E6%A0%B8%E5%BF%83%E4%BD%9C%E7%94%A8"><span class="toc-number">5.2.2.</span> <span class="toc-text">Plan 的核心作用</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E6%90%9C%E7%B4%A2%E5%89%8D%E9%AA%8C%E8%AF%81%EF%BC%88check-search%EF%BC%89"><span class="toc-number">5.2.2.1.</span> <span class="toc-text">1. 搜索前验证（check_search）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92%E8%8A%82%E7%82%B9%E6%A0%91"><span class="toc-number">5.2.2.2.</span> <span class="toc-text">2. 执行计划节点树</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E5%A1%AB%E5%85%85%E8%BF%94%E5%9B%9E%E5%AD%97%E6%AE%B5"><span class="toc-number">5.2.2.3.</span> <span class="toc-text">3. 填充返回字段</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Plan-%E7%9A%84%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B"><span class="toc-number">5.2.3.</span> <span class="toc-text">Plan 的创建流程</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Segment-Search-%E5%86%85%E9%83%A8%E6%89%A7%E8%A1%8C"><span class="toc-number">6.</span> <span class="toc-text">Segment Search 内部执行</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-segment-Search-%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-number">6.1.</span> <span class="toc-text">1. segment-&gt;Search 执行流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E7%AD%BE%E5%90%8D-2"><span class="toc-number">6.1.1.</span> <span class="toc-text">函数签名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B-3"><span class="toc-number">6.1.2.</span> <span class="toc-text">执行流程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-ExecPlanNodeVisitor-%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92%E8%8A%82%E7%82%B9%E6%A0%91"><span class="toc-number">6.2.</span> <span class="toc-text">2. ExecPlanNodeVisitor 执行计划节点树</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#visit-VectorPlanNode-node"><span class="toc-number">6.2.1.</span> <span class="toc-text">visit(VectorPlanNode&amp; node)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E8%AE%A1%E5%88%92%E8%8A%82%E7%82%B9%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F"><span class="toc-number">6.3.</span> <span class="toc-text">3. 计划节点执行顺序</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MvccNode-MVCC-%E8%BF%87%E6%BB%A4"><span class="toc-number">6.3.1.</span> <span class="toc-text">MvccNode - MVCC 过滤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#VectorSearchNode-%E5%90%91%E9%87%8F%E6%90%9C%E7%B4%A2-TopK"><span class="toc-number">6.3.2.</span> <span class="toc-text">VectorSearchNode - 向量搜索 + TopK</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#GroupByNode-Group-By-%E6%93%8D%E4%BD%9C"><span class="toc-number">6.3.3.</span> <span class="toc-text">GroupByNode - Group By 操作</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-Segment-Search-%E5%AE%8C%E6%88%90%E7%9A%84%E6%93%8D%E4%BD%9C%E6%80%BB%E7%BB%93"><span class="toc-number">6.4.</span> <span class="toc-text">4. Segment Search 完成的操作总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E6%9E%9C%E5%BD%92%E7%BA%A6%EF%BC%88Reduce%EF%BC%89"><span class="toc-number">7.</span> <span class="toc-text">结果归约（Reduce）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81-Reduce%EF%BC%9F"><span class="toc-number">7.1.</span> <span class="toc-text">1. 为什么需要 Reduce？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-ReduceSearchResults-%E5%87%BD%E6%95%B0"><span class="toc-number">7.2.</span> <span class="toc-text">2. ReduceSearchResults 函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E7%AD%BE%E5%90%8D-3"><span class="toc-number">7.2.1.</span> <span class="toc-text">函数签名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B-4"><span class="toc-number">7.2.2.</span> <span class="toc-text">执行流程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-K-Way-Merge-%E7%AE%97%E6%B3%95"><span class="toc-number">7.3.</span> <span class="toc-text">3. K-Way Merge 算法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%97%E6%B3%95%E5%8E%9F%E7%90%86"><span class="toc-number">7.3.1.</span> <span class="toc-text">算法原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SelectSearchResultData-%E5%87%BD%E6%95%B0"><span class="toc-number">7.3.2.</span> <span class="toc-text">SelectSearchResultData 函数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-Reduce-%E7%9A%84%E5%85%B6%E4%BB%96%E4%BD%9C%E7%94%A8"><span class="toc-number">7.4.</span> <span class="toc-text">4. Reduce 的其他作用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%BB%E9%87%8D%EF%BC%88Deduplication%EF%BC%89"><span class="toc-number">7.4.1.</span> <span class="toc-text">去重（Deduplication）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Group-By-%E5%A4%84%E7%90%86"><span class="toc-number">7.4.2.</span> <span class="toc-text">Group By 处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%88%90%E6%9C%AC%E8%81%9A%E5%90%88"><span class="toc-number">7.4.3.</span> <span class="toc-text">成本聚合</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AB%98%E7%BA%A7%E6%90%9C%E7%B4%A2%EF%BC%88Advanced-Search%EF%BC%89"><span class="toc-number">8.</span> <span class="toc-text">高级搜索（Advanced Search）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-ResultInfo-isAdvance-%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">8.1.</span> <span class="toc-text">1. ResultInfo.isAdvance 的作用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E4%BD%9C%E7%94%A8"><span class="toc-number">8.1.1.</span> <span class="toc-text">核心作用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%A4%E7%A7%8D%E5%BD%92%E7%BA%A6%E7%AD%96%E7%95%A5"><span class="toc-number">8.1.2.</span> <span class="toc-text">两种归约策略</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E6%99%AE%E9%80%9A%E6%90%9C%E7%B4%A2%EF%BC%88isAdvance-false%EF%BC%89"><span class="toc-number">8.1.2.1.</span> <span class="toc-text">1. 普通搜索（isAdvance &#x3D; false）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E9%AB%98%E7%BA%A7%E6%90%9C%E7%B4%A2%EF%BC%88isAdvance-true%EF%BC%89"><span class="toc-number">8.1.2.2.</span> <span class="toc-text">2. 高级搜索（isAdvance &#x3D; true）</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ReduceAdvancedSearchResults-%E5%AE%9E%E7%8E%B0"><span class="toc-number">8.1.3.</span> <span class="toc-text">ReduceAdvancedSearchResults 实现</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4%E6%B5%81%E7%A8%8B%E6%80%BB%E7%BB%93"><span class="toc-number">9.</span> <span class="toc-text">完整流程总结</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%90%9C%E7%B4%A2%E6%B5%81%E7%A8%8B%E6%97%B6%E5%BA%8F%E5%9B%BE"><span class="toc-number">9.1.</span> <span class="toc-text">1. 搜索流程时序图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%85%B3%E9%94%AE%E6%95%B0%E6%8D%AE%E6%B5%81"><span class="toc-number">9.2.</span> <span class="toc-text">2. 关键数据流</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SearchRequest-%E5%88%9B%E5%BB%BA"><span class="toc-number">9.2.1.</span> <span class="toc-text">SearchRequest 创建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Segment-Search-%E6%89%A7%E8%A1%8C"><span class="toc-number">9.2.2.</span> <span class="toc-text">Segment Search 执行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Result-Reduce"><span class="toc-number">9.2.3.</span> <span class="toc-text">Result Reduce</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%80%A7%E8%83%BD%E8%80%83%E8%99%91"><span class="toc-number">9.3.</span> <span class="toc-text">3. 性能考虑</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6"><span class="toc-number">9.3.1.</span> <span class="toc-text">时间复杂度</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5"><span class="toc-number">9.3.2.</span> <span class="toc-text">优化策略</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%85%B3%E9%94%AE%E8%A6%81%E7%82%B9%E6%80%BB%E7%BB%93"><span class="toc-number">9.4.</span> <span class="toc-text">4. 关键要点总结</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Segment-Search-%E5%B1%82%E9%9D%A2"><span class="toc-number">9.4.1.</span> <span class="toc-text">Segment Search 层面</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Reduce-%E5%B1%82%E9%9D%A2"><span class="toc-number">9.4.2.</span> <span class="toc-text">Reduce 层面</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B1%BB%E6%AF%94%E7%90%86%E8%A7%A3"><span class="toc-number">9.4.3.</span> <span class="toc-text">类比理解</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">10.</span> <span class="toc-text">参考资料</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Milvus 搜索流程全面分析
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">fibonaccii</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2025-08-10T08:00:00.000Z" itemprop="datePublished">2025-08-10</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/Milvus/" rel="tag">Milvus</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ol>
<li><a href="#%E6%A6%82%E8%BF%B0">概述</a></li>
<li><a href="#%E6%90%9C%E7%B4%A2%E4%BB%BB%E5%8A%A1%E5%85%A5%E5%8F%A3">搜索任务入口</a></li>
<li><a href="#segment-%E6%90%9C%E7%B4%A2%E6%89%A7%E8%A1%8C">Segment 搜索执行</a></li>
<li><a href="#searchrequest-%E5%92%8C-plan-%E5%8F%82%E6%95%B0">SearchRequest 和 Plan 参数</a></li>
<li><a href="#segment-search-%E5%86%85%E9%83%A8%E6%89%A7%E8%A1%8C">Segment Search 内部执行</a></li>
<li><a href="#%E7%BB%93%E6%9E%9C%E5%BD%92%E7%BA%A6reduce">结果归约（Reduce）</a></li>
<li><a href="#%E9%AB%98%E7%BA%A7%E6%90%9C%E7%B4%A2advanced-search">高级搜索（Advanced Search）</a></li>
<li><a href="#%E5%AE%8C%E6%95%B4%E6%B5%81%E7%A8%8B%E6%80%BB%E7%BB%93">完整流程总结</a></li>
</ol>
<hr>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>本文档全面分析 Milvus 的搜索流程，从 QueryNode 接收搜索请求开始，到返回最终结果为止。涵盖搜索任务的执行、segment 搜索、计划节点执行、结果归约等各个环节。</p>
<h3 id="搜索流程概览"><a href="#搜索流程概览" class="headerlink" title="搜索流程概览"></a>搜索流程概览</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Proxy → QueryNode → SearchTask → SearchSegments → Segment.Search → Reduce → Result</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="搜索任务入口"><a href="#搜索任务入口" class="headerlink" title="搜索任务入口"></a>搜索任务入口</h2><h3 id="1-SearchTask-Execute"><a href="#1-SearchTask-Execute" class="headerlink" title="1. SearchTask.Execute"></a>1. SearchTask.Execute</h3><p><code>SearchTask.Execute</code> 是普通搜索任务的执行入口，负责在 QueryNode 上执行搜索并归约结果。</p>
<h4 id="函数签名"><a href="#函数签名" class="headerlink" title="函数签名"></a>函数签名</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *SearchTask)</span></span> Execute() <span class="type">error</span></span><br></pre></td></tr></table></figure>

<h4 id="执行流程"><a href="#执行流程" class="headerlink" title="执行流程"></a>执行流程</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *SearchTask)</span></span> Execute() <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// 1. 准备搜索请求</span></span><br><span class="line">    err := t.combinePlaceHolderGroups()</span><br><span class="line">    searchReq, err := segcore.NewSearchRequest(t.collection.GetCCollection(), req, t.placeholderGroup)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 根据 Scope 选择搜索历史数据或流式数据</span></span><br><span class="line">    <span class="keyword">if</span> req.GetScope() == querypb.DataScope_Historical &#123;</span><br><span class="line">        results, searchedSegments, err = segments.SearchHistorical(...)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> req.GetScope() == querypb.DataScope_Streaming &#123;</span><br><span class="line">        results, searchedSegments, err = segments.SearchStreaming(...)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. 归约多个 segment 的结果</span></span><br><span class="line">    reducedResult, err := segcore.ReduceSearchResultsAndFillData(...)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. 填充主键和目标字段</span></span><br><span class="line">    err = segments.FillPrimaryKeys(...)</span><br><span class="line">    err = segments.FillTargetEntry(...)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. 编码并返回结果</span></span><br><span class="line">    t.result = EncodeSearchResults(...)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="关键步骤"><a href="#关键步骤" class="headerlink" title="关键步骤"></a>关键步骤</h4><ol>
<li><strong>合并 Placeholder Groups</strong>：将多个查询向量合并成一个 PlaceholderGroup</li>
<li><strong>创建 SearchRequest</strong>：封装搜索计划、PlaceholderGroup、时间戳等信息</li>
<li><strong>搜索 Segments</strong>：根据 Scope 搜索历史或流式 segments</li>
<li><strong>归约结果</strong>：将多个 segment 的结果合并成全局 topK</li>
<li><strong>填充字段</strong>：填充主键和目标字段数据</li>
<li><strong>编码返回</strong>：将结果编码为 protobuf 格式</li>
</ol>
<h3 id="2-StreamingSearchTask-Execute"><a href="#2-StreamingSearchTask-Execute" class="headerlink" title="2. StreamingSearchTask.Execute"></a>2. StreamingSearchTask.Execute</h3><p><code>StreamingSearchTask.Execute</code> 是流式搜索任务的执行入口，支持流式归约，可以边搜索边归约，降低内存占用。</p>
<h4 id="执行流程-1"><a href="#执行流程-1" class="headerlink" title="执行流程"></a>执行流程</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *StreamingSearchTask)</span></span> Execute() <span class="type">error</span> &#123;</span><br><span class="line">    <span class="comment">// 1. 准备搜索请求</span></span><br><span class="line">    t.combinePlaceHolderGroups()</span><br><span class="line">    searchReq, err := segcore.NewSearchRequest(...)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 流式搜索和归约</span></span><br><span class="line">    <span class="keyword">if</span> req.GetScope() == querypb.DataScope_Historical &#123;</span><br><span class="line">        streamReduceFunc := <span class="function"><span class="keyword">func</span><span class="params">(result *segments.SearchResult)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> t.streamReduce(t.ctx, searchReq.Plan(), result, ...)</span><br><span class="line">        &#125;</span><br><span class="line">        pinnedSegments, err := segments.SearchHistoricalStreamly(</span><br><span class="line">            t.ctx, t.segmentManager, searchReq, ..., streamReduceFunc)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. 获取流式归约结果</span></span><br><span class="line">        t.resultBlobs, err = segcore.GetStreamReduceResult(t.ctx, t.streamReducer)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="流式搜索的优势"><a href="#流式搜索的优势" class="headerlink" title="流式搜索的优势"></a>流式搜索的优势</h4><ul>
<li><strong>内存效率</strong>：不需要等待所有 segment 搜索完成，边搜索边归约</li>
<li><strong>延迟优化</strong>：可以更早返回部分结果</li>
<li><strong>适合大数据量</strong>：当 segment 数量很多时，流式处理可以避免内存峰值</li>
</ul>
<hr>
<h2 id="Segment-搜索执行"><a href="#Segment-搜索执行" class="headerlink" title="Segment 搜索执行"></a>Segment 搜索执行</h2><h3 id="1-searchSegments-函数"><a href="#1-searchSegments-函数" class="headerlink" title="1. searchSegments 函数"></a>1. searchSegments 函数</h3><p><code>searchSegments</code> 函数在多个 segment 上并发执行搜索，并收集结果。</p>
<h4 id="函数签名-1"><a href="#函数签名-1" class="headerlink" title="函数签名"></a>函数签名</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">searchSegments</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    ctx context.Context, </span></span></span><br><span class="line"><span class="params"><span class="function">    mgr *Manager, </span></span></span><br><span class="line"><span class="params"><span class="function">    segments []Segment, </span></span></span><br><span class="line"><span class="params"><span class="function">    segType SegmentType, </span></span></span><br><span class="line"><span class="params"><span class="function">    searchReq *SearchRequest)</span></span> ([]*SearchResult, <span class="type">error</span>)</span><br></pre></td></tr></table></figure>

<h4 id="执行流程-2"><a href="#执行流程-2" class="headerlink" title="执行流程"></a>执行流程</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">searchSegments</span><span class="params">(ctx context.Context, mgr *Manager, segments []Segment, </span></span></span><br><span class="line"><span class="params"><span class="function">    segType SegmentType, searchReq *SearchRequest)</span></span> ([]*SearchResult, <span class="type">error</span>) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. 设置指标标签</span></span><br><span class="line">    searchLabel := metrics.SealedSegmentLabel</span><br><span class="line">    <span class="keyword">if</span> segType == commonpb.SegmentState_Growing &#123;</span><br><span class="line">        searchLabel = metrics.GrowingSegmentLabel</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 并发搜索所有 segments</span></span><br><span class="line">    results := <span class="built_in">make</span>([]*SearchResult, <span class="number">0</span>, <span class="built_in">len</span>(segments))</span><br><span class="line">    <span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">    <span class="keyword">var</span> mu sync.Mutex</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> _, s := <span class="keyword">range</span> segments &#123;</span><br><span class="line">        wg.Add(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(seg Segment)</span></span> &#123;</span><br><span class="line">            <span class="keyword">defer</span> wg.Done()</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Pin segment 防止被释放</span></span><br><span class="line">            <span class="keyword">if</span> err := seg.PinIfNotReleased(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">defer</span> seg.Unpin()</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 检查是否需要懒加载</span></span><br><span class="line">            <span class="keyword">if</span> seg.IsLazyLoad() &#123;</span><br><span class="line">                mgr.DiskCache.Do(seg, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> <span class="type">error</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> seg.Load(ctx)</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 执行搜索</span></span><br><span class="line">            result, err := seg.Search(ctx, searchReq)</span><br><span class="line">            <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            mu.Lock()</span><br><span class="line">            results = <span class="built_in">append</span>(results, result)</span><br><span class="line">            mu.Unlock()</span><br><span class="line">        &#125;(s)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    wg.Wait()</span><br><span class="line">    <span class="keyword">return</span> results, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="关键特性"><a href="#关键特性" class="headerlink" title="关键特性"></a>关键特性</h4><ol>
<li><strong>并发执行</strong>：使用 goroutine 并发搜索多个 segments</li>
<li><strong>Segment Pin</strong>：Pin segment 防止在搜索过程中被释放</li>
<li><strong>懒加载支持</strong>：如果 segment 需要懒加载，通过 DiskCache 加载</li>
<li><strong>错误处理</strong>：单个 segment 搜索失败不影响其他 segments</li>
</ol>
<h3 id="2-SearchHistorical-和-SearchStreaming"><a href="#2-SearchHistorical-和-SearchStreaming" class="headerlink" title="2. SearchHistorical 和 SearchStreaming"></a>2. SearchHistorical 和 SearchStreaming</h3><h4 id="SearchHistorical"><a href="#SearchHistorical" class="headerlink" title="SearchHistorical"></a>SearchHistorical</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SearchHistorical</span><span class="params">(ctx context.Context, manager *Manager, searchReq *SearchRequest, </span></span></span><br><span class="line"><span class="params"><span class="function">    collID <span class="type">int64</span>, partIDs []<span class="type">int64</span>, segIDs []<span class="type">int64</span>)</span></span> ([]*SearchResult, []Segment, <span class="type">error</span>) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 验证并获取历史 segments</span></span><br><span class="line">    segments, err := validateOnHistorical(ctx, manager, collID, partIDs, segIDs)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 搜索 sealed segments</span></span><br><span class="line">    searchResults, err := searchSegments(ctx, manager, segments, SegmentTypeSealed, searchReq)</span><br><span class="line">    <span class="keyword">return</span> searchResults, segments, err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>搜索范围</strong>：</p>
<ul>
<li>如果 <code>segIDs</code> 未指定：搜索 <code>partIDs</code> 指定的所有历史 segments</li>
<li>如果 <code>segIDs</code> 指定了：只搜索指定的 segments</li>
<li>如果 <code>partIDs</code> 为空：搜索已加载 collection 的所有分区</li>
</ul>
<h4 id="SearchStreaming"><a href="#SearchStreaming" class="headerlink" title="SearchStreaming"></a>SearchStreaming</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SearchStreaming</span><span class="params">(ctx context.Context, manager *Manager, searchReq *SearchRequest, </span></span></span><br><span class="line"><span class="params"><span class="function">    collID <span class="type">int64</span>, partIDs []<span class="type">int64</span>, segIDs []<span class="type">int64</span>)</span></span> ([]*SearchResult, []Segment, <span class="type">error</span>) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 验证并获取流式 segments</span></span><br><span class="line">    segments, err := validateOnStream(ctx, manager, collID, partIDs, segIDs)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 搜索 growing segments</span></span><br><span class="line">    searchResults, err := searchSegments(ctx, manager, segments, SegmentTypeGrowing, searchReq)</span><br><span class="line">    <span class="keyword">return</span> searchResults, segments, err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="SearchRequest-和-Plan-参数"><a href="#SearchRequest-和-Plan-参数" class="headerlink" title="SearchRequest 和 Plan 参数"></a>SearchRequest 和 Plan 参数</h2><h3 id="1-SearchRequest-结构"><a href="#1-SearchRequest-结构" class="headerlink" title="1. SearchRequest 结构"></a>1. SearchRequest 结构</h3><p><code>SearchRequest</code> 封装了搜索请求的所有信息。</p>
<h4 id="结构定义"><a href="#结构定义" class="headerlink" title="结构定义"></a>结构定义</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> SearchRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">    plan              *SearchPlan              <span class="comment">// 搜索计划</span></span><br><span class="line">    cPlaceholderGroup C.CPlaceholderGroup      <span class="comment">// C++ 层的 PlaceholderGroup</span></span><br><span class="line">    msgID             <span class="type">int64</span>                    <span class="comment">// 消息 ID</span></span><br><span class="line">    searchFieldID     <span class="type">int64</span>                    <span class="comment">// 搜索字段 ID</span></span><br><span class="line">    mvccTimestamp     typeutil.Timestamp       <span class="comment">// MVCC 时间戳</span></span><br><span class="line">    consistencyLevel  commonpb.ConsistencyLevel <span class="comment">// 一致性级别</span></span><br><span class="line">    collectionTTL     typeutil.Timestamp       <span class="comment">// Collection TTL</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="创建过程"><a href="#创建过程" class="headerlink" title="创建过程"></a>创建过程</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewSearchRequest</span><span class="params">(collection *CCollection, req *querypb.SearchRequest, </span></span></span><br><span class="line"><span class="params"><span class="function">    placeholderGrp []<span class="type">byte</span>)</span></span> (*SearchRequest, <span class="type">error</span>) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. 从序列化的 Plan 创建 SearchPlan</span></span><br><span class="line">    expr := req.Req.SerializedExprPlan</span><br><span class="line">    plan, err := createSearchPlanByExpr(collection, expr)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 解析 PlaceholderGroup</span></span><br><span class="line">    <span class="keyword">var</span> cPlaceholderGroup C.CPlaceholderGroup</span><br><span class="line">    status := C.ParsePlaceholderGroup(plan.cSearchPlan, blobPtr, blobSize, &amp;cPlaceholderGroup)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. 验证 MetricType</span></span><br><span class="line">    metricTypeInPlan := plan.GetMetricType()</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(metricType) != <span class="number">0</span> &amp;&amp; metricType != metricTypeInPlan &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, merr.WrapErrParameterInvalid(...)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. 获取搜索字段 ID</span></span><br><span class="line">    <span class="keyword">var</span> fieldID C.int64_t</span><br><span class="line">    status = C.GetFieldID(plan.cSearchPlan, &amp;fieldID)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &amp;SearchRequest&#123;</span><br><span class="line">        plan:              plan,</span><br><span class="line">        cPlaceholderGroup: cPlaceholderGroup,</span><br><span class="line">        searchFieldID:     <span class="type">int64</span>(fieldID),</span><br><span class="line">        mvccTimestamp:     req.GetReq().GetMvccTimestamp(),</span><br><span class="line">        consistencyLevel:  req.GetReq().GetConsistencyLevel(),</span><br><span class="line">        collectionTTL:     req.GetReq().GetCollectionTtlTimestamps(),</span><br><span class="line">    &#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-Plan-参数的作用"><a href="#2-Plan-参数的作用" class="headerlink" title="2. Plan 参数的作用"></a>2. Plan 参数的作用</h3><p><code>Plan</code> 参数是 <code>segment-&gt;Search</code> 的核心参数，包含了搜索执行所需的所有信息。</p>
<h4 id="Plan-结构（C-）"><a href="#Plan-结构（C-）" class="headerlink" title="Plan 结构（C++）"></a>Plan 结构（C++）</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Plan</span> &#123;</span><br><span class="line">    SchemaPtr schema_;                                    <span class="comment">// Schema 信息</span></span><br><span class="line">    std::unique_ptr&lt;VectorPlanNode&gt; plan_node_;          <span class="comment">// 计划节点树</span></span><br><span class="line">    std::map&lt;std::string, FieldId&gt; tag2field_;          <span class="comment">// PlaceholderName -&gt; FieldId</span></span><br><span class="line">    std::vector&lt;FieldId&gt; target_entries_;               <span class="comment">// 需要返回的字段 ID</span></span><br><span class="line">    std::vector&lt;std::string&gt; target_dynamic_fields_;    <span class="comment">// 动态字段列表</span></span><br><span class="line">    std::optional&lt;ExtractedPlanInfo&gt; extra_info_opt_;    <span class="comment">// 额外信息（涉及的字段）</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="Plan-的核心作用"><a href="#Plan-的核心作用" class="headerlink" title="Plan 的核心作用"></a>Plan 的核心作用</h4><h5 id="1-搜索前验证（check-search）"><a href="#1-搜索前验证（check-search）" class="headerlink" title="1. 搜索前验证（check_search）"></a>1. 搜索前验证（check_search）</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">ChunkedSegmentSealedImpl::check_search</span><span class="params">(<span class="type">const</span> query::Plan* plan)</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 检查涉及的字段是否已加载</span></span><br><span class="line">    <span class="keyword">auto</span>&amp; request_fields = plan-&gt;extra_info_opt_.<span class="built_in">value</span>().involved_fields_;</span><br><span class="line">    <span class="keyword">auto</span> field_ready_bitset = field_data_ready_bitset_ | index_ready_bitset_ | binlog_index_bitset_;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">auto</span> absent_fields = request_fields - field_ready_bitset;</span><br><span class="line">    <span class="keyword">if</span> (absent_fields.<span class="built_in">any</span>()) &#123;</span><br><span class="line">        <span class="comment">// 抛出 FieldNotLoaded 错误</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-执行计划节点树"><a href="#2-执行计划节点树" class="headerlink" title="2. 执行计划节点树"></a>2. 执行计划节点树</h5><p><code>plan-&gt;plan_node_</code> 是 <code>VectorPlanNode</code>，包含：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">VectorPlanNode</span> : PlanNode &#123;</span><br><span class="line">    SearchInfo search_info_;                              <span class="comment">// 搜索信息（topk, metric_type, field_id 等）</span></span><br><span class="line">    std::string placeholder_tag_;                         <span class="comment">// Placeholder 标签</span></span><br><span class="line">    std::shared_ptr&lt;milvus::plan::PlanNode&gt; plannodes_;  <span class="comment">// 执行计划节点树</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>计划节点树通常包括：</p>
<ul>
<li><strong>MvccNode</strong>：MVCC 过滤（时间戳过滤和删除过滤）</li>
<li><strong>VectorSearchNode</strong>：向量搜索（包含 topK）</li>
<li><strong>FilterNode</strong>：表达式过滤</li>
<li><strong>GroupByNode</strong>：Group by 操作（如果启用）</li>
<li><strong>RescoresNode</strong>：重排序（如果启用）</li>
</ul>
<h5 id="3-填充返回字段"><a href="#3-填充返回字段" class="headerlink" title="3. 填充返回字段"></a>3. 填充返回字段</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">SegmentInternalInterface::FillTargetEntry</span><span class="params">(<span class="type">const</span> query::Plan* plan, </span></span></span><br><span class="line"><span class="params"><span class="function">    SearchResult&amp; results)</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 遍历 plan-&gt;target_entries_，填充每个字段的数据</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> field_id : plan-&gt;target_entries_) &#123;</span><br><span class="line">        <span class="keyword">auto</span>&amp; field_meta = plan-&gt;schema_-&gt;<span class="keyword">operator</span>[](field_id);</span><br><span class="line">        field_data = <span class="built_in">bulk_subscript</span>(&amp;op_ctx, field_id, results.seg_offsets_.<span class="built_in">data</span>(), size);</span><br><span class="line">        results.output_fields_data_[field_id] = std::<span class="built_in">move</span>(field_data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Plan-的创建流程"><a href="#Plan-的创建流程" class="headerlink" title="Plan 的创建流程"></a>Plan 的创建流程</h4><ol>
<li><strong>Proxy 层</strong>：解析 DSL 表达式，生成 PlanNode</li>
<li><strong>设置 SearchInfo</strong>：从 search_params 中提取 topK、metric_type 等</li>
<li><strong>设置 target_entries</strong>：从 output_fields 中提取需要返回的字段</li>
<li><strong>序列化</strong>：序列化为 protobuf，发送到 QueryNode</li>
<li><strong>QueryNode</strong>：反序列化并创建 C++ Plan 对象</li>
</ol>
<hr>
<h2 id="Segment-Search-内部执行"><a href="#Segment-Search-内部执行" class="headerlink" title="Segment Search 内部执行"></a>Segment Search 内部执行</h2><h3 id="1-segment-Search-执行流程"><a href="#1-segment-Search-执行流程" class="headerlink" title="1. segment-&gt;Search 执行流程"></a>1. segment-&gt;Search 执行流程</h3><p><code>segment-&gt;Search</code> 是 C++ 层的搜索执行入口，通过执行计划节点树完成搜索。</p>
<h4 id="函数签名-2"><a href="#函数签名-2" class="headerlink" title="函数签名"></a>函数签名</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::unique_ptr&lt;SearchResult&gt;</span></span><br><span class="line"><span class="function"><span class="title">SegmentInternalInterface::Search</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> query::Plan* plan,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> query::PlaceholderGroup* placeholder_group,</span></span></span><br><span class="line"><span class="params"><span class="function">    Timestamp timestamp,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> folly::CancellationToken&amp; cancel_token,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">int32_t</span> consistency_level,</span></span></span><br><span class="line"><span class="params"><span class="function">    Timestamp collection_ttl)</span> <span class="type">const</span></span></span><br></pre></td></tr></table></figure>

<h4 id="执行流程-3"><a href="#执行流程-3" class="headerlink" title="执行流程"></a>执行流程</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::unique_ptr&lt;SearchResult&gt;</span></span><br><span class="line"><span class="function"><span class="title">SegmentInternalInterface::Search</span><span class="params">(...)</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">    <span class="function">std::shared_lock <span class="title">lck</span><span class="params">(mutex_)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. 验证 Plan</span></span><br><span class="line">    <span class="built_in">check_search</span>(plan);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 创建执行访问者</span></span><br><span class="line">    <span class="function">query::ExecPlanNodeVisitor <span class="title">visitor</span><span class="params">(*<span class="keyword">this</span>, timestamp, placeholder_group, </span></span></span><br><span class="line"><span class="params"><span class="function">                                       cancel_token, consistency_level, collection_ttl)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. 执行计划节点树</span></span><br><span class="line">    <span class="keyword">auto</span> results = std::<span class="built_in">make_unique</span>&lt;SearchResult&gt;();</span><br><span class="line">    *results = visitor.<span class="built_in">get_moved_result</span>(*plan-&gt;plan_node_);</span><br><span class="line">    results-&gt;segment_ = (<span class="type">void</span>*)<span class="keyword">this</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> results;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-ExecPlanNodeVisitor-执行计划节点树"><a href="#2-ExecPlanNodeVisitor-执行计划节点树" class="headerlink" title="2. ExecPlanNodeVisitor 执行计划节点树"></a>2. ExecPlanNodeVisitor 执行计划节点树</h3><h4 id="visit-VectorPlanNode-node"><a href="#visit-VectorPlanNode-node" class="headerlink" title="visit(VectorPlanNode&amp; node)"></a>visit(VectorPlanNode&amp; node)</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">ExecPlanNodeVisitor::visit</span><span class="params">(VectorPlanNode&amp; node)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1. 获取活跃数据量</span></span><br><span class="line">    <span class="keyword">auto</span> active_count = segment-&gt;<span class="built_in">get_active_count</span>(timestamp_);</span><br><span class="line">    <span class="keyword">if</span> (active_count == <span class="number">0</span>) &#123;</span><br><span class="line">        search_result_opt_ = <span class="built_in">empty_search_result</span>(...);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 构建计划片段</span></span><br><span class="line">    <span class="keyword">auto</span> plan = plan::<span class="built_in">PlanFragment</span>(node.plannodes_);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. 创建查询上下文</span></span><br><span class="line">    <span class="keyword">auto</span> query_context = std::<span class="built_in">make_shared</span>&lt;milvus::exec::QueryContext&gt;(...);</span><br><span class="line">    query_context-&gt;<span class="built_in">set_search_info</span>(node.search_info_);</span><br><span class="line">    query_context-&gt;<span class="built_in">set_placeholder_group</span>(placeholder_group_);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. 执行任务</span></span><br><span class="line">    <span class="keyword">auto</span> result = <span class="built_in">ExecuteTask</span>(plan, query_context);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. 获取搜索结果</span></span><br><span class="line">    search_result_opt_ = std::<span class="built_in">move</span>(query_context-&gt;<span class="built_in">get_search_result</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-计划节点执行顺序"><a href="#3-计划节点执行顺序" class="headerlink" title="3. 计划节点执行顺序"></a>3. 计划节点执行顺序</h3><h4 id="MvccNode-MVCC-过滤"><a href="#MvccNode-MVCC-过滤" class="headerlink" title="MvccNode - MVCC 过滤"></a>MvccNode - MVCC 过滤</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">RowVectorPtr <span class="title">PhyMvccNode::GetOutput</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">TargetBitmapView <span class="title">data</span><span class="params">(col_input-&gt;GetRawData(), col_input-&gt;size())</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 时间戳过滤（MVCC）</span></span><br><span class="line">    segment_-&gt;<span class="built_in">mask_with_timestamps</span>(data, query_timestamp_, collection_ttl_timestamp_);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 删除标记过滤</span></span><br><span class="line">    segment_-&gt;<span class="built_in">mask_with_delete</span>(data, active_count_, query_timestamp_);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> std::<span class="built_in">make_shared</span>&lt;RowVector&gt;(std::vector&lt;VectorPtr&gt;&#123;col_input&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>作用</strong>：</p>
<ul>
<li><code>mask_with_timestamps</code>：过滤掉时间戳大于查询时间戳的数据</li>
<li><code>mask_with_delete</code>：过滤掉已删除的数据</li>
</ul>
<h4 id="VectorSearchNode-向量搜索-TopK"><a href="#VectorSearchNode-向量搜索-TopK" class="headerlink" title="VectorSearchNode - 向量搜索 + TopK"></a>VectorSearchNode - 向量搜索 + TopK</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">RowVectorPtr <span class="title">PhyVectorSearchNode::GetOutput</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 执行向量搜索</span></span><br><span class="line">    segment_-&gt;<span class="built_in">vector_search</span>(search_info_,</span><br><span class="line">                           src_data,</span><br><span class="line">                           src_offsets,</span><br><span class="line">                           num_queries,</span><br><span class="line">                           query_timestamp_,</span><br><span class="line">                           final_view,</span><br><span class="line">                           op_context,</span><br><span class="line">                           search_result);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置搜索结果（已包含 topK）</span></span><br><span class="line">    query_context_-&gt;<span class="built_in">set_search_result</span>(std::<span class="built_in">move</span>(search_result));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>作用</strong>：</p>
<ul>
<li>执行向量搜索，使用 <code>search_info_.topk_</code> 作为 topK</li>
<li>返回的结果已包含 topK 的 <code>seg_offsets_</code> 和 <code>distances_</code></li>
</ul>
<h4 id="GroupByNode-Group-By-操作"><a href="#GroupByNode-Group-By-操作" class="headerlink" title="GroupByNode - Group By 操作"></a>GroupByNode - Group By 操作</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">RowVectorPtr <span class="title">PhyGroupByNode::GetOutput</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> search_result = query_context_-&gt;<span class="built_in">get_search_result</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 执行 Group By</span></span><br><span class="line">    milvus::exec::<span class="built_in">SearchGroupBy</span>(op_context,</span><br><span class="line">                                search_result.vector_iterators_.<span class="built_in">value</span>(),</span><br><span class="line">                                search_info_,</span><br><span class="line">                                group_by_values,</span><br><span class="line">                                *segment_,</span><br><span class="line">                                search_result.seg_offsets_,</span><br><span class="line">                                search_result.distances_,</span><br><span class="line">                                search_result.topk_per_nq_prefix_sum_);</span><br><span class="line">    </span><br><span class="line">    search_result.group_by_values_ = std::<span class="built_in">move</span>(group_by_values);</span><br><span class="line">    search_result.group_size_ = search_info_.group_size_;</span><br><span class="line">    </span><br><span class="line">    query_context_-&gt;<span class="built_in">set_search_result</span>(std::<span class="built_in">move</span>(search_result));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>作用</strong>：</p>
<ul>
<li>对搜索结果进行 group by 处理</li>
<li>更新 <code>search_result.group_by_values_</code> 和 <code>group_size_</code></li>
</ul>
<h3 id="4-Segment-Search-完成的操作总结"><a href="#4-Segment-Search-完成的操作总结" class="headerlink" title="4. Segment Search 完成的操作总结"></a>4. Segment Search 完成的操作总结</h3><p>在 <code>segment-&gt;Search</code> 中，已经完成了以下操作：</p>
<p>✅ <strong>MVCC 过滤</strong>：通过 <code>MvccNode</code> 执行时间戳和删除过滤<br>✅ <strong>TopK 选择</strong>：通过 <code>VectorSearchNode</code> 执行向量搜索，结果已包含 topK<br>✅ <strong>Group By</strong>：通过 <code>GroupByNode</code> 执行（如果启用）<br>✅ <strong>表达式过滤</strong>：通过 <code>FilterNode</code> 执行（如果有过滤表达式）<br>✅ <strong>重排序</strong>：通过 <code>RescoresNode</code> 执行（如果启用）</p>
<p><strong>关键点</strong>：每个 segment 返回的结果是<strong>局部最优</strong>的，只代表该 segment 内的 topK，不代表全局最优。</p>
<hr>
<h2 id="结果归约（Reduce）"><a href="#结果归约（Reduce）" class="headerlink" title="结果归约（Reduce）"></a>结果归约（Reduce）</h2><h3 id="1-为什么需要-Reduce？"><a href="#1-为什么需要-Reduce？" class="headerlink" title="1. 为什么需要 Reduce？"></a>1. 为什么需要 Reduce？</h3><p>虽然每个 segment 已经完成了 MVCC、topK、group by 等操作，但仍然需要对多个 segment 的结果进行 Reduce，原因如下：</p>
<ol>
<li><strong>数据分布</strong>：数据分布在多个 segments 中</li>
<li><strong>局部 vs 全局</strong>：每个 segment 返回局部 topK，用户需要全局 topK</li>
<li><strong>去重需求</strong>：需要去除跨 segment 的重复 entity</li>
<li><strong>Group By</strong>：需要全局的 group by 处理</li>
<li><strong>成本聚合</strong>：需要聚合各个 segment 的成本信息</li>
</ol>
<h3 id="2-ReduceSearchResults-函数"><a href="#2-ReduceSearchResults-函数" class="headerlink" title="2. ReduceSearchResults 函数"></a>2. ReduceSearchResults 函数</h3><h4 id="函数签名-3"><a href="#函数签名-3" class="headerlink" title="函数签名"></a>函数签名</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReduceSearchResults</span><span class="params">(ctx context.Context, results []*internalpb.SearchResults, </span></span></span><br><span class="line"><span class="params"><span class="function">    info *reduce.ResultInfo)</span></span> (*internalpb.SearchResults, <span class="type">error</span>)</span><br></pre></td></tr></table></figure>

<h4 id="执行流程-4"><a href="#执行流程-4" class="headerlink" title="执行流程"></a>执行流程</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReduceSearchResults</span><span class="params">(ctx context.Context, results []*internalpb.SearchResults, </span></span></span><br><span class="line"><span class="params"><span class="function">    info *reduce.ResultInfo)</span></span> (*internalpb.SearchResults, <span class="type">error</span>) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. 过滤空结果</span></span><br><span class="line">    results = lo.Filter(results, <span class="function"><span class="keyword">func</span><span class="params">(result *internalpb.SearchResults, _ <span class="type">int</span>)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> result != <span class="literal">nil</span> &amp;&amp; result.GetSlicedBlob() != <span class="literal">nil</span></span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 短路优化：如果只有一个结果，直接返回</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(results) == <span class="number">1</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> results[<span class="number">0</span>], <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. 解码搜索结果</span></span><br><span class="line">    searchResultData, err := DecodeSearchResults(ctx, results)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. 初始化归约器</span></span><br><span class="line">    searchReduce := InitSearchReducer(info)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. 归约搜索结果</span></span><br><span class="line">    reducedResultData, err := searchReduce.ReduceSearchResultData(ctx, searchResultData, info)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 6. 编码结果</span></span><br><span class="line">    searchResults, err := EncodeSearchResultData(ctx, reducedResultData, ...)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 7. 聚合成本信息</span></span><br><span class="line">    searchResults.CostAggregation = mergeRequestCost(requestCosts)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> searchResults, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-K-Way-Merge-算法"><a href="#3-K-Way-Merge-算法" class="headerlink" title="3. K-Way Merge 算法"></a>3. K-Way Merge 算法</h3><p>Reduce 使用<strong>多路归并（K-Way Merge）算法</strong>，从多个已排序的结果中选择全局最优的 topK。</p>
<h4 id="算法原理"><a href="#算法原理" class="headerlink" title="算法原理"></a>算法原理</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(scr *SearchCommonReduce)</span></span> ReduceSearchResultData(</span><br><span class="line">    ctx context.Context, </span><br><span class="line">    searchResultData []*schemapb.SearchResultData, </span><br><span class="line">    info *reduce.ResultInfo) (*schemapb.SearchResultData, <span class="type">error</span>) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 为每个 segment 的结果维护偏移量</span></span><br><span class="line">    offsets := <span class="built_in">make</span>([]<span class="type">int64</span>, <span class="built_in">len</span>(searchResultData))</span><br><span class="line">    idSet := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">interface</span>&#123;&#125;]<span class="keyword">struct</span>&#123;&#125;)  <span class="comment">// 用于去重</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i := <span class="type">int64</span>(<span class="number">0</span>); i &lt; info.GetNq(); i++ &#123;</span><br><span class="line">        <span class="keyword">var</span> j <span class="type">int64</span></span><br><span class="line">        <span class="keyword">for</span> j = <span class="number">0</span>; j &lt; info.GetTopK(); &#123;</span><br><span class="line">            <span class="comment">// 从所有 segment 中选择当前最高分</span></span><br><span class="line">            sel := SelectSearchResultData(searchResultData, resultOffsets, offsets, i)</span><br><span class="line">            <span class="keyword">if</span> sel == <span class="number">-1</span> &#123;</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            idx := resultOffsets[sel][i] + offsets[sel]</span><br><span class="line">            id := typeutil.GetPK(searchResultData[sel].GetIds(), idx)</span><br><span class="line">            score := searchResultData[sel].Scores[idx]</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 去重：跳过已存在的 entity</span></span><br><span class="line">            <span class="keyword">if</span> _, ok := idSet[id]; !ok &#123;</span><br><span class="line">                <span class="comment">// 添加到最终结果</span></span><br><span class="line">                retSize += typeutil.AppendFieldData(ret.FieldsData, </span><br><span class="line">                    searchResultData[sel].FieldsData, idx)</span><br><span class="line">                typeutil.AppendPKs(ret.Ids, id)</span><br><span class="line">                ret.Scores = <span class="built_in">append</span>(ret.Scores, score)</span><br><span class="line">                idSet[id] = <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">                j++</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                skipDupCnt++  <span class="comment">// 跳过重复的 entity</span></span><br><span class="line">            &#125;</span><br><span class="line">            offsets[sel]++  <span class="comment">// 移动指针</span></span><br><span class="line">        &#125;</span><br><span class="line">        ret.Topks = <span class="built_in">append</span>(ret.Topks, j)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="SelectSearchResultData-函数"><a href="#SelectSearchResultData-函数" class="headerlink" title="SelectSearchResultData 函数"></a>SelectSearchResultData 函数</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SelectSearchResultData</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    dataArray []*schemapb.SearchResultData, </span></span></span><br><span class="line"><span class="params"><span class="function">    resultOffsets [][]<span class="type">int64</span>, </span></span></span><br><span class="line"><span class="params"><span class="function">    offsets []<span class="type">int64</span>, </span></span></span><br><span class="line"><span class="params"><span class="function">    qi <span class="type">int64</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> sel = <span class="number">-1</span></span><br><span class="line">    <span class="keyword">var</span> maxDistance = -<span class="type">float32</span>(math.MaxFloat32)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 遍历所有 segment，找到当前最高分</span></span><br><span class="line">    <span class="keyword">for</span> i, offset := <span class="keyword">range</span> offsets &#123;</span><br><span class="line">        <span class="keyword">if</span> offset &gt;= dataArray[i].Topks[qi] &#123;</span><br><span class="line">            <span class="keyword">continue</span>  <span class="comment">// 该 segment 的结果已用完</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        idx := resultOffsets[i][qi] + offset</span><br><span class="line">        distance := dataArray[i].Scores[idx]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> distance &gt; maxDistance &#123;</span><br><span class="line">            sel = i</span><br><span class="line">            maxDistance = distance</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sel</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-Reduce-的其他作用"><a href="#4-Reduce-的其他作用" class="headerlink" title="4. Reduce 的其他作用"></a>4. Reduce 的其他作用</h3><h4 id="去重（Deduplication）"><a href="#去重（Deduplication）" class="headerlink" title="去重（Deduplication）"></a>去重（Deduplication）</h4><p>同一个 entity 可能同时出现在多个 segments 中：</p>
<ul>
<li><strong>Growing + Sealed</strong>：新写入的数据在 growing segment，但可能还未 flush 到 sealed segment</li>
<li><strong>Compaction</strong>：compaction 过程中，数据可能同时存在于新旧 segments</li>
</ul>
<h4 id="Group-By-处理"><a href="#Group-By-处理" class="headerlink" title="Group By 处理"></a>Group By 处理</h4><p>如果有 group by 需求，Reduce 阶段会进行全局的 group by 处理：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sbr *SearchGroupByReduce)</span></span> ReduceSearchResultData(...) &#123;</span><br><span class="line">    groupByValueMap := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">interface</span>&#123;&#125;]<span class="type">int64</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> j = <span class="number">0</span>; j &lt; groupBound; &#123;</span><br><span class="line">        sel := SelectSearchResultData(...)</span><br><span class="line">        groupByVal := groupByValIterator[sel](idx)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检查 group 限制</span></span><br><span class="line">        <span class="keyword">if</span> groupCount &gt;= groupSize &#123;</span><br><span class="line">            <span class="comment">// 跳过：该 group 已满</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 添加到该 group</span></span><br><span class="line">            groupByValueMap[groupByVal]++</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="成本聚合"><a href="#成本聚合" class="headerlink" title="成本聚合"></a>成本聚合</h4><p>Reduce 还会聚合各个 segment 的存储扫描成本：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">storageCost := lo.Reduce(results, <span class="function"><span class="keyword">func</span><span class="params">(acc segcore.StorageCost, </span></span></span><br><span class="line"><span class="params"><span class="function">    result *internalpb.SearchResults, _ <span class="type">int</span>)</span></span> segcore.StorageCost &#123;</span><br><span class="line">    acc.ScannedRemoteBytes += result.GetScannedRemoteBytes()</span><br><span class="line">    acc.ScannedTotalBytes += result.GetScannedTotalBytes()</span><br><span class="line">    <span class="keyword">return</span> acc</span><br><span class="line">&#125;, segcore.StorageCost&#123;&#125;)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="高级搜索（Advanced-Search）"><a href="#高级搜索（Advanced-Search）" class="headerlink" title="高级搜索（Advanced Search）"></a>高级搜索（Advanced Search）</h2><h3 id="1-ResultInfo-isAdvance-的作用"><a href="#1-ResultInfo-isAdvance-的作用" class="headerlink" title="1. ResultInfo.isAdvance 的作用"></a>1. ResultInfo.isAdvance 的作用</h3><p><code>ResultInfo.isAdvance</code> 用于标识是否是高级搜索（Hybrid Search），决定在 QueryNode 层的结果归约策略。</p>
<h4 id="核心作用"><a href="#核心作用" class="headerlink" title="核心作用"></a>核心作用</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReduceSearchOnQueryNode</span><span class="params">(ctx context.Context, results []*internalpb.SearchResults, </span></span></span><br><span class="line"><span class="params"><span class="function">    info *reduce.ResultInfo)</span></span> (*internalpb.SearchResults, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> info.GetIsAdvance() &#123;</span><br><span class="line">        <span class="keyword">return</span> ReduceAdvancedSearchResults(ctx, results)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ReduceSearchResults(ctx, results, info)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="两种归约策略"><a href="#两种归约策略" class="headerlink" title="两种归约策略"></a>两种归约策略</h4><h5 id="1-普通搜索（isAdvance-false）"><a href="#1-普通搜索（isAdvance-false）" class="headerlink" title="1. 普通搜索（isAdvance &#x3D; false）"></a>1. 普通搜索（isAdvance &#x3D; false）</h5><p>使用 <code>ReduceSearchResults</code>：</p>
<ul>
<li>立即归约所有结果</li>
<li>返回最终的 topK 结果</li>
<li>适用于单一向量搜索</li>
</ul>
<h5 id="2-高级搜索（isAdvance-true）"><a href="#2-高级搜索（isAdvance-true）" class="headerlink" title="2. 高级搜索（isAdvance &#x3D; true）"></a>2. 高级搜索（isAdvance &#x3D; true）</h5><p>使用 <code>ReduceAdvancedSearchResults</code>：</p>
<ul>
<li><strong>不立即归约</strong>，而是将子结果保存到 <code>SubResults</code> 中</li>
<li>延迟到 Proxy 层进行归约</li>
<li>适用于混合搜索（Hybrid Search），包含多个子搜索请求</li>
<li>需要在 Proxy 层进行特殊的归约逻辑（如 rerank）</li>
</ul>
<h4 id="ReduceAdvancedSearchResults-实现"><a href="#ReduceAdvancedSearchResults-实现" class="headerlink" title="ReduceAdvancedSearchResults 实现"></a>ReduceAdvancedSearchResults 实现</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReduceAdvancedSearchResults</span><span class="params">(ctx context.Context, </span></span></span><br><span class="line"><span class="params"><span class="function">    results []*internalpb.SearchResults)</span></span> (*internalpb.SearchResults, <span class="type">error</span>) &#123;</span><br><span class="line">    </span><br><span class="line">    searchResults := &amp;internalpb.SearchResults&#123;</span><br><span class="line">        IsAdvanced: <span class="literal">true</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 不归约，直接追加子结果</span></span><br><span class="line">    <span class="keyword">for</span> index, result := <span class="keyword">range</span> results &#123;</span><br><span class="line">        subResult := &amp;internalpb.SubSearchResults&#123;</span><br><span class="line">            MetricType:     result.GetMetricType(),</span><br><span class="line">            NumQueries:     result.GetNumQueries(),</span><br><span class="line">            TopK:           result.GetTopK(),</span><br><span class="line">            SlicedBlob:     result.GetSlicedBlob(),</span><br><span class="line">            SlicedNumCount: result.GetSlicedNumCount(),</span><br><span class="line">            SlicedOffset:   result.GetSlicedOffset(),</span><br><span class="line">            ReqIndex:       <span class="type">int64</span>(index),</span><br><span class="line">        &#125;</span><br><span class="line">        searchResults.SubResults = <span class="built_in">append</span>(searchResults.SubResults, subResult)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> searchResults, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="完整流程总结"><a href="#完整流程总结" class="headerlink" title="完整流程总结"></a>完整流程总结</h2><h3 id="1-搜索流程时序图"><a href="#1-搜索流程时序图" class="headerlink" title="1. 搜索流程时序图"></a>1. 搜索流程时序图</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">┌─────────┐</span><br><span class="line">│  Proxy  │</span><br><span class="line">└────┬────┘</span><br><span class="line">     │ 1. SearchRequest</span><br><span class="line">     ▼</span><br><span class="line">┌─────────────┐</span><br><span class="line">│ QueryNode  │</span><br><span class="line">└─────┬───────┘</span><br><span class="line">      │ 2. SearchTask.Execute</span><br><span class="line">      ▼</span><br><span class="line">┌─────────────────┐</span><br><span class="line">│ SearchTask      │</span><br><span class="line">│ - combinePlaceHolderGroups</span><br><span class="line">│ - NewSearchRequest</span><br><span class="line">└─────┬───────────┘</span><br><span class="line">      │ 3. SearchHistorical/SearchStreaming</span><br><span class="line">      ▼</span><br><span class="line">┌─────────────────┐</span><br><span class="line">│ searchSegments  │</span><br><span class="line">│ - 并发搜索多个 segments</span><br><span class="line">└─────┬───────────┘</span><br><span class="line">      │ 4. Segment.Search</span><br><span class="line">      ▼</span><br><span class="line">┌─────────────────┐</span><br><span class="line">│ Segment.Search  │</span><br><span class="line">│ - check_search</span><br><span class="line">│ - ExecPlanNodeVisitor</span><br><span class="line">└─────┬───────────┘</span><br><span class="line">      │ 5. ExecuteTask</span><br><span class="line">      ▼</span><br><span class="line">┌─────────────────┐</span><br><span class="line">│ Plan Nodes      │</span><br><span class="line">│ - MvccNode (MVCC 过滤)</span><br><span class="line">│ - VectorSearchNode (向量搜索 + TopK)</span><br><span class="line">│ - FilterNode (表达式过滤)</span><br><span class="line">│ - GroupByNode (Group By)</span><br><span class="line">└─────┬───────────┘</span><br><span class="line">      │ 6. SearchResult (局部 topK)</span><br><span class="line">      ▼</span><br><span class="line">┌─────────────────┐</span><br><span class="line">│ ReduceSearchResults │</span><br><span class="line">│ - K-Way Merge</span><br><span class="line">│ - 去重</span><br><span class="line">│ - Group By</span><br><span class="line">│ - 成本聚合</span><br><span class="line">└─────┬───────────┘</span><br><span class="line">      │ 7. 全局 topK 结果</span><br><span class="line">      ▼</span><br><span class="line">┌─────────┐</span><br><span class="line">│ Result  │</span><br><span class="line">└─────────┘</span><br></pre></td></tr></table></figure>

<h3 id="2-关键数据流"><a href="#2-关键数据流" class="headerlink" title="2. 关键数据流"></a>2. 关键数据流</h3><h4 id="SearchRequest-创建"><a href="#SearchRequest-创建" class="headerlink" title="SearchRequest 创建"></a>SearchRequest 创建</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">QueryRequest (protobuf)</span><br><span class="line">  ↓</span><br><span class="line">SerializedExprPlan (bytes)</span><br><span class="line">  ↓</span><br><span class="line">createSearchPlanByExpr</span><br><span class="line">  ↓</span><br><span class="line">SearchPlan (C++)</span><br><span class="line">  ↓</span><br><span class="line">SearchRequest (Go wrapper)</span><br></pre></td></tr></table></figure>

<h4 id="Segment-Search-执行"><a href="#Segment-Search-执行" class="headerlink" title="Segment Search 执行"></a>Segment Search 执行</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">SearchRequest</span><br><span class="line">  ↓</span><br><span class="line">Plan (包含 plan_node_)</span><br><span class="line">  ↓</span><br><span class="line">ExecPlanNodeVisitor.visit(VectorPlanNode)</span><br><span class="line">  ↓</span><br><span class="line">PlanFragment (执行计划节点树)</span><br><span class="line">  ↓</span><br><span class="line">ExecuteTask</span><br><span class="line">  ↓</span><br><span class="line">SearchResult (局部 topK)</span><br></pre></td></tr></table></figure>

<h4 id="Result-Reduce"><a href="#Result-Reduce" class="headerlink" title="Result Reduce"></a>Result Reduce</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">多个 SearchResult (局部 topK)</span><br><span class="line">  ↓</span><br><span class="line">DecodeSearchResults</span><br><span class="line">  ↓</span><br><span class="line">ReduceSearchResultData (K-Way Merge)</span><br><span class="line">  ↓</span><br><span class="line">EncodeSearchResultData</span><br><span class="line">  ↓</span><br><span class="line">SearchResults (全局 topK)</span><br></pre></td></tr></table></figure>

<h3 id="3-性能考虑"><a href="#3-性能考虑" class="headerlink" title="3. 性能考虑"></a>3. 性能考虑</h3><h4 id="时间复杂度"><a href="#时间复杂度" class="headerlink" title="时间复杂度"></a>时间复杂度</h4><ul>
<li><strong>Segment Search</strong>：O(N × log K)，其中 N 是 segment 内的数据量，K 是 topK</li>
<li><strong>Reduce</strong>：O(M × K)，其中 M 是 segment 数量，K 是 topK</li>
</ul>
<p>由于 M（segment 数量）通常远小于 N（数据量），Reduce 的开销相对较小。</p>
<h4 id="优化策略"><a href="#优化策略" class="headerlink" title="优化策略"></a>优化策略</h4><ol>
<li><strong>短路优化</strong>：如果只有一个 segment 的结果，直接返回</li>
<li><strong>并发搜索</strong>：多个 segments 并发搜索</li>
<li><strong>流式处理</strong>：使用 StreamingSearchTask 进行流式归约</li>
<li><strong>内存限制</strong>：检查结果大小，避免 OOM</li>
</ol>
<h3 id="4-关键要点总结"><a href="#4-关键要点总结" class="headerlink" title="4. 关键要点总结"></a>4. 关键要点总结</h3><h4 id="Segment-Search-层面"><a href="#Segment-Search-层面" class="headerlink" title="Segment Search 层面"></a>Segment Search 层面</h4><p>✅ 每个 segment 的 <code>Search</code> 已经完成了：</p>
<ul>
<li>MVCC 过滤（时间戳和删除过滤）</li>
<li>TopK 选择（向量搜索）</li>
<li>Group By（如果启用）</li>
<li>表达式过滤（如果有）</li>
</ul>
<p>✅ 但返回的是<strong>局部最优</strong>结果，只代表该 segment 内的 topK</p>
<h4 id="Reduce-层面"><a href="#Reduce-层面" class="headerlink" title="Reduce 层面"></a>Reduce 层面</h4><p>✅ Reduce 通过 <strong>K-Way Merge</strong> 算法合并多个 segment 的结果：</p>
<ul>
<li>选择全局最优的 topK</li>
<li>去除跨 segment 的重复 entity</li>
<li>处理全局的 group by</li>
<li>聚合成本信息</li>
</ul>
<p>✅ 最终得到<strong>全局最优</strong>的 topK 结果</p>
<h4 id="类比理解"><a href="#类比理解" class="headerlink" title="类比理解"></a>类比理解</h4><ul>
<li><strong>Segment Search</strong>：每个班级选出前 10 名</li>
<li><strong>Reduce</strong>：从所有班级的前 10 名中，选出全校前 10 名</li>
</ul>
<p>即使每个班级已经完成了排名，仍然需要全校级别的 Reduce 操作来选出最终的 topK。</p>
<hr>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="./why_reduce_search_results.md">为什么需要对 Search Result 进行 Reduce</a></li>
<li><a href="./proxy-reduce.md">Proxy Reduce 算法详解</a></li>
<li><a href="./query_request_flow_analysis.md">Query Request Flow Analysis</a></li>
<li><a href="../design_docs/segcore/segment_interface.md">Segment Search Implementation</a></li>
</ul>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives">archives</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95"><span class="toc-number">1.</span> <span class="toc-text">目录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">2.</span> <span class="toc-text">概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2%E6%B5%81%E7%A8%8B%E6%A6%82%E8%A7%88"><span class="toc-number">2.1.</span> <span class="toc-text">搜索流程概览</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2%E4%BB%BB%E5%8A%A1%E5%85%A5%E5%8F%A3"><span class="toc-number">3.</span> <span class="toc-text">搜索任务入口</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-SearchTask-Execute"><span class="toc-number">3.1.</span> <span class="toc-text">1. SearchTask.Execute</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E7%AD%BE%E5%90%8D"><span class="toc-number">3.1.1.</span> <span class="toc-text">函数签名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-number">3.1.2.</span> <span class="toc-text">执行流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E6%AD%A5%E9%AA%A4"><span class="toc-number">3.1.3.</span> <span class="toc-text">关键步骤</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-StreamingSearchTask-Execute"><span class="toc-number">3.2.</span> <span class="toc-text">2. StreamingSearchTask.Execute</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B-1"><span class="toc-number">3.2.1.</span> <span class="toc-text">执行流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%81%E5%BC%8F%E6%90%9C%E7%B4%A2%E7%9A%84%E4%BC%98%E5%8A%BF"><span class="toc-number">3.2.2.</span> <span class="toc-text">流式搜索的优势</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Segment-%E6%90%9C%E7%B4%A2%E6%89%A7%E8%A1%8C"><span class="toc-number">4.</span> <span class="toc-text">Segment 搜索执行</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-searchSegments-%E5%87%BD%E6%95%B0"><span class="toc-number">4.1.</span> <span class="toc-text">1. searchSegments 函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E7%AD%BE%E5%90%8D-1"><span class="toc-number">4.1.1.</span> <span class="toc-text">函数签名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B-2"><span class="toc-number">4.1.2.</span> <span class="toc-text">执行流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E7%89%B9%E6%80%A7"><span class="toc-number">4.1.3.</span> <span class="toc-text">关键特性</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-SearchHistorical-%E5%92%8C-SearchStreaming"><span class="toc-number">4.2.</span> <span class="toc-text">2. SearchHistorical 和 SearchStreaming</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SearchHistorical"><span class="toc-number">4.2.1.</span> <span class="toc-text">SearchHistorical</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SearchStreaming"><span class="toc-number">4.2.2.</span> <span class="toc-text">SearchStreaming</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SearchRequest-%E5%92%8C-Plan-%E5%8F%82%E6%95%B0"><span class="toc-number">5.</span> <span class="toc-text">SearchRequest 和 Plan 参数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-SearchRequest-%E7%BB%93%E6%9E%84"><span class="toc-number">5.1.</span> <span class="toc-text">1. SearchRequest 结构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%93%E6%9E%84%E5%AE%9A%E4%B9%89"><span class="toc-number">5.1.1.</span> <span class="toc-text">结构定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B"><span class="toc-number">5.1.2.</span> <span class="toc-text">创建过程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Plan-%E5%8F%82%E6%95%B0%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">5.2.</span> <span class="toc-text">2. Plan 参数的作用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Plan-%E7%BB%93%E6%9E%84%EF%BC%88C-%EF%BC%89"><span class="toc-number">5.2.1.</span> <span class="toc-text">Plan 结构（C++）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Plan-%E7%9A%84%E6%A0%B8%E5%BF%83%E4%BD%9C%E7%94%A8"><span class="toc-number">5.2.2.</span> <span class="toc-text">Plan 的核心作用</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E6%90%9C%E7%B4%A2%E5%89%8D%E9%AA%8C%E8%AF%81%EF%BC%88check-search%EF%BC%89"><span class="toc-number">5.2.2.1.</span> <span class="toc-text">1. 搜索前验证（check_search）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92%E8%8A%82%E7%82%B9%E6%A0%91"><span class="toc-number">5.2.2.2.</span> <span class="toc-text">2. 执行计划节点树</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E5%A1%AB%E5%85%85%E8%BF%94%E5%9B%9E%E5%AD%97%E6%AE%B5"><span class="toc-number">5.2.2.3.</span> <span class="toc-text">3. 填充返回字段</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Plan-%E7%9A%84%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B"><span class="toc-number">5.2.3.</span> <span class="toc-text">Plan 的创建流程</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Segment-Search-%E5%86%85%E9%83%A8%E6%89%A7%E8%A1%8C"><span class="toc-number">6.</span> <span class="toc-text">Segment Search 内部执行</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-segment-Search-%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-number">6.1.</span> <span class="toc-text">1. segment-&gt;Search 执行流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E7%AD%BE%E5%90%8D-2"><span class="toc-number">6.1.1.</span> <span class="toc-text">函数签名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B-3"><span class="toc-number">6.1.2.</span> <span class="toc-text">执行流程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-ExecPlanNodeVisitor-%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92%E8%8A%82%E7%82%B9%E6%A0%91"><span class="toc-number">6.2.</span> <span class="toc-text">2. ExecPlanNodeVisitor 执行计划节点树</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#visit-VectorPlanNode-node"><span class="toc-number">6.2.1.</span> <span class="toc-text">visit(VectorPlanNode&amp; node)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E8%AE%A1%E5%88%92%E8%8A%82%E7%82%B9%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F"><span class="toc-number">6.3.</span> <span class="toc-text">3. 计划节点执行顺序</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MvccNode-MVCC-%E8%BF%87%E6%BB%A4"><span class="toc-number">6.3.1.</span> <span class="toc-text">MvccNode - MVCC 过滤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#VectorSearchNode-%E5%90%91%E9%87%8F%E6%90%9C%E7%B4%A2-TopK"><span class="toc-number">6.3.2.</span> <span class="toc-text">VectorSearchNode - 向量搜索 + TopK</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#GroupByNode-Group-By-%E6%93%8D%E4%BD%9C"><span class="toc-number">6.3.3.</span> <span class="toc-text">GroupByNode - Group By 操作</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-Segment-Search-%E5%AE%8C%E6%88%90%E7%9A%84%E6%93%8D%E4%BD%9C%E6%80%BB%E7%BB%93"><span class="toc-number">6.4.</span> <span class="toc-text">4. Segment Search 完成的操作总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E6%9E%9C%E5%BD%92%E7%BA%A6%EF%BC%88Reduce%EF%BC%89"><span class="toc-number">7.</span> <span class="toc-text">结果归约（Reduce）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81-Reduce%EF%BC%9F"><span class="toc-number">7.1.</span> <span class="toc-text">1. 为什么需要 Reduce？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-ReduceSearchResults-%E5%87%BD%E6%95%B0"><span class="toc-number">7.2.</span> <span class="toc-text">2. ReduceSearchResults 函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E7%AD%BE%E5%90%8D-3"><span class="toc-number">7.2.1.</span> <span class="toc-text">函数签名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B-4"><span class="toc-number">7.2.2.</span> <span class="toc-text">执行流程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-K-Way-Merge-%E7%AE%97%E6%B3%95"><span class="toc-number">7.3.</span> <span class="toc-text">3. K-Way Merge 算法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%97%E6%B3%95%E5%8E%9F%E7%90%86"><span class="toc-number">7.3.1.</span> <span class="toc-text">算法原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SelectSearchResultData-%E5%87%BD%E6%95%B0"><span class="toc-number">7.3.2.</span> <span class="toc-text">SelectSearchResultData 函数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-Reduce-%E7%9A%84%E5%85%B6%E4%BB%96%E4%BD%9C%E7%94%A8"><span class="toc-number">7.4.</span> <span class="toc-text">4. Reduce 的其他作用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%BB%E9%87%8D%EF%BC%88Deduplication%EF%BC%89"><span class="toc-number">7.4.1.</span> <span class="toc-text">去重（Deduplication）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Group-By-%E5%A4%84%E7%90%86"><span class="toc-number">7.4.2.</span> <span class="toc-text">Group By 处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%88%90%E6%9C%AC%E8%81%9A%E5%90%88"><span class="toc-number">7.4.3.</span> <span class="toc-text">成本聚合</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AB%98%E7%BA%A7%E6%90%9C%E7%B4%A2%EF%BC%88Advanced-Search%EF%BC%89"><span class="toc-number">8.</span> <span class="toc-text">高级搜索（Advanced Search）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-ResultInfo-isAdvance-%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">8.1.</span> <span class="toc-text">1. ResultInfo.isAdvance 的作用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E4%BD%9C%E7%94%A8"><span class="toc-number">8.1.1.</span> <span class="toc-text">核心作用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%A4%E7%A7%8D%E5%BD%92%E7%BA%A6%E7%AD%96%E7%95%A5"><span class="toc-number">8.1.2.</span> <span class="toc-text">两种归约策略</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E6%99%AE%E9%80%9A%E6%90%9C%E7%B4%A2%EF%BC%88isAdvance-false%EF%BC%89"><span class="toc-number">8.1.2.1.</span> <span class="toc-text">1. 普通搜索（isAdvance &#x3D; false）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E9%AB%98%E7%BA%A7%E6%90%9C%E7%B4%A2%EF%BC%88isAdvance-true%EF%BC%89"><span class="toc-number">8.1.2.2.</span> <span class="toc-text">2. 高级搜索（isAdvance &#x3D; true）</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ReduceAdvancedSearchResults-%E5%AE%9E%E7%8E%B0"><span class="toc-number">8.1.3.</span> <span class="toc-text">ReduceAdvancedSearchResults 实现</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4%E6%B5%81%E7%A8%8B%E6%80%BB%E7%BB%93"><span class="toc-number">9.</span> <span class="toc-text">完整流程总结</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%90%9C%E7%B4%A2%E6%B5%81%E7%A8%8B%E6%97%B6%E5%BA%8F%E5%9B%BE"><span class="toc-number">9.1.</span> <span class="toc-text">1. 搜索流程时序图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%85%B3%E9%94%AE%E6%95%B0%E6%8D%AE%E6%B5%81"><span class="toc-number">9.2.</span> <span class="toc-text">2. 关键数据流</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SearchRequest-%E5%88%9B%E5%BB%BA"><span class="toc-number">9.2.1.</span> <span class="toc-text">SearchRequest 创建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Segment-Search-%E6%89%A7%E8%A1%8C"><span class="toc-number">9.2.2.</span> <span class="toc-text">Segment Search 执行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Result-Reduce"><span class="toc-number">9.2.3.</span> <span class="toc-text">Result Reduce</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%80%A7%E8%83%BD%E8%80%83%E8%99%91"><span class="toc-number">9.3.</span> <span class="toc-text">3. 性能考虑</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6"><span class="toc-number">9.3.1.</span> <span class="toc-text">时间复杂度</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5"><span class="toc-number">9.3.2.</span> <span class="toc-text">优化策略</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%85%B3%E9%94%AE%E8%A6%81%E7%82%B9%E6%80%BB%E7%BB%93"><span class="toc-number">9.4.</span> <span class="toc-text">4. 关键要点总结</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Segment-Search-%E5%B1%82%E9%9D%A2"><span class="toc-number">9.4.1.</span> <span class="toc-text">Segment Search 层面</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Reduce-%E5%B1%82%E9%9D%A2"><span class="toc-number">9.4.2.</span> <span class="toc-text">Reduce 层面</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B1%BB%E6%AF%94%E7%90%86%E8%A7%A3"><span class="toc-number">9.4.3.</span> <span class="toc-text">类比理解</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">10.</span> <span class="toc-text">参考资料</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://szza.github.io/2025/08/10/Milvus/19_search_flow_comprehensive_analysis/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://szza.github.io/2025/08/10/Milvus/19_search_flow_comprehensive_analysis/&text=Milvus 搜索流程全面分析"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://szza.github.io/2025/08/10/Milvus/19_search_flow_comprehensive_analysis/&title=Milvus 搜索流程全面分析"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://szza.github.io/2025/08/10/Milvus/19_search_flow_comprehensive_analysis/&is_video=false&description=Milvus 搜索流程全面分析"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Milvus 搜索流程全面分析&body=Check out this article: https://szza.github.io/2025/08/10/Milvus/19_search_flow_comprehensive_analysis/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://szza.github.io/2025/08/10/Milvus/19_search_flow_comprehensive_analysis/&title=Milvus 搜索流程全面分析"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://szza.github.io/2025/08/10/Milvus/19_search_flow_comprehensive_analysis/&title=Milvus 搜索流程全面分析"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://szza.github.io/2025/08/10/Milvus/19_search_flow_comprehensive_analysis/&title=Milvus 搜索流程全面分析"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://szza.github.io/2025/08/10/Milvus/19_search_flow_comprehensive_analysis/&title=Milvus 搜索流程全面分析"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://szza.github.io/2025/08/10/Milvus/19_search_flow_comprehensive_analysis/&name=Milvus 搜索流程全面分析&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://szza.github.io/2025/08/10/Milvus/19_search_flow_comprehensive_analysis/&t=Milvus 搜索流程全面分析"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2021-2026
    fibonaccii
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives">archives</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

    <script async src="https://www.googletagmanager.com/gtag/js?id=szza"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'szza');
    </script>

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->


</body>
</html>
