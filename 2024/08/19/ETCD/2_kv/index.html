<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="KVetcd 采用双层存储架构：  TreeIndex: 内存中的 B-tree 索引，存储 user_key 到 revision 的映射， 管理 user_key 的所有历史生命周期 BoltDB: 持久化存储，存储 revision 到 KeyValue 的映射  传统设计: key → KeyValue 只能存储最新值， ETCD 的 ‘{revision, KeyValue}’ 映射支持">
<meta property="og:type" content="article">
<meta property="og:title" content="剖析 ETCD.kvstore">
<meta property="og:url" content="https://szza.github.io/2024/08/19/ETCD/2_kv/index.html">
<meta property="og:site_name" content="szza">
<meta property="og:description" content="KVetcd 采用双层存储架构：  TreeIndex: 内存中的 B-tree 索引，存储 user_key 到 revision 的映射， 管理 user_key 的所有历史生命周期 BoltDB: 持久化存储，存储 revision 到 KeyValue 的映射  传统设计: key → KeyValue 只能存储最新值， ETCD 的 ‘{revision, KeyValue}’ 映射支持">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2024-08-19T14:11:49.000Z">
<meta property="article:modified_time" content="2025-10-23T13:03:48.245Z">
<meta property="article:author" content="fibonaccii">
<meta property="article:tag" content="ETCD">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/id.jpg">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/id.jpg" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/id.jpg">
        
      
    
    <!-- title -->
    <title>剖析 ETCD.kvstore</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="szza" type="application/atom+xml">
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives">archives</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2024/09/03/ETCD/3_mvcc/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2024/08/01/ETCD/1_backend/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://szza.github.io/2024/08/19/ETCD/2_kv/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://szza.github.io/2024/08/19/ETCD/2_kv/&text=剖析 ETCD.kvstore"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://szza.github.io/2024/08/19/ETCD/2_kv/&title=剖析 ETCD.kvstore"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://szza.github.io/2024/08/19/ETCD/2_kv/&is_video=false&description=剖析 ETCD.kvstore"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=剖析 ETCD.kvstore&body=Check out this article: https://szza.github.io/2024/08/19/ETCD/2_kv/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://szza.github.io/2024/08/19/ETCD/2_kv/&title=剖析 ETCD.kvstore"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://szza.github.io/2024/08/19/ETCD/2_kv/&title=剖析 ETCD.kvstore"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://szza.github.io/2024/08/19/ETCD/2_kv/&title=剖析 ETCD.kvstore"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://szza.github.io/2024/08/19/ETCD/2_kv/&title=剖析 ETCD.kvstore"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://szza.github.io/2024/08/19/ETCD/2_kv/&name=剖析 ETCD.kvstore&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://szza.github.io/2024/08/19/ETCD/2_kv/&t=剖析 ETCD.kvstore"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#KV"><span class="toc-number">1.</span> <span class="toc-text">KV</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#View-%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.0.1.</span> <span class="toc-text">View 设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Txn"><span class="toc-number">1.0.2.</span> <span class="toc-text">Txn</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#storeTxnRead"><span class="toc-number">1.0.2.1.</span> <span class="toc-text">storeTxnRead</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#storeTxnWrite"><span class="toc-number">1.0.2.2.</span> <span class="toc-text">storeTxnWrite</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#lock"><span class="toc-number">1.0.2.3.</span> <span class="toc-text">lock</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Revision"><span class="toc-number">1.0.3.</span> <span class="toc-text">Revision</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Store-%E4%B8%AD%E7%9A%84-Revision-%E7%AE%A1%E7%90%86"><span class="toc-number">1.0.3.1.</span> <span class="toc-text">Store 中的 Revision 管理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AF%BB%E4%BA%8B%E5%8A%A1%E4%B8%AD%E7%9A%84-Revision"><span class="toc-number">1.0.3.1.1.</span> <span class="toc-text">读事务中的 Revision</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%86%99%E4%BA%8B%E5%8A%A1%E4%B8%AD%E7%9A%84-Revision"><span class="toc-number">1.0.3.1.2.</span> <span class="toc-text">写事务中的 Revision</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#KeyIndex"><span class="toc-number">1.0.4.</span> <span class="toc-text">KeyIndex</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Generation"><span class="toc-number">1.0.4.1.</span> <span class="toc-text">Generation</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#put"><span class="toc-number">1.0.4.2.</span> <span class="toc-text">put</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#tombstone"><span class="toc-number">1.0.4.3.</span> <span class="toc-text">tombstone</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#get"><span class="toc-number">1.0.4.4.</span> <span class="toc-text">get</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#findGeneration"><span class="toc-number">1.0.4.4.1.</span> <span class="toc-text">findGeneration</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#walk"><span class="toc-number">1.0.4.4.2.</span> <span class="toc-text">walk</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mvccpb-KeyValue"><span class="toc-number">1.0.5.</span> <span class="toc-text">mvccpb.KeyValue</span></a></li></ol></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        剖析 ETCD.kvstore
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">fibonaccii</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-08-19T14:11:49.000Z" itemprop="datePublished">2024-08-19</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/ETCD/" rel="tag">ETCD</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h1 id="KV"><a href="#KV" class="headerlink" title="KV"></a>KV</h1><p>etcd 采用双层存储架构：</p>
<ul>
<li><code>TreeIndex</code>: 内存中的 B-tree 索引，存储 <code>user_key</code> 到 <code>revision</code> 的映射， 管理 user_key 的所有历史生命周期</li>
<li><code>BoltDB</code>: 持久化存储，存储 <code>revision</code> 到 <code>KeyValue</code> 的映射</li>
</ul>
<p>传统设计: key → KeyValue 只能存储最新值， ETCD 的 ‘{revision, KeyValue}’ 映射支持历史版本存储,<code>revision</code> 作为全局单调递增的版本。</p>
<h3 id="View-设计"><a href="#View-设计" class="headerlink" title="View 设计"></a>View 设计</h3><p>先介绍下 KV 中的两个 VIEW Inteface: ReadView、WriteView 。这两个 VIEW 提供了基本的读写接口，既是 KV Store 需要实现的接口，也是应用层向 KV Store 写入数据的接口。因此，出于最小职责原理，将这公共接口抽象成 ReadView、WriteView。 <strong>上层无需要知道完整的 KV Store Interface</strong>，只需要使用 ReadView、WriteView Inteface 中提供的函数就行。</p>
<p>这里的 <code>VIEW</code> 是 <code>Store</code> 是一种”引用”、”指针” 的语义。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ReadView <span class="keyword">interface</span> &#123;</span><br><span class="line">	FirstRev() <span class="type">int64</span></span><br><span class="line">	Rev() <span class="type">int64</span></span><br><span class="line">    Range(ctx context.Context, key, end []<span class="type">byte</span>, ro RangeOptions) (r *RangeResult, err <span class="type">error</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> WriteView <span class="keyword">interface</span> &#123;</span><br><span class="line">	DeleteRange(key, end []<span class="type">byte</span>) (n, rev <span class="type">int64</span>)</span><br><span class="line">	Put(key, value []<span class="type">byte</span>, lease lease.LeaseID) (rev <span class="type">int64</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因此 ReadView、WriteView 的实现 <code>readView</code>、<code>writeVie</code> 也是 KV Stroe 的 wrapper。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> readView <span class="keyword">struct</span>&#123; kv KV &#125;</span><br><span class="line"><span class="keyword">type</span> writeView <span class="keyword">struct</span>&#123; kv KV &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> KV <span class="keyword">interface</span> &#123;</span><br><span class="line">    ReadView</span><br><span class="line">    WriteView</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read creates a read transaction.</span></span><br><span class="line">    Read(mode ReadTxMode, trace *traceutil.Trace) TxnRead</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Write creates a write transaction.</span></span><br><span class="line">    Write(trace *traceutil.Trace) TxnWrite</span><br><span class="line"></span><br><span class="line">    <span class="comment">// HashStorage returns HashStorage interface for KV storage.</span></span><br><span class="line">    HashStorage() HashStorage</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Compact frees all superseded keys with revisions less than rev.</span></span><br><span class="line">    Compact(trace *traceutil.Trace, rev <span class="type">int64</span>) (&lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;, <span class="type">error</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Commit commits outstanding txns into the underlying backend.</span></span><br><span class="line">    Commit()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Restore restores the KV store from a backend.</span></span><br><span class="line">    Restore(b backend.Backend) <span class="type">error</span></span><br><span class="line">    Close() <span class="type">error</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这么设计就能良好的隔离应用层和 KV Store，只暴露给应用层基本都读写接口。</p>
<h3 id="Txn"><a href="#Txn" class="headerlink" title="Txn"></a>Txn</h3><p>ETCD 中任何读写操作都需要先基于 KV Store 的 <code>Read</code> 、<code>Write</code> Interface 创建 Transaction，然后在 Transaction 中完成具体的操作。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TxnRead represents a read-only transaction with operations that will not</span></span><br><span class="line"><span class="comment">// block other read transactions.</span></span><br><span class="line"><span class="keyword">type</span> TxnRead <span class="keyword">interface</span> &#123;</span><br><span class="line">	ReadView</span><br><span class="line">	<span class="comment">// End marks the transaction is complete and ready to commit.</span></span><br><span class="line">	End()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> TxnWrite <span class="keyword">interface</span> &#123;</span><br><span class="line">	TxnRead</span><br><span class="line">	WriteView</span><br><span class="line">	<span class="comment">// Changes gets the changes made since opening the write txn.</span></span><br><span class="line">	Changes() []mvccpb.KeyValue</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// txnReadWrite coerces a read txn to a write, panicking on any write operation.</span></span><br><span class="line"><span class="keyword">type</span> txnReadWrite <span class="keyword">struct</span>&#123; TxnRead &#125;</span><br></pre></td></tr></table></figure>

<h4 id="storeTxnRead"><a href="#storeTxnRead" class="headerlink" title="storeTxnRead"></a>storeTxnRead</h4><p>TxnRead 的生命周期</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    读事务生命周期                             │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│  1. kvstore.Read()                                            │</span><br><span class="line">│     ├─ s.mu.RLock()                                         │</span><br><span class="line">│     ├─ s.revMu.RLock()                                      │</span><br><span class="line">│     ├─ 选择ReadTx模式                                        │</span><br><span class="line">│     ├─ tx.RLock()                                           │</span><br><span class="line">│     └─ 返回storeTxnRead                                      │</span><br><span class="line">│                                                             │</span><br><span class="line">│  2. 执行读操作                                                │</span><br><span class="line">│     ├─ tr.Range()                                           │</span><br><span class="line">│     ├─ tr.Rev()                                             │</span><br><span class="line">│     └─ tr.FirstRev()                                        │</span><br><span class="line">│                                                             │</span><br><span class="line">│  3. tr.End()                                                │</span><br><span class="line">│     ├─ tr.tx.RUnlock()                                      │</span><br><span class="line">│     └─ tr.s.mu.RUnlock()                                    │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>
<p>step-1, step-3 具体实现如下:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> storeTxnRead <span class="keyword">struct</span> &#123;</span><br><span class="line">    s  *store</span><br><span class="line">    tx backend.ReadTx</span><br><span class="line">    </span><br><span class="line">    firstRev <span class="type">int64</span>  <span class="comment">// 第一个版本</span></span><br><span class="line">    rev      <span class="type">int64</span>  <span class="comment">// 当前版本</span></span><br><span class="line">    </span><br><span class="line">    trace *traceutil.Trace</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *store)</span></span> Read(mode ReadTxMode, trace *traceutil.Trace) TxnRead &#123;</span><br><span class="line">    s.mu.RLock()</span><br><span class="line">    s.revMu.RLock()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> tx backend.ReadTx</span><br><span class="line">    <span class="keyword">if</span> mode == ConcurrentReadTxMode &#123;</span><br><span class="line">        tx = s.b.ConcurrentReadTx()  <span class="comment">// 并发读事务</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        tx = s.b.ReadTx()            <span class="comment">// 共享缓冲读事务</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    tx.RLock()</span><br><span class="line">    firstRev, rev := s.compactMainRev, s.currentRev</span><br><span class="line">    s.revMu.RUnlock()</span><br><span class="line">    <span class="keyword">return</span> newMetricsTxnRead(&amp;storeTxnRead&#123;s, tx, firstRev, rev, trace&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(tr *storeTxnRead)</span></span> End() &#123;</span><br><span class="line">    tr.tx.RUnlock() <span class="comment">// RUnlock signals the end of concurrentReadTx.</span></span><br><span class="line">    tr.s.mu.RUnlock()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="storeTxnWrite"><a href="#storeTxnWrite" class="headerlink" title="storeTxnWrite"></a>storeTxnWrite</h4><p>TxnWrite 生命周期如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    写事务生命周期                             │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│  1. store.Write()                                           │</span><br><span class="line">│     ├─ s.mu.RLock()                                         │</span><br><span class="line">│     ├─ tx.LockInsideApply()                                 │</span><br><span class="line">│     └─ 返回storeTxnWrite                                     │</span><br><span class="line">│                                                             │</span><br><span class="line">│  2. 执行写操作                                                │</span><br><span class="line">│     ├─ tw.Put()                                             │</span><br><span class="line">│     ├─ tw.DeleteRange()                                     │</span><br><span class="line">│     ├─ tw.Range() (读操作)                                   │</span><br><span class="line">│     └─ 记录变更到changes                                      │</span><br><span class="line">│                                                             │</span><br><span class="line">│  3. tw.End()                                                │</span><br><span class="line">│     ├─ 如果有变更：                                           │</span><br><span class="line">│     │  ├─ tw.s.revMu.Lock()                                 │</span><br><span class="line">│     │  └─ tw.s.currentRev++                                 │</span><br><span class="line">│     ├─ tw.tx.Unlock()                                       │</span><br><span class="line">│     ├─ 如果有变更：tw.s.revMu.Unlock()                        │</span><br><span class="line">│     └─ tw.s.mu.RUnlock()                                    │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>
<p>step-1, step-3 具体实现如下</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> storeTxnWrite <span class="keyword">struct</span> &#123;</span><br><span class="line">    storeTxnRead</span><br><span class="line">    tx backend.BatchTx</span><br><span class="line">    <span class="comment">// beginRev is the revision where the txn begins; it will write to the next revision.</span></span><br><span class="line">    beginRev <span class="type">int64</span></span><br><span class="line">    changes  []mvccpb.KeyValue</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *store)</span></span> Write(trace *traceutil.Trace) TxnWrite &#123;</span><br><span class="line">    s.mu.RLock()</span><br><span class="line">    tx := s.b.BatchTx()</span><br><span class="line">    tx.LockInsideApply()</span><br><span class="line">    tw := &amp;storeTxnWrite&#123;</span><br><span class="line">        storeTxnRead: storeTxnRead&#123;s, tx, <span class="number">0</span>, <span class="number">0</span>, trace&#125;,</span><br><span class="line">        tx:           tx,</span><br><span class="line">        beginRev:     s.currentRev,</span><br><span class="line">        changes:      <span class="built_in">make</span>([]mvccpb.KeyValue, <span class="number">0</span>, <span class="number">4</span>),</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> newMetricsTxnWrite(tw)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(tw *storeTxnWrite)</span></span> End() &#123;</span><br><span class="line">    <span class="comment">// only update index if the txn modifies the mvcc state.</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(tw.changes) != <span class="number">0</span> &#123;</span><br><span class="line">        <span class="comment">// hold revMu lock to prevent new read txns from opening until writeback.</span></span><br><span class="line">        tw.s.revMu.Lock()</span><br><span class="line">        tw.s.currentRev++ <span class="comment">// 存在变更则 version++</span></span><br><span class="line">    &#125;</span><br><span class="line">    tw.tx.Unlock()</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(tw.changes) != <span class="number">0</span> &#123;</span><br><span class="line">        tw.s.revMu.Unlock()</span><br><span class="line">    &#125;</span><br><span class="line">    tw.s.mu.RUnlock()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="lock"><a href="#lock" class="headerlink" title="lock"></a>lock</h4><p><code>store</code> 中新增了两个锁:<code>mu</code> 、<code>recvMu</code>:</p>
<ul>
<li><code>mu</code> 是个 RWMutex, 写锁是为了 stroe 的状态变更，读锁是用于事物<br>-<code>recvMu</code> 是为了版本控制线程安全。</li>
</ul>
<p>注意: <code>store.Read</code> 和 <code>store.Write</code> 在创建事物时，都是用的读锁 <code>s.mu.RLock()</code>, 配合 <code>recvMu</code> 进行细粒度的控制版本变更，使得 Transaction 的创建行为不会有相互堵塞。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> store <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// mu read locks for txns and write locks for non-txn store changes.</span></span><br><span class="line">    mu sync.RWMutex</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// revMuLock protects currentRev and compactMainRev.</span></span><br><span class="line">    <span class="comment">// Locked at end of write txn and released after write txn unlock lock.</span></span><br><span class="line">    <span class="comment">// Locked before locking read txn and released after locking.</span></span><br><span class="line">    revMu sync.RWMutex</span><br><span class="line">    </span><br><span class="line">    currentRev     <span class="type">int64</span>  <span class="comment">// 当前版本</span></span><br><span class="line">    compactMainRev <span class="type">int64</span>  <span class="comment">// 压缩版本</span></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Lock 层次如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    锁层次结构                                 │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │</span><br><span class="line">│  │   store.mu  │  │  store.revMu│  │   backend.tx        │ │</span><br><span class="line">│  │  (RWMutex)  │  │  (RWMutex)  │  │   (Mutex/RWMutex)   │ │</span><br><span class="line">│  │             │  │             │  │                     │ │</span><br><span class="line">│  │ • 保护store  │  │ • 保护版本   │  │ • 保护后端事务        │ │</span><br><span class="line">│  │ • 读写分离   │  │ • 版本控制    │  │ • 事务隔离           │ │</span><br><span class="line">│  │ • 全局状态   │  │ • 原子更新    │  │ • 数据一致性          │ │</span><br><span class="line">│  └─────────────┘  └─────────────┘  └─────────────────────┘ │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="Revision"><a href="#Revision" class="headerlink" title="Revision"></a>Revision</h3><p>etcd 的 Revision 设计基于 MVCC 模型，主要包含以下核心概念：</p>
<ul>
<li><code>Main Revision</code>: 全局递增的事务版本号，每次写事务都会递增</li>
<li><code>Sub Revision</code>: 同一事务内多个操作的子版本号，从 0 开始递增</li>
<li><code>Generation</code>: 键的生命周期，从创建到删除为一个 generation</li>
<li><code>Tombstone</code>: 删除标记，用于标记键的删除状态</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> revision <span class="keyword">struct</span> &#123;</span><br><span class="line">    main <span class="type">int64</span>  <span class="comment">// 主版本号，全局递增</span></span><br><span class="line">    sub  <span class="type">int64</span>  <span class="comment">// 子版本号，事务内递增</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 编码格式：8字节 main + 1字节分隔符&#x27;_&#x27; + 8字节sub</span></span><br><span class="line"><span class="keyword">const</span> revBytesLen = <span class="number">8</span> + <span class="number">1</span> + <span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">revToBytes</span><span class="params">(rev revision, bytes []<span class="type">byte</span>)</span></span> &#123;</span><br><span class="line">    binary.BigEndian.PutUint64(bytes, <span class="type">uint64</span>(rev.main))</span><br><span class="line">    bytes[<span class="number">8</span>] = <span class="string">&#x27;_&#x27;</span></span><br><span class="line">    binary.BigEndian.PutUint64(bytes[<span class="number">9</span>:], <span class="type">uint64</span>(rev.sub))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 比较逻辑</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a revision)</span></span> GreaterThan(b revision) <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> a.main &gt; b.main &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> a.main &lt; b.main &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> a.sub &gt; b.sub  <span class="comment">// main相等时比较sub</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Store-中的-Revision-管理"><a href="#Store-中的-Revision-管理" class="headerlink" title="Store 中的 Revision 管理"></a>Store 中的 Revision 管理</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> store <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// 保护 currentRev 和 compactMainRev 的锁</span></span><br><span class="line">    revMu sync.RWMutex</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 当前最新的 revision (main部分)</span></span><br><span class="line">    currentRev <span class="type">int64</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 最后一次压缩的 revision (main部分) , FirstRev</span></span><br><span class="line">    compactMainRev <span class="type">int64</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="读事务中的-Revision"><a href="#读事务中的-Revision" class="headerlink" title="读事务中的 Revision"></a>读事务中的 Revision</h5><p>读事务特点：</p>
<ul>
<li>使用 firstRev 和 rev 确定可读的版本范围</li>
<li><strong>不会修改 <code>currentRev</code></strong></li>
<li>支持历史版本查询</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *store)</span></span> Read(mode ReadTxMode, trace *traceutil.Trace) TxnRead &#123;</span><br><span class="line">    s.mu.RLock()</span><br><span class="line">    s.revMu.RLock()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取当前 revision 信息</span></span><br><span class="line">    firstRev, rev := s.compactMainRev, s.currentRev</span><br><span class="line">    </span><br><span class="line">    s.revMu.RUnlock()</span><br><span class="line">    <span class="keyword">return</span> &amp;storeTxnRead&#123;s, tx, firstRev, rev, trace&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="写事务中的-Revision"><a href="#写事务中的-Revision" class="headerlink" title="写事务中的 Revision"></a>写事务中的 Revision</h5><p>写事务开始: <code>beginRev</code> &#x3D; <code>currentRev</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *store)</span></span> Write(trace *traceutil.Trace) TxnWrite &#123;</span><br><span class="line">    s.mu.RLock()</span><br><span class="line">    tx := s.b.BatchTx()</span><br><span class="line">    tx.LockInsideApply()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 记录事务开始时的 revision</span></span><br><span class="line">    tw := &amp;storeTxnWrite&#123;</span><br><span class="line">        beginRev: s.currentRev,  <span class="comment">// 事务开始时的 revision</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> tw</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>操作执行: </p>
<ul>
<li>每个操作使得 <code>beginRev</code> + 1 作为 Main revision</li>
<li>Sub revision: 同一事务内从 0 开始递增</li>
<li>事务提交: currentRev++，更新全局版本号</li>
</ul>
<p> 在整个写事物生命周期内，Main revision 都是 <code>beginRev</code> + 1, <code>storeTxnWrite.Put</code> 会每次只会自增一次 Sub Revision。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(tw *storeTxnWrite)</span></span> Put(key, value []<span class="type">byte</span>, lease lease.LeaseID) <span class="type">int64</span> &#123;</span><br><span class="line">	tw.put(key, value, lease)</span><br><span class="line">	<span class="keyword">return</span> tw.beginRev + <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(tw *storeTxnWrite)</span></span> DeleteRange(key, end []<span class="type">byte</span>) (<span class="type">int64</span>, <span class="type">int64</span>) &#123;</span><br><span class="line">	<span class="keyword">if</span> n := tw.deleteRange(key, end); n != <span class="number">0</span> || <span class="built_in">len</span>(tw.changes) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> n, tw.beginRev + <span class="number">1</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>, tw.beginRev</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(tw *storeTxnWrite)</span></span> End() &#123;</span><br><span class="line">	<span class="comment">// only update index if the txn modifies the mvcc state.</span></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(tw.changes) != <span class="number">0</span> &#123;</span><br><span class="line">		<span class="comment">// hold revMu lock to prevent new read txns from opening until writeback.</span></span><br><span class="line">		tw.s.revMu.Lock()</span><br><span class="line">		tw.s.currentRev++ <span class="comment">// 更新全局 revision</span></span><br><span class="line">	&#125;</span><br><span class="line">	tw.tx.Unlock()</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(tw.changes) != <span class="number">0</span> &#123;</span><br><span class="line">		tw.s.revMu.Unlock()</span><br><span class="line">	&#125;</span><br><span class="line">	tw.s.mu.RUnlock()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="KeyIndex"><a href="#KeyIndex" class="headerlink" title="KeyIndex"></a>KeyIndex</h3><p>ETCD 中 <code>treeIndex</code> 是一个 B-Tree，存储着所有 Key 的历史版本信息，用于 MVCC. <code>keyIndex</code> 则存储着单个 key 的版本历史信息，他们的层次关系:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">┌────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    treeIndex (B-tree)                      │</span><br><span class="line">│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │</span><br><span class="line">│  │  keyIndex   │  │  keyIndex   │  │  keyIndex   │         │</span><br><span class="line">│  │   &quot;foo&quot;     │  │   &quot;bar&quot;     │  │   &quot;baz&quot;     │         │</span><br><span class="line">│  └─────────────┘  └─────────────┘  └─────────────┘         │</span><br><span class="line">└────────────────────────────────────────────────────────────┘</span><br><span class="line">                              │</span><br><span class="line">                              ▼</span><br><span class="line">┌────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    keyIndex &quot;foo&quot;                          │</span><br><span class="line">│  key: &quot;foo&quot;                                                │</span><br><span class="line">│  modified: 103.0                                           │</span><br><span class="line">│  generations: [gen0, gen1, gen2]                           │</span><br><span class="line">└────────────────────────────────────────────────────────────┘</span><br><span class="line">                              │</span><br><span class="line">                              ▼</span><br><span class="line">┌────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    generation                              │</span><br><span class="line">│  ver: 3                                                    │</span><br><span class="line">│  created: 100.0                                            │</span><br><span class="line">│  revs: [100.0, 101.0, 102.0]                               │</span><br><span class="line">└────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>
<h4 id="Generation"><a href="#Generation" class="headerlink" title="Generation"></a>Generation</h4><p>Generation 表示一个 key 的生命周期，从 <strong>创建</strong> 到 <strong>删除</strong> 为一个完整的 generation。 <code>keyIndex</code> 与 <code>Generation</code> 关系如下:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> keyIndex <span class="keyword">struct</span> &#123;</span><br><span class="line">    key         []<span class="type">byte</span>        <span class="comment">// 用户键</span></span><br><span class="line">    modified    revision      <span class="comment">// 最后修改的 revision</span></span><br><span class="line">    generations []generation  <span class="comment">// 该键的所有 generation</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> generation <span class="keyword">struct</span> &#123;</span><br><span class="line">    ver     <span class="type">int64</span>      <span class="comment">// key 在这个 generation 的修改次数</span></span><br><span class="line">    created revision   <span class="comment">// generation 创建时的 revision</span></span><br><span class="line">    revs    []revision <span class="comment">// 该 generation 中的所有 revision</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Generation 生命周期示例如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">键 &quot;foo&quot; 的操作序列:</span><br><span class="line">put(1.0) → put(2.0) → delete(3.0) → put(4.0) → delete(5.0)</span><br><span class="line"></span><br><span class="line">keyIndex 结构:</span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│ key: &quot;foo&quot;                                                  │</span><br><span class="line">│ modified: 5.0                                               │</span><br><span class="line">│ generations:                                                │</span><br><span class="line">│   ┌───────────────────────────────────────────────────────┐ │</span><br><span class="line">│   │ Generation 0: &#123;empty&#125;                                 │ │</span><br><span class="line">│   │   ver: 0, created: &#123;&#125;, revs: []                       │ │</span><br><span class="line">│   └───────────────────────────────────────────────────────┘ │</span><br><span class="line">│   ┌───────────────────────────────────────────────────────┐ │</span><br><span class="line">│   │ Generation 1: &#123;4.0, 5.0(t)&#125;                           │ │</span><br><span class="line">│   │   ver: 2, created: 4.0, revs: [4.0, 5.0]              │ │</span><br><span class="line">│   └───────────────────────────────────────────────────────┘ │</span><br><span class="line">│   ┌───────────────────────────────────────────────────────┐ │</span><br><span class="line">│   │ Generation 2: &#123;1.0, 2.0, 3.0(t)&#125;                      │ │</span><br><span class="line">│   │   ver: 3, created: 1.0, revs: [1.0, 2.0, 3.0]         │ │</span><br><span class="line">│   └───────────────────────────────────────────────────────┘ │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>
<h4 id="put"><a href="#put" class="headerlink" title="put"></a>put</h4><p>在 keyIndex 中 put 一个 <code>key</code> 新的版本信息 <code>&#123;main, sub&#125;</code>，行为如下:</p>
<ul>
<li>通过 <code>ki.modified</code> 来确保 revision 的单调递增</li>
<li>无论这个 key 是首次 put，或者是 delete 之后又 put, generation 的第一个 revision 都会更新<code>generation.created</code> 字段</li>
<li>更新 <code>ki.modified</code> 为当前的 <code>rev</code>，用于保证后续 put 的单调性</li>
<li>g.ver 记录这个 generation 的 put 次数</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// put puts a revision to the keyIndex.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ki *keyIndex)</span></span> put(lg *zap.Logger, main <span class="type">int64</span>, sub <span class="type">int64</span>) &#123;</span><br><span class="line">	rev := revision&#123;main: main, sub: sub&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> !rev.GreaterThan(ki.modified) &#123;</span><br><span class="line">		<span class="built_in">panic</span>()</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(ki.generations) == <span class="number">0</span> &#123;</span><br><span class="line">		ki.generations = <span class="built_in">append</span>(ki.generations, generation&#123;&#125;)</span><br><span class="line">	&#125;</span><br><span class="line">	g := &amp;ki.generations[<span class="built_in">len</span>(ki.generations)<span class="number">-1</span>]</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(g.revs) == <span class="number">0</span> &#123; <span class="comment">// create a new key</span></span><br><span class="line">		keysGauge.Inc()</span><br><span class="line">		g.created = rev <span class="comment">// &#x27;new key&#x27; or &#x27;delete -&gt; put&#x27; 都会更新 g.created</span></span><br><span class="line">	&#125;</span><br><span class="line">	g.revs = <span class="built_in">append</span>(g.revs, rev) <span class="comment">// 所有历史信息</span></span><br><span class="line">	g.ver++</span><br><span class="line">	ki.modified = rev</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="tombstone"><a href="#tombstone" class="headerlink" title="tombstone"></a>tombstone</h4><p>删除一个 key, 在 keyIndex 中是先写入一个 <code>&#123;main,sub&#125;</code>，再紧跟着一个 marker(空 generation)</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ki *keyIndex)</span></span> tombstone(lg *zap.Logger, main <span class="type">int64</span>, sub <span class="type">int64</span>) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> ki.isEmpty() &#123;</span><br><span class="line">		lg.Panic(</span><br><span class="line">			<span class="string">&quot;&#x27;tombstone&#x27; got an unexpected empty keyIndex&quot;</span>,</span><br><span class="line">			zap.String(<span class="string">&quot;key&quot;</span>, <span class="type">string</span>(ki.key)),</span><br><span class="line">		)</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// 不能 delete 之后再次 delete</span></span><br><span class="line">	<span class="keyword">if</span> ki.generations[<span class="built_in">len</span>(ki.generations)<span class="number">-1</span>].isEmpty() &#123;</span><br><span class="line">		<span class="keyword">return</span> ErrRevisionNotFound</span><br><span class="line">	&#125;</span><br><span class="line">	ki.put(lg, main, sub)</span><br><span class="line">	ki.generations = <span class="built_in">append</span>(ki.generations, generation&#123;&#125;)</span><br><span class="line">	keysGauge.Dec()</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="get"><a href="#get" class="headerlink" title="get"></a>get</h4><p><code>get</code> 是 ETCD 用于查询 key, value 历史版本的核心方法。算法设计:</p>
<ul>
<li><p><code>findGeneration</code>: 从最新 generation 开始向前搜索，找到包含指定 revision 的 generation</p>
</li>
<li><p><code>walk</code>: 在 generation 内从最新 revision 开始向前遍历，找到符合条件的 revision</p>
</li>
<li><p>版本号计算: 通过公式 <code>ver = g.ver - (len(g.revs) - n - 1)</code> 精确计算版本号</p>
<p> 这个公式可以简单理解为 <code>ver = n + 1</code>，表征 <code>generation</code> 第几次修改</p>
</li>
</ul>
<p>优势:</p>
<ul>
<li>具有高效性: O(g + r) 的时间复杂度，其中 g 和 r 通常都很小。 </li>
<li>一致性: 确保查询结果与指定 revision 时刻一致 </li>
<li>可扩展性: 支持大规模数据和高并发访问 </li>
<li>空间效率: 通过 generation 结构优化存储</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// get gets the modified, created revision and version of the key that satisfies the given atRev.</span></span><br><span class="line"><span class="comment">// Rev must be higher than or equal to the given atRev.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ki *keyIndex)</span></span> get(lg *zap.Logger, atRev <span class="type">int64</span>) (modified, created revision, ver <span class="type">int64</span>, err <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">if</span> ki.isEmpty() &#123;</span><br><span class="line">		lg.Panic(</span><br><span class="line">			<span class="string">&quot;&#x27;get&#x27; got an unexpected empty keyIndex&quot;</span>,</span><br><span class="line">			zap.String(<span class="string">&quot;key&quot;</span>, <span class="type">string</span>(ki.key)),</span><br><span class="line">		)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 先找到 atRev 所在的 generation</span></span><br><span class="line">	g := ki.findGeneration(atRev)</span><br><span class="line">	<span class="keyword">if</span> g.isEmpty() &#123;</span><br><span class="line">		<span class="keyword">return</span> revision&#123;&#125;, revision&#123;&#125;, <span class="number">0</span>, ErrRevisionNotFound</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	n := g.walk(<span class="function"><span class="keyword">func</span><span class="params">(rev revision)</span></span> <span class="type">bool</span> &#123; <span class="keyword">return</span> rev.main &gt; atRev &#125;)</span><br><span class="line">	<span class="keyword">if</span> n != <span class="number">-1</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> g.revs[n], g.created, g.ver - <span class="type">int64</span>(<span class="built_in">len</span>(g.revs)-n<span class="number">-1</span>), <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> revision&#123;&#125;, revision&#123;&#125;, <span class="number">0</span>, ErrRevisionNotFound</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="findGeneration"><a href="#findGeneration" class="headerlink" title="findGeneration"></a>findGeneration</h5><p>利用时间局部性原理，从最新 generation 到最旧的 generation 的策略进行搜索，以此来支持历史版本查询。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ki *keyIndex)</span></span> findGeneration(rev <span class="type">int64</span>) *generation &#123;</span><br><span class="line">	lastg := <span class="built_in">len</span>(ki.generations) - <span class="number">1</span></span><br><span class="line">	cg := lastg</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> cg &gt;= <span class="number">0</span> &#123;</span><br><span class="line">        <span class="comment">//  跳过空的 generation</span></span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(ki.generations[cg].revs) == <span class="number">0</span> &#123;</span><br><span class="line">			cg--</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		g := ki.generations[cg]</span><br><span class="line">		<span class="keyword">if</span> cg != lastg &#123;</span><br><span class="line">            <span class="comment">// Tombstone 检查: 说明 rev 在两个 generation 的间隙</span></span><br><span class="line">			<span class="keyword">if</span> tomb := g.revs[<span class="built_in">len</span>(g.revs)<span class="number">-1</span>].main; tomb &lt;= rev &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">// 找到所属的 generation</span></span><br><span class="line">		<span class="keyword">if</span> g.revs[<span class="number">0</span>].main &lt;= rev &#123;</span><br><span class="line">			<span class="keyword">return</span> &amp;ki.generations[cg]</span><br><span class="line">		&#125;</span><br><span class="line">		cg--</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="walk"><a href="#walk" class="headerlink" title="walk"></a>walk</h5><p><code>walk</code> 函数也是根据 <strong>时间局部性原理</strong> 进行遍历，返回符合条件的位置索引 <code>l-i-1</code>，那么上层 <code>keyIndex.get</code> 返回的 <code>ver = g.ver - (l - i - 1)</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(g *generation)</span></span> walk(f <span class="function"><span class="keyword">func</span><span class="params">(rev revision)</span></span> <span class="type">bool</span>) <span class="type">int</span> &#123;</span><br><span class="line">	l := <span class="built_in">len</span>(g.revs)</span><br><span class="line">	<span class="keyword">for</span> i := <span class="keyword">range</span> g.revs &#123;</span><br><span class="line">		ok := f(g.revs[l-i<span class="number">-1</span>])</span><br><span class="line">		<span class="keyword">if</span> !ok &#123;</span><br><span class="line">			<span class="keyword">return</span> l - i - <span class="number">1</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="mvccpb-KeyValue"><a href="#mvccpb-KeyValue" class="headerlink" title="mvccpb.KeyValue"></a>mvccpb.KeyValue</h3><p>写入 BlotDB 的 value 是 <code>mvccpb.KeyValue</code>:</p>
<ul>
<li>CreateRevision：全局作用域，记录键的创建时间。只在键首次创建时设置，之后保持不变, 用于历史查询和键的生命周期管理</li>
<li>ModRevision：全局作用域，记录键的最后修改时间。每次修改都会更新为当前 revision, 用于版本比较、Watch 机制和压缩</li>
<li>Version：generation 作用域，记录键在 generation 内的修改次数。每次修改递增，删除后重置为 0, 用于版本一致性检查和压缩优化</li>
</ul>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">message </span><span class="title class_">KeyValue</span> &#123;</span><br><span class="line">  <span class="comment">// key is the key in bytes. An empty key is not allowed.</span></span><br><span class="line">  <span class="type">bytes</span> key = <span class="number">1</span>;</span><br><span class="line">  <span class="comment">// create_revision is the revision of last creation on this key.</span></span><br><span class="line">  <span class="type">int64</span> create_revision = <span class="number">2</span>;</span><br><span class="line">  <span class="comment">// mod_revision is the revision of last modification on this key.</span></span><br><span class="line">  <span class="type">int64</span> mod_revision = <span class="number">3</span>;</span><br><span class="line">  <span class="comment">// version is the version of the key. A deletion resets</span></span><br><span class="line">  <span class="comment">// the version to zero and any modification of the key</span></span><br><span class="line">  <span class="comment">// increases its version.</span></span><br><span class="line">  <span class="type">int64</span> version = <span class="number">4</span>;</span><br><span class="line">  <span class="comment">// value is the value held by the key, in bytes.</span></span><br><span class="line">  <span class="type">bytes</span> value = <span class="number">5</span>;</span><br><span class="line">  <span class="comment">// lease is the ID of the lease that attached to key.</span></span><br><span class="line">  <span class="comment">// When the attached lease expires, the key will be deleted.</span></span><br><span class="line">  <span class="comment">// If lease is 0, then no lease is attached to the key.</span></span><br><span class="line">  <span class="type">int64</span> lease = <span class="number">6</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>storeTxnWrite.put 写入</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(tw *storeTxnWrite)</span></span> put(key, value []<span class="type">byte</span>, leaseID lease.LeaseID) &#123;</span><br><span class="line">	rev := tw.beginRev + <span class="number">1</span></span><br><span class="line">	c := rev</span><br><span class="line">	oldLease := lease.NoLease</span><br><span class="line"></span><br><span class="line">	<span class="comment">// if the key exists before, use its previous created and</span></span><br><span class="line">	<span class="comment">// get its previous leaseID</span></span><br><span class="line">	_, created, ver, err := tw.s.kvindex.Get(key, rev)</span><br><span class="line">	<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">		c = created.main</span><br><span class="line">		oldLease = tw.s.le.GetLease(lease.LeaseItem&#123;Key: <span class="type">string</span>(key)&#125;)</span><br><span class="line">		tw.trace.Step(<span class="string">&quot;get key&#x27;s previous created_revision and leaseID&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	ibytes := newRevBytes()</span><br><span class="line">	idxRev := revision&#123;</span><br><span class="line">		main: rev,</span><br><span class="line">		sub:  <span class="type">int64</span>(<span class="built_in">len</span>(tw.changes)),</span><br><span class="line">	&#125;</span><br><span class="line">	revToBytes(idxRev, ibytes)</span><br><span class="line"></span><br><span class="line">	kv := mvccpb.KeyValue&#123;</span><br><span class="line">		Key:            key,</span><br><span class="line">		Value:          value,</span><br><span class="line">		CreateRevision: c,</span><br><span class="line">		ModRevision:    rev,</span><br><span class="line">		Version:        ver + <span class="number">1</span>,</span><br><span class="line">		Lease:          <span class="type">int64</span>(leaseID),</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	d, err := kv.Marshal()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		tw.storeTxnRead.s.lg.Fatal(</span><br><span class="line">			<span class="string">&quot;failed to marshal mvccpb.KeyValue&quot;</span>,</span><br><span class="line">			zap.Error(err),</span><br><span class="line">		)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	tw.trace.Step(<span class="string">&quot;marshal mvccpb.KeyValue&quot;</span>)</span><br><span class="line">	tw.tx.UnsafeSeqPut(buckets.Key, ibytes, d)</span><br><span class="line">	tw.s.kvindex.Put(key, idxRev)</span><br><span class="line">	tw.changes = <span class="built_in">append</span>(tw.changes, kv)</span><br><span class="line">	tw.trace.Step(<span class="string">&quot;store kv pair into bolt db&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> oldLease != lease.NoLease &#123;</span><br><span class="line">		<span class="keyword">if</span> tw.s.le == <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="built_in">panic</span>(<span class="string">&quot;no lessor to detach lease&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		err = tw.s.le.Detach(oldLease, []lease.LeaseItem&#123;&#123;Key: <span class="type">string</span>(key)&#125;&#125;)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			tw.storeTxnRead.s.lg.Error(</span><br><span class="line">				<span class="string">&quot;failed to detach old lease from a key&quot;</span>,</span><br><span class="line">				zap.Error(err),</span><br><span class="line">			)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> leaseID != lease.NoLease &#123;</span><br><span class="line">		<span class="keyword">if</span> tw.s.le == <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="built_in">panic</span>(<span class="string">&quot;no lessor to attach lease&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		err = tw.s.le.Attach(leaseID, []lease.LeaseItem&#123;&#123;Key: <span class="type">string</span>(key)&#125;&#125;)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="built_in">panic</span>(<span class="string">&quot;unexpected error from lease Attach&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	tw.trace.Step(<span class="string">&quot;attach lease to kv pair&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives">archives</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#KV"><span class="toc-number">1.</span> <span class="toc-text">KV</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#View-%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.0.1.</span> <span class="toc-text">View 设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Txn"><span class="toc-number">1.0.2.</span> <span class="toc-text">Txn</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#storeTxnRead"><span class="toc-number">1.0.2.1.</span> <span class="toc-text">storeTxnRead</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#storeTxnWrite"><span class="toc-number">1.0.2.2.</span> <span class="toc-text">storeTxnWrite</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#lock"><span class="toc-number">1.0.2.3.</span> <span class="toc-text">lock</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Revision"><span class="toc-number">1.0.3.</span> <span class="toc-text">Revision</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Store-%E4%B8%AD%E7%9A%84-Revision-%E7%AE%A1%E7%90%86"><span class="toc-number">1.0.3.1.</span> <span class="toc-text">Store 中的 Revision 管理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AF%BB%E4%BA%8B%E5%8A%A1%E4%B8%AD%E7%9A%84-Revision"><span class="toc-number">1.0.3.1.1.</span> <span class="toc-text">读事务中的 Revision</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%86%99%E4%BA%8B%E5%8A%A1%E4%B8%AD%E7%9A%84-Revision"><span class="toc-number">1.0.3.1.2.</span> <span class="toc-text">写事务中的 Revision</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#KeyIndex"><span class="toc-number">1.0.4.</span> <span class="toc-text">KeyIndex</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Generation"><span class="toc-number">1.0.4.1.</span> <span class="toc-text">Generation</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#put"><span class="toc-number">1.0.4.2.</span> <span class="toc-text">put</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#tombstone"><span class="toc-number">1.0.4.3.</span> <span class="toc-text">tombstone</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#get"><span class="toc-number">1.0.4.4.</span> <span class="toc-text">get</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#findGeneration"><span class="toc-number">1.0.4.4.1.</span> <span class="toc-text">findGeneration</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#walk"><span class="toc-number">1.0.4.4.2.</span> <span class="toc-text">walk</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mvccpb-KeyValue"><span class="toc-number">1.0.5.</span> <span class="toc-text">mvccpb.KeyValue</span></a></li></ol></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://szza.github.io/2024/08/19/ETCD/2_kv/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://szza.github.io/2024/08/19/ETCD/2_kv/&text=剖析 ETCD.kvstore"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://szza.github.io/2024/08/19/ETCD/2_kv/&title=剖析 ETCD.kvstore"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://szza.github.io/2024/08/19/ETCD/2_kv/&is_video=false&description=剖析 ETCD.kvstore"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=剖析 ETCD.kvstore&body=Check out this article: https://szza.github.io/2024/08/19/ETCD/2_kv/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://szza.github.io/2024/08/19/ETCD/2_kv/&title=剖析 ETCD.kvstore"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://szza.github.io/2024/08/19/ETCD/2_kv/&title=剖析 ETCD.kvstore"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://szza.github.io/2024/08/19/ETCD/2_kv/&title=剖析 ETCD.kvstore"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://szza.github.io/2024/08/19/ETCD/2_kv/&title=剖析 ETCD.kvstore"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://szza.github.io/2024/08/19/ETCD/2_kv/&name=剖析 ETCD.kvstore&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://szza.github.io/2024/08/19/ETCD/2_kv/&t=剖析 ETCD.kvstore"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2021-2026
    fibonaccii
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives">archives</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

    <script async src="https://www.googletagmanager.com/gtag/js?id=szza"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'szza');
    </script>

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->


</body>
</html>
